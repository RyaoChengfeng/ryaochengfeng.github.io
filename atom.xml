<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Ryao&#39;s Blog</title>
  
  <subtitle>——I DWELL IN POSSBILITY——</subtitle>
  <link href="https://blog.ryaoknw.site/atom.xml" rel="self"/>
  
  <link href="https://blog.ryaoknw.site/"/>
  <updated>2023-07-30T06:44:50.220Z</updated>
  <id>https://blog.ryaoknw.site/</id>
  
  <author>
    <name>Ryao</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2023年4月追番锐评</title>
    <link href="https://blog.ryaoknw.site/2023/7/5f5cff851208/"/>
    <id>https://blog.ryaoknw.site/2023/7/5f5cff851208/</id>
    <published>2023-07-30T06:16:50.000Z</published>
    <updated>2023-07-30T06:44:50.220Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>不是那么棒的四月，每周指望着U149活着。</p><p>实在没什么动力也没什么时间写，想着憋出一篇U149 ep11的分析，于是先顺手把4月的流水账记下。</p><h2 id="2023年4月"><a href="#2023年4月" class="headerlink" title="2023年4月"></a>2023年4月</h2><h3 id="天国大魔境"><a href="#天国大魔境" class="headerlink" title="天国大魔境"></a>天国大魔境</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730141110.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730141110.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>star：8</p><p>或许我应该写一个长篇分析，因为它确实做的很好，但是这不是原创动画，我并没有看过原作，本季也并没有触及主线，实在不好写。动画中有非常多很有意思的设计（比如相对独立的五十岚海负责的第十话中女尊男卑的社会）</p><p>这是整个四月唯一真正精彩真正可以360度来吹的作品。</p><p>末世双线叙事一眼反乌托邦，一看就是要讲严肃叙事的动画。动画第一话就能看出制作水准，真流斩子所有打戏镜头都非常多样，作画质量极高，张数巨多。而在灾难中也不乏两人的日常场景，而且镜头非常多样化（与某霸权高下立判），日常的对话部分非常流畅和沉浸。（<strong>神中神的the异世界轻改<del>(学神限定)</del>也是通过这样的方式来为观众带来沉浸感，这也是它为何获得如此多的好评的重要原因之一</strong>）</p><p>第12话神中神中神。前面一系列的环境和真流的神态描写为斩子的遭遇做足了暗示。结尾部分行云流水的镜头语言，无限高的天花板，成熟到裂开的果实，一个人吃不完的热汤，将燃尽熄灭的蜡烛，手伸向外面的天空，一系列流畅的意识流镜头调动着观众的思考，也将观众的注意力从雷普这种会引起生理厌恶的场景本身引向<strong>对雷普展示的含义的思考</strong>，即自我认知的哲学命题<del>（又是经典的「我是谁，我从哪里来，我要到哪里去」）</del>。</p><p>动画从一开始就在为这个命题的引出做铺垫，各种细节都在给观众突破“差别”的暗示，比如学院中没有男女的差别；灾难后的新生人类的外貌都是圆脸，而旧人类都是有明显差异化的面部特征等等，从各个角度都在为观众淡化「区别」。而学院中更是没有外面的社会中的「区别」，比如同性恋、没有“性”、“男女”、“生育”的概念，美美姬的兽耳，学生们的超能力等等。我是男人，我叫斩子，我原本不是长这样的。当人与人之间的这些差别都在“新世界”中消失时，当你的精神寄托在了另一个肉体中时，当灾难摧毁了社会中的身份和角色，我们是否应该像故事中的旧人类一样去重建它，还是应该像新人类一样以其他的方式活下去？<strong>当身份认同和角色认同不再，那么该如何回答「我是谁」这个问题？</strong></p><p>本季主线基本没有触及，草草收尾了，雷普这种应当作为关键冲突点的展开居然在这里毫无意义，我还期待着斩子会在后续对自己的认知变化作出怎样的反应，没想到真流的一句类似「你就是你」的话就把话题结束了，而漫画也没有完结，我无法得知后续。</p><p>抛开主线不谈，第8话与第12、13话的联系非常出色。美美姬（<strong>福圆美里配音！</strong>）和白的故事在第13话最后的那一幕，将第8话中埋下的伏笔与第12、第13话中的从前故事巧妙地呼应和回收，给我带来了极大的震撼。</p><p>遗憾的是最终得知两个世界不是一个时间线，这种展开很常见很好写，因此对我来说有点无聊。</p><h3 id="我推的孩子"><a href="#我推的孩子" class="headerlink" title="我推的孩子"></a>我推的孩子</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730141157.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730141157.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：6.5</p><p>第一话的中后段高质量以及最后的展开让我对这个动画有了错误的期待，想看后续如何面对爱死去这件事，主角如何理解爱，如何在这个过程中与自己和解，但实际上只是借着这个噱头展开校园漫画，实在是没劲。</p><p>动画工坊在第一话试图证明自己做萌系以外的动画的实力，但没想到貌似这就是上限了。</p><p>在正式展开本篇剧情时便转为了厕纸演出，同时，我所期待的一些关键性的场景并没有漫画中的表现力，包括拯救赤音，拉memu入伙，以及最终的帽子一指。动画中没有进行修改，而是直接采用漫画中的画面顺序进行呈现，而由于画面的连续性，这些转折点失去了原本在漫画中带来的震撼效果。</p><h3 id="鬼灭之刃-刀匠村篇"><a href="#鬼灭之刃-刀匠村篇" class="headerlink" title="鬼灭之刃 刀匠村篇"></a>鬼灭之刃 刀匠村篇</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730141424.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730141424.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：5</p><p>炭治郎大帝将要征服二次元！</p><p><strong>!!!前方输出高能，请鬼灭PSTD患者自觉跳过!!!</strong></p><p>鬼灭从来没有演出，镜头极其单调，叙事只知道怼脸，让角色念出一大串的台词，然后请作画们画一段长镜头，于是经费就燃烧了，你也不知道经费烧没烧，但观众说燃烧了就是燃烧了，爆卖3亿还不好？环大陆好评如潮！<del>（我直言期待原神动画）</del>。</p><p>我不知道如何才能把动画做得这么无聊的，ep7看boss登场，然后炭治郎大帝站桩十分钟一堆慢动作来塞心理描写、神态描写，然后把内容念完了开始嘴炮论战。我想知道监督是专业的吗？还是哪个大专捞来的？永远不知道镜头为何物。</p><p>最后我鼓起勇气看看被吹的弥豆子回，炭治郎陷入拯救自己妹妹和杀鬼的艰难抉择中，这种展开一般为表现角色内核的开展点，为后续剧情深入展现角色形象做剧情上的分割点。此时的决策非常值得观众的思考，于是炭治郎选择了杀鬼，并为妹妹的生命感到悲伤，然后，<strong>弥豆子并没有发生什么，从此不畏惧阳光了</strong>。<del>天哪，太厉害了！</del>，但由于原作本身不怎么样，这里我也不细喷了，只能说我写不出这样的东西hhhh。但我也确实没什么文笔，免不了被人叫喊“<strong>你行你上啊</strong>”。</p><p>想了想，不如让我来做下一季的监督吧，我也会做。鬼灭动画只需要1.找花江夏树来念台词说书 2.找梶浦由記老师来编曲 3.需要经费燃烧的时候找阿部望先生来拉刀光。而这大概就能呈现鬼灭动画足够的体验。</p><p><del>好了，爽快。</del></p><h3 id="无神世界的神明活动"><a href="#无神世界的神明活动" class="headerlink" title="无神世界的神明活动"></a>无神世界的神明活动</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730141436.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730141436.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：5</p><p>用最低的经费做最有想象力的演出！rpgmaker做战斗画面, 简陋页游3d做怪物登场，通过大头演艺，角色怼脸配上低质特效背景来表现燃，还有最经典直接上现实套滤镜画面。稻叶友纪用奇思妙想做出了我从未见过的创意！</p><p><strong>淳皇鬼后放飞自我，直接让广大黑子原地道歉！从不屑到理解，从谩骂到感谢！</strong></p><blockquote><p>你们就当我在发病吧，但是我是真的很喜欢<br>人的观点真的是会随着经历过的事而改变，我现在都还记得当初看完动画时的感受<br>淳皇的调教和鬼后的咆哮真的越听越喜欢，不需要讨论演技，不需要反转<br>所有的答案都在动画里面了<br>前面忘了，后面忘了，但是。<br>世界は残酷だ それでも君を愛すよ<br>なにを犠牲にしても それでも君を守るよ<br>能听到淳皇鬼后的配音作品的是一种幸运，也需要莫大的勇气<br>你们可以说我格局太小，有小礼而无大义，毕竟我本来就没有什么家国情怀，兼济天下的情操，我也不想争论对错的问题<br>动画中我真正在乎的，也确实就那么几个cv</p></blockquote><p>虽然我很喜欢，但实在没法用这种兴奋打上一个高分，因为动画本身不值得一看，我看下去的动力是动画以外的东西。</p><h3 id="机动战士高达-水星的魔女-Season2"><a href="#机动战士高达-水星的魔女-Season2" class="headerlink" title="机动战士高达 水星的魔女 Season2"></a>机动战士高达 水星的魔女 Season2</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730141503.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730141503.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>star：5</p><p>太经典的烂尾模式。</p><p>在米米要和母亲联手时我就觉得收不住了，只能能看到现在纯属说第一季ep11的百合演出把我拿下了。</p><p>本身故事内容也没有仔细讨论的必要了，<del>难道我要现在还去梳理莉可丽丝的剧情细节吗？</del></p><h3 id="魔法少女毁灭者"><a href="#魔法少女毁灭者" class="headerlink" title="魔法少女毁灭者"></a>魔法少女毁灭者</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730141520.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730141520.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：3</p><p>开播前非常期待，以及第一话op和ed后依旧非常期待。</p><p>但是它实际上只是制作组的自嗨。</p><p>魔法少女毁灭者最后毁灭了什么？没有毁灭什么，所以它在讽刺吗？或许有这方面的内容，只是我水平不够，看得不仔细，总结不出来。堆砌一堆杂乱的符号却没有任何实际含义，它甚至碰瓷不了秋原叶女仆战争。魔法少女毁灭了我的脑子，或许二创可以有很多有趣的内容，但可惜的是这个动画没有热度。</p><h3 id="世界巨星"><a href="#世界巨星" class="headerlink" title="世界巨星"></a>世界巨星</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730141537.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730141537.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><del>stars：5</del></p><p>因为看了pv所以去看了动画，但实在没看完。</p><p>含歌量90%，但无法成为少女歌剧代餐</p><h3 id="偶像大师-灰姑娘女孩-U149"><a href="#偶像大师-灰姑娘女孩-U149" class="headerlink" title="偶像大师 灰姑娘女孩 U149"></a>偶像大师 灰姑娘女孩 U149</h3><p><img src="http://cdn.qiniu.ryaoknw.site/picgo/20230730144438.png" class="lazyload" data-srcset="http://cdn.qiniu.ryaoknw.site/picgo/20230730144438.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars: 8</p><p>年轻人的第一部偶像大师！学神的含金量！</p><p>U149 EP11分析正在日程中，尽请期待喵！</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;不是那么棒的四月，每周指望着U149活着。&lt;/p&gt;
&lt;p&gt;实在没什么动力也没什么时间写，想着憋出一篇U149 ep11的分析，于是先顺手把4</summary>
      
    
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/categories/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>彻底禁用独立显卡</title>
    <link href="https://blog.ryaoknw.site/2023/5/522336ae5c77/"/>
    <id>https://blog.ryaoknw.site/2023/5/522336ae5c77/</id>
    <published>2023-05-02T07:02:25.000Z</published>
    <updated>2023-05-02T07:02:47.457Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Manjaro-彻底禁用独立显卡"><a href="#Manjaro-彻底禁用独立显卡" class="headerlink" title="[Manjaro]彻底禁用独立显卡"></a>[Manjaro]彻底禁用独立显卡</h1><h2 id="已知的问题"><a href="#已知的问题" class="headerlink" title="已知的问题"></a>已知的问题</h2><p>我在使用chrome时应用启动非常迅速，但图形界面却出现的非常慢，准确来说，是一个全屏透明占用了整个屏幕，把它最小化（通过点击应用图标等方法）在屏幕上拖动会有重影，重影是buffer未清除，应该是图形（GPU）渲染的问题。</p><p>然而，在firefox上却完全没有这个问题。</p><p>我难以准确描述我遇到的问题，在google上搜不到任何和我相似的情况，只有类似”启动慢“的问题，我尝试关闭了所有硬件加速相关的只要用到GPU的功能，还是无法解决问题。</p><p>尝试换了edge,但依旧是同样的效果，又尝试换了vivaldi, 也是同样的问题，区别就是vivaldi不是透明的而是白屏窗口，可能只是启动实现上的不同。共同点在于，它们都是基于chromium的，于是我又尝试使用chromium，但chromium却没有这个问题，我实在不知道如何排查，我尝试使用debug日志的模式启动chrome、edge，一大堆的日志中除了一些不太重要的warning之外，没有什么不正常的信息。</p><p>chrome启动慢实在影响了我的操作体验。。。而chromium被阉割了同步功能，以及现在的版本下在linux中输入存在问题（fcitx），不过在当前的chrome版本中已经修复，我还是觉得我应该使用chrome。</p><p>事情在我从kde换到awesome wm后有了进展，在某一次开机后我在awesome wm下的chrome彻底打不开了，edge等也是，我</p><p>意识到这样的不同表现来源于我的启动配置，于是我认为应该是我坏掉的独显在暗中作怪。</p><h2 id="彻底禁用独显"><a href="#彻底禁用独显" class="headerlink" title="彻底禁用独显"></a>彻底禁用独显</h2><h3 id="尝试"><a href="#尝试" class="headerlink" title="尝试"></a>尝试</h3><p>manjaro并没有提供类似设备管理器一样的可以直接把显卡禁用的功能，我也没有找到。</p><p>我在网上找到的选择使用集成显卡的方案是通过bumblebee来实现的。</p><p>对于ubuntu,可以使用<code>prime-select</code>命令来选择显卡，在manjaro（arch系）下，可以通过</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mhwd -a pci nonfree 0300</span><br></pre></td></tr></table></figure><p>来安装推荐的显卡驱动，一般双显卡就是<code>video-hybrid-intel-nvidia-prime</code>，但并没有<code>prime-select</code>，arch系采用了不同的方法来处理NVIDIA Optimus技术，可以使用Bumblebee作为Optimus支持的默认解决方案。</p><p>在论坛中得知应该使用bbswitch来代替Bumblebee来做这件事比较好，Bumblebee已经过时了。</p><p>于是尝试一系列操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo pacman -S bbswitch</span><br><span class="line"></span><br><span class="line">sudo nvim /etc/modprobe.d/bbswitch.conf</span><br><span class="line">options bbswitch load_state=0 unload_state=1</span><br><span class="line"></span><br><span class="line">sudo modprobe bbswitch</span><br><span class="line">sudo <span class="built_in">tee</span> /proc/acpi/bbswitch &lt;&lt;&lt; <span class="string">OFF</span></span><br><span class="line"><span class="string">cat /proc/acpi/bbswitch</span></span><br></pre></td></tr></table></figure><p>按道理应该显示OFF,但我这里一直显示ON。得知大概是由于程序占用了nvidia,导致无法禁用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo fuser -v /dev/nvidia*</span><br><span class="line"></span><br><span class="line">用户     进程号 权限   命令</span><br><span class="line">/dev/nvidiactl:      root      298314 F.... Xorg</span><br></pre></td></tr></table></figure><p>尝试设置xorg使用集显启动。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> /etc/X11/xorg.conf /etc/X11/xorg.conf.backup</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">sudo nvim /etc/X11/xorg.conf</span><br><span class="line"></span><br><span class="line">Section <span class="string">&quot;ServerLayout&quot;</span></span><br><span class="line">    Identifier <span class="string">&quot;layout&quot;</span></span><br><span class="line">    Screen 0 <span class="string">&quot;intel&quot;</span></span><br><span class="line">    Inactive <span class="string">&quot;nvidia&quot;</span></span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section <span class="string">&quot;Device&quot;</span></span><br><span class="line">    Identifier <span class="string">&quot;intel&quot;</span></span><br><span class="line">    Driver <span class="string">&quot;modesetting&quot;</span></span><br><span class="line">    BusID <span class="string">&quot;PCI:0:2:0&quot;</span></span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section <span class="string">&quot;Screen&quot;</span></span><br><span class="line">    Identifier <span class="string">&quot;intel&quot;</span></span><br><span class="line">    Device <span class="string">&quot;intel&quot;</span></span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section <span class="string">&quot;Device&quot;</span></span><br><span class="line">    Identifier <span class="string">&quot;nvidia&quot;</span></span><br><span class="line">    Driver <span class="string">&quot;nvidia&quot;</span></span><br><span class="line">    BusID <span class="string">&quot;PCI:1:0:0&quot;</span></span><br><span class="line">    Option <span class="string">&quot;ConstrainCursor&quot;</span> <span class="string">&quot;off&quot;</span></span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section <span class="string">&quot;Screen&quot;</span></span><br><span class="line">    Identifier <span class="string">&quot;nvidia&quot;</span></span><br><span class="line">    Device <span class="string">&quot;nvidia&quot;</span></span><br><span class="line">    Option <span class="string">&quot;AllowEmptyInitialConfiguration&quot;</span> <span class="string">&quot;on&quot;</span></span><br><span class="line">    Option <span class="string">&quot;IgnoreDisplayDevices&quot;</span> <span class="string">&quot;CRT&quot;</span></span><br><span class="line">EndSection</span><br></pre></td></tr></table></figure><p>然后重启，依旧无效。</p><p>我无法得知原因，但毕竟是独显坏了，奇奇怪怪的事情确实会发生hhh</p><h3 id="有效的做法"><a href="#有效的做法" class="headerlink" title="有效的做法"></a>有效的做法</h3><p>既然它已经坏了，那么我就只需要把它彻底禁用就好了</p><p>先安装intel集显的驱动，保证我至少有一个能用的驱动可以打开图形界面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mhwd -i pci video-linux</span><br></pre></td></tr></table></figure><p>然后阻止nvidia模块加载</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo nvim /etc/modprobe.d/blacklist-nvidia.conf</span><br><span class="line"></span><br><span class="line">blacklist nvidia</span><br><span class="line">blacklist nvidia-drm</span><br><span class="line">blacklist nvidia-modeset</span><br><span class="line">blacklist nvidia-uvm</span><br></pre></td></tr></table></figure><p>卸载nvidia相关的驱动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mhwd -r pci video-nvidia</span><br><span class="line">sudo mhwd -r pci video-hybrid-intel-nvidia-prime</span><br></pre></td></tr></table></figure><p>以及残留配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">rm</span> /etc/X11/xorg.conf</span><br></pre></td></tr></table></figure><p>reboot,然后飞快的启动了chrome,真棒。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Manjaro-彻底禁用独立显卡&quot;&gt;&lt;a href=&quot;#Manjaro-彻底禁用独立显卡&quot; class=&quot;headerlink&quot; title=&quot;[Manjaro]彻底禁用独立显卡&quot;&gt;&lt;/a&gt;[Manjaro]彻底禁用独立显卡&lt;/h1&gt;&lt;h2 id=&quot;已知的问题&quot;&gt;</summary>
      
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>TOTP和2FA实现</title>
    <link href="https://blog.ryaoknw.site/2023/4/0542e4f627a8/"/>
    <id>https://blog.ryaoknw.site/2023/4/0542e4f627a8/</id>
    <published>2023-04-21T15:17:07.000Z</published>
    <updated>2023-04-21T19:27:27.649Z</updated>
    
    <content type="html"><![CDATA[<h1 id="TOTP和2FA实现"><a href="#TOTP和2FA实现" class="headerlink" title="TOTP和2FA实现"></a>TOTP和2FA实现</h1><p>很多网站的登陆系统都会提供一个开启2FA认证的安全选项，一些对安全性要求较高的还会要求必须使用2FA。</p><p>2FA是啥？二步验证（双因素验证，Two-factor authentication, 2FA）。在检查口令之外，还检查一个<strong>一次性认证码</strong>。典型的二步认证手段包括有：</p><ul><li>短信&#x2F;邮箱验证码</li><li>银行发的密码器</li><li>基于 HOTP&#x2F;TOTP 协议的应用程序</li></ul><p>2FA 中使用的是一次性密码（One Time Password，OTP），也被称作动态密码。一般 OTP 有两种策略：HOTP ( HMAC-based One Time Password) 和 TOTP ( Time-based One-time Password)</p><h2 id="TOTP工作流程"><a href="#TOTP工作流程" class="headerlink" title="TOTP工作流程"></a>TOTP工作流程</h2><p>如果用户选择打开 2FA，网站会生成一个预共享的 secret key。后续的验证码都是从这个 secret key 派生出来的，这个 secret key 应该严格保密，只有服务器和客户应当知晓。</p><p>用户登录时，首先完成传统的第一步认证，然后提供 6 位数字认证码（这个认证码由 secret key 与当前时间计算得出，每 30s 变一次），若与服务器的计算结果一致，则完成认证。</p><p>（由于Google Authenticator界面下我截不了图，偷一下应用市场的）</p><img src="https://cdn.ryaoknw.site/picgo/unnamed.webp" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/unnamed.webp" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="zoom:50%;" /><h2 id="TOTP计算原理"><a href="#TOTP计算原理" class="headerlink" title="TOTP计算原理"></a>TOTP计算原理</h2><p>参考<a href="https://datatracker.ietf.org/doc/html/rfc4226">RFC4226</a></p><h3 id="HOTP"><a href="#HOTP" class="headerlink" title="HOTP"></a>HOTP</h3><p>HMAC-based One Time Password，由 RFC 4226 定义。一次性验证码是secret key $K$与计数器$C$的函数，其中 HMAC 过程使用的哈希函数$H$默认是 SHA-1。<br>$$<br>HOTP(K,C) &#x3D; Truncate(HMAC_{H}(K,C))<br>$$<br>HMAC 算法得出的值位数比较多，不方便用户输入，因此需要截断（Truncate）成为一组不太长十进制数。要用六位数，就是$HOTP(K,C) \mod10^6$</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/pyauth/pyotp</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">generate_otp</span>(<span class="params">self, <span class="built_in">input</span>: <span class="built_in">int</span></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">       <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">       :param input: the HMAC counter value to use as the OTP input.</span></span><br><span class="line"><span class="string">           Usually either the counter, or the computed integer based on the Unix timestamp</span></span><br><span class="line"><span class="string">       &quot;&quot;&quot;</span></span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">input</span> &lt; <span class="number">0</span>:</span><br><span class="line">           <span class="keyword">raise</span> ValueError(<span class="string">&quot;input must be positive integer&quot;</span>)</span><br><span class="line">       hasher = hmac.new(self.byte_secret(), self.int_to_bytestring(<span class="built_in">input</span>), self.digest)</span><br><span class="line">       hmac_hash = <span class="built_in">bytearray</span>(hasher.digest())</span><br><span class="line">       <span class="comment"># 从160位的 SHA-1 结果中，提取出31位</span></span><br><span class="line">       offset = hmac_hash[-<span class="number">1</span>] &amp; <span class="number">0xF</span></span><br><span class="line">       code = (</span><br><span class="line">           (hmac_hash[offset] &amp; <span class="number">0x7F</span>) &lt;&lt; <span class="number">24</span></span><br><span class="line">           | (hmac_hash[offset + <span class="number">1</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">16</span></span><br><span class="line">           | (hmac_hash[offset + <span class="number">2</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">8</span></span><br><span class="line">           | (hmac_hash[offset + <span class="number">3</span>] &amp; <span class="number">0xFF</span>)</span><br><span class="line">       )</span><br><span class="line">       <span class="comment"># 得到digits位的一次性密码</span></span><br><span class="line">       str_code = <span class="built_in">str</span>(<span class="number">10_000_000_000</span> + (code % <span class="number">10</span>**self.digits))</span><br><span class="line">       <span class="keyword">return</span> str_code[-self.digits :]</span><br></pre></td></tr></table></figure><p><strong>工作流程</strong></p><ol><li><p>客户端和服务器各有一个计数器C，并且事先将计数值同步。</p></li><li><p>客户端用K,C计算一次性密码。</p></li><li><p>计算完成之后客户端计数器C计数值加1，验证通过，服务器端将计数值C加1。</p></li></ol><p>如果验证失败或者客户端不小心多进行了一次生成密码操作，那么服务器和客户端之间的计数器C将不再同步，因此需要有一个重新同步（Resynchronization）的机制：</p><p><strong>Resynchronization</strong></p><p>定义一个向前查找的参数s，服务器可以重新计算接下来的s个HOTP值，并将它们与接收到的HOTP客户端进行比较</p><p>计数器同步只需服务器计算下一个HOTP值并确定是否匹配。系统可以要求用户发送一系列（例如C&#x3D;2, 3）的HOTP值以进行重新同步，因为伪造连续的HOTP值比猜测单个HOTP值更难。</p><h3 id="TOTP"><a href="#TOTP" class="headerlink" title="TOTP"></a>TOTP</h3><p>HOTP 与 TOTP 的区别在于：HOTP 是用一个整数 counter 来计算一次性验证码，而 TOTP 是基于当前时间来计算。显然，实现了前者就能实现后者——只需要把当前时间除以 $T$ 向下取整，就能得到一个整数 counter 送进 HOTP 协议里。</p><p>Google Authenticator把$T$设置为了30s.</p><p>由于网络延时，用户输入延迟等因素，可能当服务器端接收到一次性密码时，T的数值已经改变，这样就会导致服务器计算的一次性密码值与用户输入的不同，验证失败。这可以通过同样的思路来解决，服务器计算当前时间片以及前面的n个时间片内的一次性密码值，只要其中有一个与用户输入的密码相同，则验证通过。当然，n不能太大，否则会降低安全性</p><h2 id="服务实现"><a href="#服务实现" class="headerlink" title="服务实现"></a>服务实现</h2><ol><li>服务端随机生成一个secret key，并且把这个密钥保存在数据库中。</li><li>在页面上显示一个二维码，内容是一个URI地址（<code>otpauth://totp/GitHub:LarryLuTW?secret=&#123;secret_key&#125;&amp;issuer=GitHub</code>）</li><li>客户端用某个应用扫描二维码，把secret key保存。</li><li>客户端每30秒使用secret key和时间戳生成一个6位数字的一次性密码</li><li>用户输入这个一次性密码，然后服务端进行验证</li></ol><p><strong>recovery code</strong></p><p>服务端有时会提供一个或一组recovery code，用于在你把手机砸了或者其他故障后能够登陆账户。</p><p>我们可以做一个简单的实现：</p><ul><li><p>随便用某些方法一组唯一且不能伪造的recovery code，将它们存在数据库，并对应用户和用户的secret key</p></li><li><p>用户输入recovery code后，验证recovery code是否对应该用户，验证成功后销毁recovery code和secret key，取消用户的2FA并给用户态（或者把用户跳转到setting并引导重新设置）</p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;TOTP和2FA实现&quot;&gt;&lt;a href=&quot;#TOTP和2FA实现&quot; class=&quot;headerlink&quot; title=&quot;TOTP和2FA实现&quot;&gt;&lt;/a&gt;TOTP和2FA实现&lt;/h1&gt;&lt;p&gt;很多网站的登陆系统都会提供一个开启2FA认证的安全选项，一些对安全性要求较高</summary>
      
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>媒体资源管理方案</title>
    <link href="https://blog.ryaoknw.site/2023/4/6eb8dc2e76dc/"/>
    <id>https://blog.ryaoknw.site/2023/4/6eb8dc2e76dc/</id>
    <published>2023-04-16T19:18:10.000Z</published>
    <updated>2023-04-17T22:59:59.465Z</updated>
    
    <content type="html"><![CDATA[<h1 id="媒体资源管理方案"><a href="#媒体资源管理方案" class="headerlink" title="媒体资源管理方案"></a>媒体资源管理方案</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>Navidrome实在不好用</strong>，选择了一些媒体管理的工具。</p><p>plex：一键安装的媒体管理工具，安装自动将服务注册到systemd。有免费版，不开源，试了一下还行，但是我不太想用，<del>因为不折腾</del>，因为我不喜欢。</p><p>找到了开源的jellyfin，也部署了，太丑，发现了它的衍生商业版emby，看着舒服多了，决定用它</p><h2 id="emby"><a href="#emby" class="headerlink" title="emby"></a>emby</h2><p>emby有免费版，阉割了很多功能，甚至不能更换主题</p><p>当然，我选择使用开心版！</p><p>由于docker隔离的原因，导入媒体库不是很方便，得先挂进去</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">emby:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">lovechen/embyserver:beta</span> <span class="comment"># 建议使用beta,因为新版本功能多多</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">emby</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8096</span><span class="string">:8096</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8920</span><span class="string">:8920</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1900</span><span class="string">:1900/udp</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">7359</span><span class="string">:7359/udp</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">UID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GID=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">GIDLIST=1000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./emby:/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/youmedia:/share/media</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure><p>再导入我的媒体库</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230417032751533.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230417032751533.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230417032751533"></p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230418064258491.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230418064258491.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230418064258491"></p><p>看上去非常棒。</p><h2 id="syncthing-git-lfs"><a href="#syncthing-git-lfs" class="headerlink" title="syncthing+git lfs"></a>syncthing+git lfs</h2><p>用于同步三端的文件，但是手机上的<strong>syncthing</strong>，至少鸿蒙上，如果熄屏或者切屏就会断连，不过也无所谓。</p><p>我需要记录音乐文件的更改，所以使用<strong>git lfs</strong>来做版本管理</p><blockquote><p><strong>git lfs服务器只给1g的流量，所以别用了</strong></p></blockquote><p>首次添加时，如果一次性git add，然后push上去，会文件过大而失败，需要分批来做这件事</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要提交的文件夹列表</span></span><br><span class="line">folders=(<span class="string">&quot;Music&quot;</span>)</span><br><span class="line"><span class="comment"># 每次提交的文件数</span></span><br><span class="line">batch_size=10</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> folder <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;folders[@]&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$folder</span>&quot;</span></span><br><span class="line">    files=(*)</span><br><span class="line">    num_files=<span class="variable">$&#123;#files[@]&#125;</span></span><br><span class="line">    <span class="keyword">for</span> ((i=0; i&lt;num_files; i+=batch_size))</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        batch_files=(<span class="string">&quot;<span class="variable">$&#123;files[@]:i:batch_size&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;batch_files[@]&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            git add <span class="string">&quot;<span class="variable">$file</span>&quot;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        git commit -m <span class="string">&quot;add files&quot;</span></span><br><span class="line">        git push origin master</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    <span class="built_in">cd</span> ..</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>自己写了一个<a href="https://github.com/RyaoChengfeng/MusicInfoExtractor">MusicInfoExtractor</a>用于解析目录下的音乐文件，然后输出到json，再只提交元信息就好了。</p><h2 id="音乐刮削"><a href="#音乐刮削" class="headerlink" title="音乐刮削"></a>音乐刮削</h2><p>音乐的封面和标题等信息非常重要，而这些都在音乐的元信息里，在不知多久以前在某些神秘的地方下载的无损文件它很可能缺少这些信息，甚至文件名也是一串魔法字符串，这非常的不妙。</p><p>最佳的是使用网易云和qq的智能识别来填充音乐的tag，但是我没有找到任何一个实现了这个功能的工具</p><p>主流的方案是用<strong>MusicBrainz Picard</strong>或者<strong>mp3tag</strong>，但是这一堆galgame里和动画纯音乐专辑里的冷门音乐，实在是不好用。</p><p>找到了musictag：<a href="https://www.cnblogs.com/vinlxc/p/11347744.html">https://www.cnblogs.com/vinlxc/p/11347744.html</a> ，虽然貌似没有开源，但是支持了网易云和qq音乐等匹配，可惜只能在windows上用它</p><p><img src="https://cdn.ryaoknw.site/picgo/QQ20200831224848.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/QQ20200831224848.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><h2 id="番剧"><a href="#番剧" class="headerlink" title="番剧"></a>番剧</h2><p>用<a href="https://github.com/EstrellaXD/Auto_Bangumi">Auto_Bangumi</a>，再加载到emby</p><p>如果想要其他的电影电视剧，使用<a href="https://github.com/Jackett/Jackett">Jackett</a></p><h2 id="音声"><a href="#音声" class="headerlink" title="音声"></a>音声</h2><p><del>音声是好东西</del>，但我不是重度依赖者，所以不太想搭，毕竟真的吃硬盘空间</p><p>如果需要，可以使用kikoeru，十分轻量的音乐流媒体服务器，<psw>最伟大的同**声网站www.XXXX.one正是使用了它</psw></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;媒体资源管理方案&quot;&gt;&lt;a href=&quot;#媒体资源管理方案&quot; class=&quot;headerlink&quot; title=&quot;媒体资源管理方案&quot;&gt;&lt;/a&gt;媒体资源管理方案&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; titl</summary>
      
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>frp配置内网穿透暴露kubernetes集群</title>
    <link href="https://blog.ryaoknw.site/2023/4/82c24833ebd8/"/>
    <id>https://blog.ryaoknw.site/2023/4/82c24833ebd8/</id>
    <published>2023-04-16T19:15:54.000Z</published>
    <updated>2023-04-16T20:13:17.713Z</updated>
    
    <content type="html"><![CDATA[<h1 id="frp配置内网穿透暴露kubernetes集群"><a href="#frp配置内网穿透暴露kubernetes集群" class="headerlink" title="frp配置内网穿透暴露kubernetes集群"></a>frp配置内网穿透暴露kubernetes集群</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>1核2G的服务器太垃圾了，搭了kubernetes，但是各种组件都吃性能，研究了一下内网穿透，尝试让电脑在开机的时候可以用公网ip访问服务，这样就完全没有性能瓶颈了</p><p>折腾了很久。。。对于rancher，helm装完有一大大大大堆的资源被安装下来了，也不知道它的流量是怎么走的，会重定向一次host，导致循环重定向，排查了半天，最终放弃挣扎了，但是正常的服务是可以用的，同时放弃了ingress-nginx,换用了apisix，这一步也折腾了很久</p><h2 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h2><p>server和client都要有</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/fatedier/frp/releases/download/v0.48.0/frp_0.48.0_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf frp_0.48.0_linux_amd64.tar.gz</span><br></pre></td></tr></table></figure><h2 id="配置server"><a href="#配置server" class="headerlink" title="配置server"></a>配置server</h2><p><code>vim frps.ini</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FRP服务端</span></span><br><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="comment"># frp监听的端口，默认是7000，可以改成其他的</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="comment"># 授权码，请改成更复杂的</span></span><br><span class="line"><span class="attr">token</span> = b3rpf5Gm  <span class="comment"># 这个token之后在客户端会用到</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># frp管理后台端口，请按自己需求更改</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7001</span></span><br><span class="line"><span class="comment"># frp管理后台用户名和密码，请改成自己的</span></span><br><span class="line"><span class="attr">dashboard_user</span> = admin</span><br><span class="line"><span class="attr">dashboard_pwd</span> = admin</span><br><span class="line"><span class="attr">enable_prometheus</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># frp日志配置</span></span><br><span class="line"><span class="attr">log_file</span> = /var/log/frps.log</span><br><span class="line"><span class="attr">log_level</span> = info</span><br><span class="line"><span class="attr">log_max_days</span> = <span class="number">3</span></span><br></pre></td></tr></table></figure><p><strong>添加到systemctl命令组</strong>，保证开机自启动，当然你也可以用docker跑服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/frp</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">ln</span> -s /root/frp/frps.ini /etc/frp/frps.ini</span><br><span class="line">sudo <span class="built_in">cp</span> frps /usr/bin</span><br></pre></td></tr></table></figure><p><code>vim /usr/lib/systemd/system/frps.service</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=The nginx HTTP and reverse proxy server</span><br><span class="line"><span class="attr">After</span>=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/frp/frps -c /usr/local/frp/frps.ini</span><br><span class="line"><span class="attr">KillSignal</span>=SIGQUIT</span><br><span class="line"><span class="attr">TimeoutStopSec</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">KillMode</span>=process</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">StandardOutput</span>=syslog</span><br><span class="line"><span class="attr">StandardError</span>=inherit</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> frps</span><br><span class="line">systemctl start frps</span><br></pre></td></tr></table></figure><p>记得打开需要的端口安全组和防火墙</p><h2 id="配置client"><a href="#配置client" class="headerlink" title="配置client"></a>配置client</h2><p><code>vim frpc.ini</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = &lt;ip&gt;</span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">token</span> = b3rpf5Gm</span><br><span class="line"></span><br><span class="line"><span class="section">[ssh]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">22</span></span><br><span class="line"><span class="comment"># 这个自定义，之后再ssh连接的时候要用</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">7002</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./frpc -c frpc.ini</span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo cp -r frp /usr/local/</span><br><span class="line"></span><br><span class="line">sudo vim /usr/lib/systemd/system/frpc.service</span><br></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=The nginx HTTP and reverse proxy server</span><br><span class="line"><span class="attr">After</span>=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/frp/frpc -c /usr/local/frp/frpc.ini</span><br><span class="line"><span class="attr">KillSignal</span>=SIGQUIT</span><br><span class="line"><span class="attr">TimeoutStopSec</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">KillMode</span>=process</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">StandardOutput</span>=syslog</span><br><span class="line"><span class="attr">StandardError</span>=inherit</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> frpc</span><br><span class="line">systemctl start frpc</span><br></pre></td></tr></table></figure><p>配置完后，可以通过ssh来测试是否能登陆自己的机器</p><h2 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h2><p>配置fpcs，添加</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vhost_http_port</span> = <span class="number">7080</span></span><br></pre></td></tr></table></figure><p>公网server nginx配置，将请求转发到frp的http端口</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> upgrade;</span><br><span class="line">  &#x27;&#x27;      close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="regexp">*.k</span>8s.ryaoknw.site k8s.ryaoknw.site;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl; </span><br><span class="line">    <span class="attribute">server_name</span> <span class="regexp">*.k</span>8s.ryaoknw.site k8s.ryaoknw.site;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/letsencrypt/live/k8s.ryaoknw.site-<span class="number">0001</span>/fullchain.pem; <span class="comment"># 泛域名证书</span></span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/letsencrypt/live/k8s.ryaoknw.site-<span class="number">0001</span>/privkey.pem;</span><br><span class="line">    <span class="attribute">include</span> /etc/letsencrypt/options-ssl-nginx.conf; </span><br><span class="line">    <span class="attribute">ssl_dhparam</span> /etc/letsencrypt/ssl-dhparams.pem; </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:7080;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host      <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>; <span class="comment">#配置weboscket</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;<span class="comment">#配置weboscket</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>配置frpc，<code>frpc.ini</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[http]</span></span><br><span class="line"><span class="attr">type</span> = http</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">80</span></span><br><span class="line"><span class="attr">custom_domains</span> = *.k8s.ryaoknw.site,k8s.ryaoknw.site</span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">7080</span></span><br></pre></td></tr></table></figure><p>内网nginx配置，对应http端口（7080）会被frpc转发到127.0.01:80，nginx代理了80端口，将请求转发到上游node</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> k8s &#123;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">192.168.199.111:80</span>;  <span class="comment"># NodePort </span></span><br><span class="line">  <span class="comment">#server 192.168.199.112:80;</span></span><br><span class="line">  <span class="comment">#server 192.168.199.113:80;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">map</span> <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">  <span class="attribute">default</span> upgrade;</span><br><span class="line">  &#x27;&#x27;      close;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  <span class="regexp">*.k</span>8s.ryaoknw.site k8s.ryaoknw.site;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">      <span class="attribute">proxy_pass</span> http://k8s;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Host      <span class="variable">$host</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">      <span class="attribute">proxy_set_header</span> Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此配置完毕，可以部署服务在本地集群，然后用ingress暴露即可访问</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230417031401586.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230417031401586.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20230417031401586"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;frp配置内网穿透暴露kubernetes集群&quot;&gt;&lt;a href=&quot;#frp配置内网穿透暴露kubernetes集群&quot; class=&quot;headerlink&quot; title=&quot;frp配置内网穿透暴露kubernetes集群&quot;&gt;&lt;/a&gt;frp配置内网穿透暴露kubern</summary>
      
    
    
    
    <category term="kubernetes" scheme="https://blog.ryaoknw.site/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.ryaoknw.site/tags/kubernetes/"/>
    
    <category term="frp" scheme="https://blog.ryaoknw.site/tags/frp/"/>
    
  </entry>
  
  <entry>
    <title>笔记同步方案</title>
    <link href="https://blog.ryaoknw.site/2023/4/419637ff8af9/"/>
    <id>https://blog.ryaoknw.site/2023/4/419637ff8af9/</id>
    <published>2023-04-07T13:17:52.000Z</published>
    <updated>2023-04-07T13:19:21.379Z</updated>
    
    <content type="html"><![CDATA[<h1 id="笔记同步方案"><a href="#笔记同步方案" class="headerlink" title="笔记同步方案"></a>笔记同步方案</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>笔记里写了一大堆东西，现在在windows上保存，并把windows的磁盘开机自动挂载到linux上实现双端的同步，但这样在手机上是访问不到笔记的，很不方便，使用服务器搭建一个webdav倒是很方便，但是这个轻量学生机不是很可靠，万一哪天我玩崩了，内容就消失了，还是使用云服务比较靠谱。</p><h2 id="typora-picgo-七牛云"><a href="#typora-picgo-七牛云" class="headerlink" title="typora+picgo+七牛云"></a>typora+picgo+七牛云</h2><p>我只考虑使用typora作为md编辑器，因为它非常顺手，<strong>我的嘉然主题和字体也非常好看</strong>。</p><p>图片上传使用picgo，一开始用的smms图床，smms图床有足够的免费空间，但是不知何时开始国内无法访问了，图床转而用了聚合图床，免费而且快，但某日发现它会把png转成jpg，这导致我的图片从rgba变成了rgb，这非常不合理，于是转用了七牛云。</p><p>七牛云的cdn用https要记流量付费，于是用nginx做一个反代来实现https的图片</p><h2 id="尝试joplin"><a href="#尝试joplin" class="headerlink" title="尝试joplin"></a>尝试joplin</h2><p>了解到joplin可以作为一个开源的笔记同步工具，安装下来试了试，基本的流程就是</p><ul><li>导入笔记</li><li>设置同步，可以同步到onedrive、dropdox等，也可以是任何的webdav</li><li>然后设置外部编辑器为typora</li></ul><p>每次打开joplin，编辑时打开外部编辑器，但编辑完还得关闭，整个流程非常麻烦，体验非常不好。</p><h2 id="坚果云"><a href="#坚果云" class="headerlink" title="坚果云"></a>坚果云</h2><p>有看到用typora+坚果云的方案，也去试了试，坚果云会提供免费的空间，也有提供linux的客户端</p><p>同步的方法就是webdav，和onedrive是一样的</p><p>但同步需要运行它的客户端，我不是很想每次开机都启动一个坚果云客户端，只把它用来同步我的md笔记</p><h2 id="onedrive"><a href="#onedrive" class="headerlink" title="onedrive"></a>onedrive</h2><p>考虑到还是得用webdav，最后还是回到了onedrive，onedrive在windows上同步是非常方便的，但在linux上挂载需要额外的操作</p><h3 id="rclone"><a href="#rclone" class="headerlink" title="rclone"></a>rclone</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://rclone.org/install.sh | sudo bash</span><br></pre></td></tr></table></figure><p>你需要拿到access_token,或者申请一个API key，用于后续配置中的<code>config_token&gt;</code>，没有API key，<code>client_id&gt;</code>和<code>client_secret&gt;</code>为空即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone authorize <span class="string">&quot;onedrive&quot;</span></span><br></pre></td></tr></table></figure><p>然后配置rclone</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone config</span><br></pre></td></tr></table></figure><p>验证：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone lsd &lt;配置的网盘名称&gt;:/</span><br></pre></td></tr></table></figure><p><img src="https://cdn.ryaoknw.site/picgo/image-20230407172742346.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230407172742346.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="挂载onedrive"><a href="#挂载onedrive" class="headerlink" title="挂载onedrive"></a>挂载onedrive</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install fuse</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone mount &lt;配置的云盘名称&gt;:&lt;要挂载的云盘目录&gt; &lt;作为挂载点的本地目录&gt; --copy-links --no-gzip-encoding --no-check-certificate --allow-other --allow-non-empty --<span class="built_in">umask</span> 000 --daemon</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rclone mount onedrive:/ /home/ryao/onedrive --copy-links --no-gzip-encoding --no-check-certificate --allow-other --allow-non-empty --<span class="built_in">umask</span> 000 --daemon</span><br></pre></td></tr></table></figure><p>取消挂载：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fusermount -qzu &lt;挂载路径&gt;</span><br></pre></td></tr></table></figure><p><strong>开机自启</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">command</span>=<span class="string">&quot; mount onedrive:/ /home/ryao/onedrive --copy-links --no-gzip-encoding --no-check-certificate --allow-other --allow-non-empty --umask 000 --daemon&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /etc/systemd/system/rclone.service &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=Rclone</span></span><br><span class="line"><span class="string">After=network-online.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=simple</span></span><br><span class="line"><span class="string">ExecStart=$(command -v rclone) $&#123;command&#125;</span></span><br><span class="line"><span class="string">Restart=on-abort</span></span><br><span class="line"><span class="string">User=root</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=default.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 开机自启</span><br><span class="line">systemctl enable rclone</span><br><span class="line"># 启动</span><br><span class="line">systemctl start rclone</span><br><span class="line"># 重启</span><br><span class="line">systemctl restart  rclone</span><br><span class="line"># 停止</span><br><span class="line">systemctl status rclone</span><br></pre></td></tr></table></figure><p>终于配置好了，然后发现onedrive的速度简直就是一种折磨，尝试使用了google drive，依旧慢的离谱</p><h2 id="dropbox"><a href="#dropbox" class="headerlink" title="dropbox"></a>dropbox</h2><p><a href="https://www.dropbox.com/install">https://www.dropbox.com/install</a></p><p>放弃了折腾，选择了dropbox。</p><p>不过由于国内连不上的原因，用代理安装后还要再安装Dropbox daemon，但是会connection reset by peer.</p><p>通过下载Dropbox daemon放到根目录就行了。</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230407201040417.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230407201040417.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h2 id="rclone-kodo"><a href="#rclone-kodo" class="headerlink" title="rclone+kodo"></a>rclone+kodo</h2><p>由于众所周知的原因，dropbox不方便访问，所以尽管它很好用，在我这也不好用。</p><p>为什么我不能直接用对象存储来同步呢？难道我访问oss只能用cdn回源？</p><p>在我考虑用rclone来操作dropbox而不是使用它的客户端时，我发现rclone有s3的选项</p><p>配置好就行了，文档：<a href="https://developer.qiniu.com/kodo/12285/docking-rclone">https://developer.qiniu.com/kodo/12285/docking-rclone</a></p><p>rclone是一个强大的工具</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230407205059142.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230407205059142.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>使用<code>rclone sync local-path qiniu:dest-bucket-name/dest-directory-path  </code>进行同步</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230407211058837.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230407211058837.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>对比本地与云<code>rclone check local-path qiniu:dest-bucket-name/dest-directory-path</code></p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230407211352268.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230407211352268.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>非常完美</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;笔记同步方案&quot;&gt;&lt;a href=&quot;#笔记同步方案&quot; class=&quot;headerlink&quot; title=&quot;笔记同步方案&quot;&gt;&lt;/a&gt;笔记同步方案&lt;/h1&gt;&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;</summary>
      
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>音乐管理方案</title>
    <link href="https://blog.ryaoknw.site/2023/4/704fa143084e/"/>
    <id>https://blog.ryaoknw.site/2023/4/704fa143084e/</id>
    <published>2023-04-06T04:12:44.000Z</published>
    <updated>2023-04-07T13:21:03.780Z</updated>
    
    <content type="html"><![CDATA[<h1 id="音乐管理方案"><a href="#音乐管理方案" class="headerlink" title="音乐管理方案"></a>音乐管理方案</h1><h2 id="Navidrome"><a href="#Navidrome" class="headerlink" title="Navidrome"></a>Navidrome</h2><p>使用Navidrome管理音乐</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20230405171158098.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20230405171158098.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">navidrome:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">deluan/navidrome:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;4533:4533&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">ND_SCANSCHEDULE:</span> <span class="string">1m</span></span><br><span class="line">      <span class="attr">ND_SPOTIFY_ID:</span> <span class="string">4cd036bsq**</span></span><br><span class="line">      <span class="attr">ND_SPOTIFY_SECRET:</span> <span class="string">249ca01a**</span>  </span><br><span class="line">      <span class="attr">ND_LOGLEVEL:</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">ND_SESSIONTIMEOUT:</span> <span class="string">24h</span></span><br><span class="line">      <span class="attr">ND_BASEURL:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data:/data&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./music:/music:ro&quot;</span> <span class="comment"># 冒号左边修改成自己本地的音乐文件夹路径</span></span><br></pre></td></tr></table></figure><h3 id="Spotify同步"><a href="#Spotify同步" class="headerlink" title="Spotify同步"></a>Spotify同步</h3><p>在 Spotify 中创建一个免费帐户，然后按照以下步骤操作</p><p><a href="https://developer.spotify.com/dashboard/applications%E6%B3%A8%E5%86%8C%E5%9C%B0%E5%9D%80%EF%BC%8C%E7%84%B6%E5%90%8E%E5%8D%95%E5%87%BB">https://developer.spotify.com/dashboard/applications注册地址，然后单击</a> Spotify 的开发者仪表板中的CREATE AN APP</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ND_SPOTIFY_ID        Spotify 客户端 ID</span><br><span class="line">ND_SPOTIFY_SECRETSpotify 客户端 Secret</span><br></pre></td></tr></table></figure><h3 id="转码设置"><a href="#转码设置" class="headerlink" title="转码设置"></a>转码设置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">转码设置之所以要转码，是因为无损的文件比较大，一般都有几百M，所以需要进行转码成，便于客户端进行播放</span><br><span class="line">但 Navidrome 出于安全原因，禁用了从 Web 界面更改参数，所以需要先修改 Docker 的环境变量</span><br><span class="line">ND_ENABLETRANSCODINGCONFIG设置为 true 才能支持转码功能</span><br><span class="line">ND_TRANSCODINGCACHESIZE转码缓存的大小。设置 0 为禁用缓存，默认为 100MB</span><br></pre></td></tr></table></figure><h2 id="miniserve"><a href="#miniserve" class="headerlink" title="miniserve"></a>miniserve</h2><p>Navidrome<strong>无法直接上传音乐文件</strong>，需要文件服务器来管理。</p><p>看到中文博客上用miniserve，搭了一个，<strong>但是非常不好用</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">miniserve:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">svenstaro/miniserve:latest</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">navidrome</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;4534:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./music:/downloads&quot;</span> <span class="comment"># 冒号左边修改成自己本地的音乐文件夹路径</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">&quot;-r -z -u -q -p 8080 -a username:passwd /downloads&quot;</span> <span class="comment"># </span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure><h2 id="Nextcloud"><a href="#Nextcloud" class="headerlink" title="Nextcloud"></a>Nextcloud</h2><p>在考虑nextcloud、owncloud、seafile，seafile的文件不是直接保存的，而是分块加密保存的，虽然性能强大，但是<strong>不太符合我的需求</strong>。（有时间考虑搭一个seafile）</p><p>nextcloud是非常热门的文件服务方案，功能非常多。</p><p>尝试搭建，但是功能多过，过于臃肿，不太好用，而且php太慢了，1核2G的服务器想用点轻量的东西。</p><h3 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cloud/db:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_ROOT_PASSWORD=FtLpb2Mwx3Qc4BTJ7bmh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=Ks1acs2R2KU5axpbQ7AU</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=nextcloud</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=ryaoknw</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nextcloud</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nextcloud</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">4534</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cloud/config:/var/www/html/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/root/nextcloud:/var/www/html/data</span> <span class="comment"># 这里是映射到外置硬盘，也自行修改</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cloud/apps:/var/www/html/apps</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nextcloud</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_PASSWORD=Ks1acs2R2KU5axpbQ7AU</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_DATABASE=nextcloud</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_USER=ryaoknw</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MYSQL_HOST=db</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">nextcloud:</span></span><br></pre></td></tr></table></figure><h2 id="cloudreve"><a href="#cloudreve" class="headerlink" title="cloudreve"></a>cloudreve</h2><p>找到了cloudreve和alist, alist的侧重不太一样，决定用cloudreve，cloudreve支持webdav，也可以当个网盘用，但是<strong>不是文件原始目录结构</strong>，操，又不能用。</p><h3 id="部署-2"><a href="#部署-2" class="headerlink" title="部署"></a>部署</h3><p>先创建空文件<code>conf.ini</code>、<code>cloudreve.db</code></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">cloudreve:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">cloudreve</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">cloudreve/cloudreve:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5212:5212&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./temp_data:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cloudreve/uploads:/cloudreve/uploads</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cloudreve/conf.ini:/cloudreve/conf.ini</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cloudreve/cloudreve.db:/cloudreve/cloudreve.db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./cloudreve/avatar:/cloudreve/avatar</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">aria2</span></span><br><span class="line">  <span class="attr">aria2:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">aria2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">p3terx/aria2-pro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RPC_SECRET=DGDj6tUgiBMacKZad4zW</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RPC_PORT=6800</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./aria2/config:/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./temp_data:/data</span></span><br></pre></td></tr></table></figure><h2 id="FileBrowser"><a href="#FileBrowser" class="headerlink" title="FileBrowser"></a>FileBrowser</h2><p>文件原始目录结构的文件服务，直接对应服务器文件目录。</p><h3 id="部署-3"><a href="#部署-3" class="headerlink" title="部署"></a>部署</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">filebrowser:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">filebrowser/filebrowser:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">filebrowser</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8089:80&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">filebrowser</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/home/root:/srv</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./filebrowser.db:/database.db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./.filebrowser.json:/.filebrowser.json</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime:ro</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">driver:</span> <span class="string">&#x27;json-file&#x27;</span></span><br><span class="line">      <span class="attr">options:</span></span><br><span class="line">        <span class="attr">max-size:</span> <span class="string">&#x27;1m&#x27;</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">filebrowser:</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">touch filebrowser.db</span><br><span class="line">touch .filebrowser.json</span><br></pre></td></tr></table></figure><p>编辑<code>.filebrowser.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;locale&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zh-cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;baseURL&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stdout&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/database.db&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;root&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/srv&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;音乐管理方案&quot;&gt;&lt;a href=&quot;#音乐管理方案&quot; class=&quot;headerlink&quot; title=&quot;音乐管理方案&quot;&gt;&lt;/a&gt;音乐管理方案&lt;/h1&gt;&lt;h2 id=&quot;Navidrome&quot;&gt;&lt;a href=&quot;#Navidrome&quot; class=&quot;headerlink</summary>
      
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>2023年1月追番锐评</title>
    <link href="https://blog.ryaoknw.site/2023/4/57dcfb3d37eb/"/>
    <id>https://blog.ryaoknw.site/2023/4/57dcfb3d37eb/</id>
    <published>2023-04-02T06:42:08.000Z</published>
    <updated>2023-04-02T07:16:39.111Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一月的动画实在没有什么意思。。。完全没有详细评价的动力哦。还是看看4月吧。</p><h2 id="2023年1月"><a href="#2023年1月" class="headerlink" title="2023年1月"></a>2023年1月</h2><h3 id="想要成为影之实力者！"><a href="#想要成为影之实力者！" class="headerlink" title="想要成为影之实力者！"></a>想要成为影之实力者！</h3><p><img src="https://lain.bgm.tv/pic/cover/c/39/96/329114_mB55b.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/39/96/329114_mB55b.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：6</p><p>20话动画，10月番1月完结，中二转生异世界</p><p>每集ed换个女主来唱，再添一张涩图诚意满满</p><p>动画改编部分也还行，关键把人设和cv整明白了，制作公司和观众之间达成了默契，用着实在不充裕的制作资源，把功夫花在观众想看的地方，成为了每周一乐的厕纸</p><h3 id="别当欧尼酱了！"><a href="#别当欧尼酱了！" class="headerlink" title="别当欧尼酱了！"></a>别当欧尼酱了！</h3><p><img src="https://lain.bgm.tv/pic/cover/c/7e/ca/378862_24TnR.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/7e/ca/378862_24TnR.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：6.5</p><p>萌系作画在近年真吃香，看oped时就被震撼到，这作画就是摆明了在炫技吧。</p><p>全篇都保持了极高的制作水准，Studio Bind纯秀技术，被垃圾污染眼睛时看看别酱动手截图简直是享受</p><h3 id="进击的巨人-最终季-完结篇-前篇"><a href="#进击的巨人-最终季-完结篇-前篇" class="headerlink" title="进击的巨人 最终季 完结篇 前篇"></a>进击的巨人 最终季 完结篇 前篇</h3><p><img src="https://lain.bgm.tv/pic/cover/c/4f/33/376739_KMN9x.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/4f/33/376739_KMN9x.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>star：8</p><p>剧场版高水准制作，但也没有那么“高水准”</p><p>只有1h还要分成前后篇，只能说MAPPA确实事情比较多</p><h3 id="冰剑的魔术师将要统一世界"><a href="#冰剑的魔术师将要统一世界" class="headerlink" title="冰剑的魔术师将要统一世界"></a>冰剑的魔术师将要统一世界</h3><p><img src="https://lain.bgm.tv/pic/cover/c/f8/95/379687_51Jj6.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/f8/95/379687_51Jj6.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：1</p><p>淳皇裕帝将要统一世界</p><p>太乐了，4倍速瞬间乐完，笑得合不拢嘴</p><h3 id="转生公主与天才千金的魔法革命"><a href="#转生公主与天才千金的魔法革命" class="headerlink" title="转生公主与天才千金的魔法革命"></a>转生公主与天才千金的魔法革命</h3><p><img src="https://lain.bgm.tv/pic/cover/c/fd/3c/395714_5EeZx.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/fd/3c/395714_5EeZx.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：5</p><p>人设不错，百合好好好</p><p>演出太傻了，重百剧情不带点纠结情愫和扭曲文学看着没意思</p><p>除了yuri之外内容不需要评价</p><h3 id="生而为狗，我很幸福"><a href="#生而为狗，我很幸福" class="headerlink" title="生而为狗，我很幸福"></a>生而为狗，我很幸福</h3><p><img src="https://lain.bgm.tv/pic/cover/c/83/d3/374319_JSG4d.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/83/d3/374319_JSG4d.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：4.5</p><p>看无修第一话时：神！</p><p>继续每周看时：好无聊，逆天的劲头一过，同质化的内容完全提不起继续看的兴趣</p><h3 id="魔王学院的不适任者～史上最强的魔王始祖，转生就读子孙们的学校～-Ⅱ"><a href="#魔王学院的不适任者～史上最强的魔王始祖，转生就读子孙们的学校～-Ⅱ" class="headerlink" title="魔王学院的不适任者～史上最强的魔王始祖，转生就读子孙们的学校～ Ⅱ"></a>魔王学院的不适任者～史上最强的魔王始祖，转生就读子孙们的学校～ Ⅱ</h3><p><img src="https://lain.bgm.tv/pic/cover/c/5e/85/330054_86gc8.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/5e/85/330054_86gc8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>star：4</p><p>第一季时好感拉满，大沼心简直是厕纸大师，但在第二季中明显拉垮。</p><p>实在不想听裕帝的答辩声线，剧情质量与第一季也完全不能比</p><p>本来很期待这位“镀金厕纸”，但最后表现地十分遗憾。</p><h2 id="补番"><a href="#补番" class="headerlink" title="补番"></a>补番</h2><p><strong>只涉及近年放送但当季没追、之后才补完的，可能涉及想要特意评价但没时间写长评的。</strong></p><h3 id="擅长捉弄的高木同学-剧场版"><a href="#擅长捉弄的高木同学-剧场版" class="headerlink" title="擅长捉弄的高木同学 剧场版"></a>擅长捉弄的高木同学 剧场版</h3><p><img src="https://lain.bgm.tv/pic/cover/c/fd/00/347888_fBpdB.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/fd/00/347888_fBpdB.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：6</p><p>大郎，该吃狗粮了，都什么年代了还在吃传统狗粮？</p><p>我认为高木胜在小剧场的形式和只使用西片视角来表现捉弄的细节和二人心意的精妙演出，但剧场版稀烂的后半段只值得听听音乐。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;一月的动画实在没有什么意思。。。完全没有详细评价的动力哦。还是看看4月吧。&lt;/p&gt;
&lt;h2 id=&quot;2023年1月&quot;&gt;&lt;a href=&quot;#2</summary>
      
    
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/categories/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>k8s(基本概念)</title>
    <link href="https://blog.ryaoknw.site/2023/4/7b74ee081b63/"/>
    <id>https://blog.ryaoknw.site/2023/4/7b74ee081b63/</id>
    <published>2023-04-02T06:36:16.000Z</published>
    <updated>2023-04-16T19:16:57.917Z</updated>
    
    <content type="html"><![CDATA[<h2 id="k8s是啥"><a href="#k8s是啥" class="headerlink" title="k8s是啥"></a>k8s是啥</h2><p>为<strong>容器化</strong>应用提供集群部署和管理的开源工具</p><p>集群由master和node组成</p><p><strong>Kubernetes 组件</strong></p><p><code>kube-apiserver</code> API 服务器，公开了 Kubernetes API<br><code>etcd</code> 键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库<br><code>kube-scheduler</code> 调度 Pod 到哪个节点运行<br><code>kube-controller</code> 集群控制器<br><code>cloud-controller</code> 与云服务商交互</p><p><strong>node 组件</strong></p><p><code>Kubelet</code> 负责当前 Node 节点的 Pod 的创建、监控、修改和删除等</p><p><code>Proxy</code> 负责 Service 代理，同时也是软件模式的负载均衡器</p><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><img src="https://cdn.ryaoknw.site/picgo/image-20221104044635790.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221104044635790.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h3 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h3><p>Kubernetes 中创建和管理的、最小的可部署的计算单元。安排在节点上，包含一组容器和卷。同一个Pod里的容器共享同一个网络命名空间，可以使用localhost互相通信。</p><p>一个pod内共享内部的所有资源。</p><h3 id="lable"><a href="#lable" class="headerlink" title="lable"></a>lable</h3><p>Label是attach到Pod的一对键&#x2F;值对，用来传递用户定义的属性。Label Selector。</p><h3 id="replication-controller-RC"><a href="#replication-controller-RC" class="headerlink" title="replication controller(RC)"></a>replication controller(RC)</h3><p>Replication Controller确保任意时间都有指定数量的Pod“副本”在运行。如果为某个Pod创建了Replication Controller并且指定3个副本，它会创建3个Pod，并且持续监控它们。如果某个Pod不响应，那么Replication Controller会替换它，保持总数为3</p><p>（管理pod生命周期）</p><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>每个 Pod 都会被分配一个唯一的 IP, 不过缺点就是这个 IP 会随着 Pod 的销毁而消失。</p><p>一个 Service 可以视为是一组提供相同服务的 Pod 的对外访问接口</p><h2 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 部署名字</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="comment"># 用来查找关联的 Pod，所有标签都匹配才行</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test-k8s</span></span><br><span class="line">  <span class="comment"># 定义 Pod 相关数据</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test-k8s</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 定义容器，可以多个</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> <span class="comment"># 容器名字</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:latest</span> <span class="comment"># 镜像</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p> 单独配置 pod :</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义容器，可以多个</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> <span class="comment"># 容器名字</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:latest</span> <span class="comment"># 镜像</span></span><br></pre></td></tr></table></figure><h2 id="service-1"><a href="#service-1" class="headerlink" title="service"></a>service</h2><ul><li>Service 通过 label 关联对应的 Pod</li><li>Servcie 生命周期不跟 Pod 绑定，不会因为 Pod 重创改变 IP</li><li>提供了负载均衡功能，自动转发流量到不同 Pod</li><li>可对集群外部提供访问端口</li><li>集群内部可通过服务名字访问</li></ul><p><img src="https://cdn.ryaoknw.site/picgo/image-20221104044644362.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221104044644362.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-k8s</span></span><br><span class="line">  <span class="comment"># 默认 ClusterIP 集群内可访问，NodePort 节点可访问，LoadBalancer 负载均衡模式（需要负载均衡器才可用）</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span> <span class="comment"># 本 Service 的端口</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-k8s</span> <span class="comment"># 必须配置</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span> <span class="comment"># 容器端口</span></span><br><span class="line">      <span class="comment"># nodePort: 31000 # 节点端口，范围固定 30000 ~ 32767</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8090</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-other</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8090</span></span><br><span class="line">      <span class="comment"># nodePort: 32000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><p>StatefulSet 是用来管理有状态的应用，例如数据库。<br>前面我们部署的应用，都是不需要存储数据，不需要记住状态的，可以随意扩充副本，每个副本都是一样的，可替代的。<br>而像数据库、Redis 这类有状态的，则不能随意扩充副本。<br>StatefulSet 会固定每个 Pod 的名字</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:latest</span></span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span>  </span><br><span class="line">              <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/db</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">mongo-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">             <span class="attr">claimName:</span> <span class="string">mongodata</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># HeadLess （不分配ip）</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">27017</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>Service 的 <code>CLUSTER-IP</code> 是空的，Pod 名字也是固定的。</li><li>Pod 创建和销毁是有序的，创建是顺序的，销毁是逆序的。</li><li>Pod 重建不会改变名字，除了IP，所以不要用IP直连</li></ul><p>如果直接使用 Service 名字连接，会随机转发请求，要连接指定 Pod，可以这样<code>pod-name.service-name</code>，比如<code>mongodb-0.mongodb</code></p><h2 id="ConfigMap-amp-Secret"><a href="#ConfigMap-amp-Secret" class="headerlink" title="ConfigMap &amp; Secret"></a>ConfigMap &amp; Secret</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mongoHost:</span> <span class="string">mongodb-0.mongodb</span></span><br></pre></td></tr></table></figure><p><img src="https://cdn.ryaoknw.site/picgo/image-20221030141043781.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221030141043781.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>密码、TOKEN，我们可以放到 secret 中。（数据需要Base64编码）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line"><span class="comment"># Opaque 用户定义的任意数据 https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-types</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 数据要 base64。https://tools.fun/base64.html</span></span><br><span class="line">  <span class="attr">mongo-username:</span> <span class="string">bW9uZ291c2Vy</span></span><br><span class="line">  <span class="attr">mongo-password:</span> <span class="string">bW9uZ29wYXNz</span></span><br></pre></td></tr></table></figure><blockquote><p>作为环境变量</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.4</span></span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_USERNAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">mongo-username</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_PASSWORD</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">mongo-password</span></span><br><span class="line">          <span class="comment"># Secret 的所有数据定义为容器的环境变量，Secret 中的键名称为 Pod 中的环境变量名称</span></span><br><span class="line">          <span class="comment"># envFrom:</span></span><br><span class="line">          <span class="comment"># - secretRef:</span></span><br><span class="line">          <span class="comment">#     name: mongo-secret</span></span><br></pre></td></tr></table></figure><p>或者挂载为文件（不展开了）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br></pre></td></tr></table></figure><h2 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h2><p>Ingress 为外部访问集群提供了一个 <strong>统一</strong> 入口，避免了对外暴露集群端口；<br>功能类似 Nginx，可以根据域名、路径把请求转发到不同的 Service。<br>可以配置 https</p><p><strong>跟 LoadBalancer 有什么区别？</strong><br>LoadBalancer 需要对外暴露端口，不安全；<br>无法根据域名、路径转发流量到不同 Service，多个 Service 则需要开多个 LoadBalancer；<br>功能单一，无法配置 https</p><p>要使用 Ingress，需要一个负载均衡器 + Ingress Controller。</p><p>负载均衡插件，可以安装 <a href="https://metallb.universe.tf/">METALLB</a>。</p><p>NGINX Ingress <a href="https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/">https://kubernetes.io/zh-cn/docs/tasks/access-application-cluster/ingress-minikube/</a></p><p>配置yaml。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">hello-world.info</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/doc</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">4200</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/svnbucket</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;k8s是啥&quot;&gt;&lt;a href=&quot;#k8s是啥&quot; class=&quot;headerlink&quot; title=&quot;k8s是啥&quot;&gt;&lt;/a&gt;k8s是啥&lt;/h2&gt;&lt;p&gt;为&lt;strong&gt;容器化&lt;/strong&gt;应用提供集群部署和管理的开源工具&lt;/p&gt;
&lt;p&gt;集群由master和nod</summary>
      
    
    
    
    <category term="kubernetes" scheme="https://blog.ryaoknw.site/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.ryaoknw.site/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>MIT6.824 Lab1</title>
    <link href="https://blog.ryaoknw.site/2023/4/0decddbbfd18/"/>
    <id>https://blog.ryaoknw.site/2023/4/0decddbbfd18/</id>
    <published>2023-04-02T06:34:35.000Z</published>
    <updated>2023-04-02T06:38:39.610Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Lab1"><a href="#Lab1" class="headerlink" title="Lab1"></a>Lab1</h2><h3 id="mapreduce"><a href="#mapreduce" class="headerlink" title="mapreduce"></a>mapreduce</h3><p>lab1需要实现一个mapreduce </p><p>Master和Worker的main例程在<code>main/mrcoordinator.go</code>和<code>main/mrworker.go</code>中，不要改动这些程序。<br>需要在<code>mr/coordinator.go</code>,<code>mr/worker.go</code>和<code>mr/rpc.go</code>中实现自己的代码。</p><p>worker执行map和reduce工作，master用于调度和分配任务，同时维护任务和worker的状态，两者通过rpc调用通信。</p><ul><li>在处理 Map 任务时，需要将中间产物 Key 切分为 <code>nReduce</code> 个 reduce 任务，这个参数是调用 <code>MakeMaster()</code> 函数时指定的！</li><li>第 X 个 Reduce 任务的产物应当命名为：<code>mr-out-X</code>；</li><li>最终输出文件 <code>mr-out-X</code> 应当每行一个输出，并且采用 <code>&quot;%v %v&quot;</code> 格式（和 <code>main/mrsequential.go</code> 一致）；</li><li>当 <code>main/mrmaster.go</code> 调用 <code>mr/master.go</code> 的 <code>Done</code> 函数返回 true 时，其认为所有任务都已完成，将会退出；</li><li>当所有的任务都结束，worker 应当退出；一个简单的实现是：当调用 <code>call</code> rpc 与 master 通信失败时，认为任务结束；不过一个另外一个做法是当任务结束后，master 下发一个 <code>请退出</code> 的任务，交给 worker 去执行</li></ul><p><code>worker.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mr</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;bytes&quot;</span></span><br><span class="line"><span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;hash/fnv&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;path/filepath&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Map functions return a slice of KeyValue.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">type</span> KeyValue <span class="keyword">struct</span> &#123;</span><br><span class="line">Key   <span class="type">string</span></span><br><span class="line">Value <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// use ihash(key) % NReduce to choose the reduce</span></span><br><span class="line"><span class="comment">// task number for each KeyValue emitted by Map.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ihash</span><span class="params">(key <span class="type">string</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">h := fnv.New32a()</span><br><span class="line">h.Write([]<span class="type">byte</span>(key))</span><br><span class="line"><span class="keyword">return</span> <span class="type">int</span>(h.Sum32() &amp; <span class="number">0x7fffffff</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// main/mrworker.go calls this function.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(mapf <span class="keyword">func</span>(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue,</span><br><span class="line">reducef <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your worker implementation here.</span></span><br><span class="line">info := doGetInfo()</span><br><span class="line">log.Printf(<span class="string">&quot;Worker: receive coordinator&#x27;s info %v\n&quot;</span>, info)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">task := doCorrespond()</span><br><span class="line">log.Printf(<span class="string">&quot;Worker: receive coordinator&#x27;s response %v\n&quot;</span>, task)</span><br><span class="line"><span class="keyword">switch</span> task.Type &#123;</span><br><span class="line"><span class="keyword">case</span> MapType:</span><br><span class="line">MapTask(mapf, task.File, info.NReduce, task.Id)</span><br><span class="line"><span class="keyword">case</span> ReduceType:</span><br><span class="line">ReduceTask(reducef, info.NMap, task.Id)</span><br><span class="line"><span class="keyword">case</span> WaitType:</span><br><span class="line">time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line"><span class="keyword">case</span> StopType:</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MapTask</span><span class="params">(mapF <span class="keyword">func</span>(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue, filePath <span class="type">string</span>, NReduce <span class="type">int</span>, id <span class="type">int</span>) &#123;</span><br><span class="line">fileName := filePath</span><br><span class="line">file, err := os.Open(fileName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, fileName)</span><br><span class="line">&#125;</span><br><span class="line">content, err := ioutil.ReadAll(file)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;cannot read %v&quot;</span>, fileName)</span><br><span class="line">&#125;</span><br><span class="line">file.Close()</span><br><span class="line"></span><br><span class="line">kva := mapF(fileName, <span class="type">string</span>(content))</span><br><span class="line">intermediates := <span class="built_in">make</span>([][]KeyValue, NReduce)</span><br><span class="line"><span class="keyword">for</span> _, kv := <span class="keyword">range</span> kva &#123;</span><br><span class="line">index := ihash(kv.Key) % NReduce</span><br><span class="line">intermediates[index] = <span class="built_in">append</span>(intermediates[index], kv)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> index, intermediate := <span class="keyword">range</span> intermediates &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(index <span class="type">int</span>, intermediate []KeyValue)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">tmpFileName := fmt.Sprintf(<span class="string">&quot;mr-%d-%d&quot;</span>, id, index)</span><br><span class="line"><span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">enc := json.NewEncoder(&amp;buf)</span><br><span class="line"><span class="keyword">for</span> _, kv := <span class="keyword">range</span> intermediate &#123;</span><br><span class="line">err := enc.Encode(&amp;kv)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;cannot encode json %v\n&quot;</span>, kv.Key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">err := WriteFile(tmpFileName, &amp;buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;cannot write file %v, %v\n&quot;</span>, tmpFileName, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;(index, intermediate)</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">doReport(id, MapType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReduceTask</span><span class="params">(reduceF <span class="keyword">func</span>(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span>, NMap <span class="type">int</span>, id <span class="type">int</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> kva []KeyValue</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NMap; i++ &#123;</span><br><span class="line">filePath := fmt.Sprintf(<span class="string">&quot;mr-%d-%d&quot;</span>, i, id)</span><br><span class="line">file, err := os.Open(filePath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, filePath)</span><br><span class="line">&#125;</span><br><span class="line">dec := json.NewDecoder(file)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">var</span> kv KeyValue</span><br><span class="line"><span class="keyword">if</span> err := dec.Decode(&amp;kv); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">kva = <span class="built_in">append</span>(kva, kv)</span><br><span class="line">&#125;</span><br><span class="line">file.Close()</span><br><span class="line">&#125;</span><br><span class="line">results := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, kv := <span class="keyword">range</span> kva &#123;</span><br><span class="line">results[kv.Key] = <span class="built_in">append</span>(results[kv.Key], kv.Value)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line"><span class="keyword">for</span> key, values := <span class="keyword">range</span> results &#123;</span><br><span class="line">output := reduceF(key, values)</span><br><span class="line">fmt.Fprintf(&amp;buf, <span class="string">&quot;%v %v\n&quot;</span>, key, output)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tmpFileName := fmt.Sprintf(<span class="string">&quot;mr-out-%d&quot;</span>, id)</span><br><span class="line">err := WriteFile(tmpFileName, &amp;buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatalf(<span class="string">&quot;cannot write file %v, %v\n&quot;</span>, tmpFileName, err)</span><br><span class="line">&#125;</span><br><span class="line">doReport(id, ReduceType)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// send an RPC request to the coordinator, wait for the response.</span></span><br><span class="line"><span class="comment">// usually returns true.</span></span><br><span class="line"><span class="comment">// returns false if something goes wrong.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">call</span><span class="params">(rpcname <span class="type">string</span>, args <span class="keyword">interface</span>&#123;&#125;, reply <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="comment">// c, err := rpc.DialHTTP(&quot;tcp&quot;, &quot;127.0.0.1&quot;+&quot;:1234&quot;)</span></span><br><span class="line">sockname := coordinatorSock()</span><br><span class="line">c, err := rpc.DialHTTP(<span class="string">&quot;unix&quot;</span>, sockname)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;dialing:&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> c.Close()</span><br><span class="line"></span><br><span class="line">err = c.Call(rpcname, args, reply)</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(err)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doCorrespond</span><span class="params">()</span></span> *CorrespondResponse &#123;</span><br><span class="line">rsp := CorrespondResponse&#123;&#125;</span><br><span class="line">call(<span class="string">&quot;Coordinator.Correspond&quot;</span>, &amp;CorrespondRequest&#123;&#125;, &amp;rsp)</span><br><span class="line"><span class="keyword">return</span> &amp;rsp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doGetInfo</span><span class="params">()</span></span> *InfoResponse &#123;</span><br><span class="line">rsp := InfoResponse&#123;&#125;</span><br><span class="line">call(<span class="string">&quot;Coordinator.Info&quot;</span>, &amp;InfoRequest&#123;&#125;, &amp;rsp)</span><br><span class="line"><span class="keyword">return</span> &amp;rsp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doReport</span><span class="params">(id <span class="type">int</span>, t TaskType)</span></span> &#123;</span><br><span class="line">call(<span class="string">&quot;Coordinator.Report&quot;</span>, &amp;ReportRequest&#123;id, t&#125;, &amp;ReportResponse&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteFile</span><span class="params">(filename <span class="type">string</span>, r io.Reader)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">dir, file := filepath.Split(filename)</span><br><span class="line"><span class="keyword">if</span> dir == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">dir = <span class="string">&quot;.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f, err := ioutil.TempFile(dir, file)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;cannot create temp file: %v&quot;</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">_ = os.Remove(f.Name())</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">name := f.Name()</span><br><span class="line"><span class="keyword">if</span> _, err := io.Copy(f, r); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;cannot write data to tempfile %q: %v&quot;</span>, name, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := f.Close(); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;can&#x27;t close tempfile %q: %v&quot;</span>, name, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">info, err := os.Stat(filename)</span><br><span class="line"><span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := os.Chmod(name, info.Mode()); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;can&#x27;t set filemode on tempfile %q: %v&quot;</span>, name, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err := os.Rename(name, filename); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;cannot replace %q with tempfile %q: %v&quot;</span>, filename, name, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>coordinator.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mr</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">Timeout = time.Second * <span class="number">10</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> once *sync.Once</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Task <span class="keyword">struct</span> &#123;</span><br><span class="line">File      <span class="type">string</span></span><br><span class="line">Id        <span class="type">int</span></span><br><span class="line">Type      TaskType</span><br><span class="line">Status    TaskStatus</span><br><span class="line">StartTime time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">lock sync.Mutex</span><br><span class="line"></span><br><span class="line">Files []<span class="type">string</span></span><br><span class="line"><span class="comment">// Your definitions here.</span></span><br><span class="line">NReduce  <span class="type">int</span></span><br><span class="line">NMap     <span class="type">int</span></span><br><span class="line">Close    <span class="type">bool</span></span><br><span class="line">TaskCh   <span class="keyword">chan</span> CorrespondMsg</span><br><span class="line">Tasks    []Task</span><br><span class="line">doneCh   <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">ReportCh <span class="keyword">chan</span> ReportMsg</span><br><span class="line">WorkFlow Flow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CorrespondMsg <span class="keyword">struct</span> &#123;</span><br><span class="line">response *CorrespondResponse</span><br><span class="line">ok       <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReportMsg <span class="keyword">struct</span> &#123;</span><br><span class="line">request *ReportRequest</span><br><span class="line">ok      <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your code here -- RPC handlers for the worker to call.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Correspond(request *CorrespondRequest, response *CorrespondResponse) <span class="type">error</span> &#123;</span><br><span class="line">msg := CorrespondMsg&#123;response, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)&#125;</span><br><span class="line">c.TaskCh &lt;- msg</span><br><span class="line">&lt;-msg.ok <span class="comment">// wait send task response</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Info(request *InfoRequest, response *InfoResponse) <span class="type">error</span> &#123;</span><br><span class="line">response.NMap, response.NReduce, response.Close = c.NMap, c.NReduce, c.Close</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Report(request *ReportRequest, response *ReportResponse) <span class="type">error</span> &#123;</span><br><span class="line">msg := ReportMsg&#123;request, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)&#125;</span><br><span class="line">c.ReportCh &lt;- msg</span><br><span class="line">&lt;-msg.ok</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Scheduler() &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> c.WorkFlow &#123;</span><br><span class="line"><span class="keyword">case</span> OnInit:</span><br><span class="line">c.WorkFlow = OnMap</span><br><span class="line"><span class="keyword">case</span> OnMap:</span><br><span class="line">once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator start %v\n&quot;</span>, OnMap)</span><br><span class="line">c.initMap()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-c.TaskCh:</span><br><span class="line">c.Assigner(&amp;msg)</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator: assigned a task %v to worker\n&quot;</span>, msg.response)</span><br><span class="line">msg.ok &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-c.ReportCh:</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator: Worker has executed task %v \n&quot;</span>, msg.request)</span><br><span class="line">c.lock.Lock()</span><br><span class="line">c.Tasks[msg.request.Id].Status = Finished</span><br><span class="line">c.lock.Unlock()</span><br><span class="line">msg.ok &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> OnReduce:</span><br><span class="line">once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator: %v finished, start %v\n&quot;</span>, OnMap, OnReduce)</span><br><span class="line">c.initReduce()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-c.TaskCh:</span><br><span class="line">c.Assigner(&amp;msg)</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator: assigned a task %v to worker\n&quot;</span>, msg.response)</span><br><span class="line">msg.ok &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-c.ReportCh:</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator: Worker has executed task %v\n&quot;</span>, msg.request)</span><br><span class="line">c.lock.Lock()</span><br><span class="line">c.Tasks[msg.request.Id].Status = Finished</span><br><span class="line">c.lock.Unlock()</span><br><span class="line">msg.ok &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> OnComplete:</span><br><span class="line">once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator: %v finished\n&quot;</span>, OnReduce)</span><br><span class="line">c.initComplete()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> msg := &lt;-c.TaskCh:</span><br><span class="line">msg.response.Type = StopType</span><br><span class="line">log.Printf(<span class="string">&quot;Coordinator: assigned stop to worker\n&quot;</span>)</span><br><span class="line">msg.ok &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Assigner(msg *CorrespondMsg) &#123;</span><br><span class="line">c.lock.Lock()</span><br><span class="line"><span class="keyword">defer</span> c.lock.Unlock()</span><br><span class="line"></span><br><span class="line">finish := <span class="literal">true</span></span><br><span class="line">getJob := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> id, task := <span class="keyword">range</span> c.Tasks &#123;</span><br><span class="line"><span class="keyword">switch</span> task.Status &#123;</span><br><span class="line"><span class="keyword">case</span> UnDo:</span><br><span class="line">finish = <span class="literal">false</span></span><br><span class="line">getJob = <span class="literal">true</span></span><br><span class="line">c.Tasks[id].Status = Working</span><br><span class="line">c.Tasks[id].StartTime = time.Now()</span><br><span class="line">msg.response.Id = id</span><br><span class="line"><span class="keyword">switch</span> c.WorkFlow &#123;</span><br><span class="line"><span class="keyword">case</span> OnMap:</span><br><span class="line">msg.response.Type = MapType</span><br><span class="line">msg.response.File = c.Files[id]</span><br><span class="line"><span class="keyword">case</span> OnReduce:</span><br><span class="line">msg.response.Type = ReduceType</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> Working:</span><br><span class="line">finish = <span class="literal">false</span></span><br><span class="line"><span class="comment">// set timeout</span></span><br><span class="line"><span class="keyword">if</span> time.Now().Sub(task.StartTime) &gt; Timeout &#123;</span><br><span class="line">c.Tasks[id].Status = UnDo</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> Finished:</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> getJob &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !getJob &#123;</span><br><span class="line">msg.response.Type = WaitType</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> finish &#123;</span><br><span class="line">c.WorkFlow++</span><br><span class="line">once = <span class="built_in">new</span>(sync.Once)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> initMap() &#123;</span><br><span class="line">c.WorkFlow = OnMap</span><br><span class="line">c.Tasks = <span class="built_in">make</span>([]Task, <span class="built_in">len</span>(c.Files))</span><br><span class="line"><span class="keyword">for</span> index, file := <span class="keyword">range</span> c.Files &#123;</span><br><span class="line">c.Tasks[index] = Task&#123;</span><br><span class="line">File:   file,</span><br><span class="line">Id:     index,</span><br><span class="line">Status: UnDo,</span><br><span class="line">Type:   MapType,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> initReduce() &#123;</span><br><span class="line">c.WorkFlow = OnReduce</span><br><span class="line">c.Tasks = <span class="built_in">make</span>([]Task, c.NReduce)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; c.NReduce; i++ &#123;</span><br><span class="line">c.Tasks[i] = Task&#123;</span><br><span class="line">Id:     i,</span><br><span class="line">Status: UnDo,</span><br><span class="line">Type:   ReduceType,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> initComplete() &#123;</span><br><span class="line">c.WorkFlow = OnComplete</span><br><span class="line">c.doneCh &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// start a thread that listens for RPCs from worker.go</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> server() &#123;</span><br><span class="line">rpc.Register(c)</span><br><span class="line">rpc.HandleHTTP()</span><br><span class="line"><span class="comment">//l, e := net.Listen(&quot;tcp&quot;, &quot;:1234&quot;)</span></span><br><span class="line">sockname := coordinatorSock()</span><br><span class="line">os.Remove(sockname)</span><br><span class="line">l, e := net.Listen(<span class="string">&quot;unix&quot;</span>, sockname)</span><br><span class="line"><span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">&quot;listen error:&quot;</span>, e)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> http.Serve(l, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// main/mrcoordinator.go calls Done() periodically to find out</span></span><br><span class="line"><span class="comment">// if the entire job has finished.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Done() <span class="type">bool</span> &#123;</span><br><span class="line">&lt;-c.doneCh</span><br><span class="line">c.Close = <span class="literal">true</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// create a Coordinator.</span></span><br><span class="line"><span class="comment">// main/mrcoordinator.go calls this function.</span></span><br><span class="line"><span class="comment">// nReduce is the number of reduce tasks to use.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeCoordinator</span><span class="params">(files []<span class="type">string</span>, nReduce <span class="type">int</span>)</span></span> *Coordinator &#123;</span><br><span class="line">c := Coordinator&#123;</span><br><span class="line">Files:    files,</span><br><span class="line">NReduce:  nReduce,</span><br><span class="line">NMap:     <span class="built_in">len</span>(files),</span><br><span class="line">Close:    <span class="literal">false</span>,</span><br><span class="line">doneCh:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">1</span>),</span><br><span class="line">TaskCh:   <span class="built_in">make</span>(<span class="keyword">chan</span> CorrespondMsg),</span><br><span class="line">ReportCh: <span class="built_in">make</span>(<span class="keyword">chan</span> ReportMsg),</span><br><span class="line">WorkFlow: OnInit,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Your code here.</span></span><br><span class="line">once = <span class="built_in">new</span>(sync.Once)</span><br><span class="line">c.server()</span><br><span class="line"><span class="keyword">go</span> c.Scheduler()</span><br><span class="line"><span class="keyword">return</span> &amp;c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>rpc.go</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mr</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// RPC definitions.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// remember to capitalize all names.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;strconv&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskType <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Flow <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TaskStatus <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">WaitType TaskType = <span class="literal">iota</span></span><br><span class="line">MapType</span><br><span class="line">ReduceType</span><br><span class="line">StopType</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(task TaskType)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> task &#123;</span><br><span class="line"><span class="keyword">case</span> MapType:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;MapType&quot;</span></span><br><span class="line"><span class="keyword">case</span> ReduceType:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;ReduceType&quot;</span></span><br><span class="line"><span class="keyword">case</span> WaitType:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;WaitType&quot;</span></span><br><span class="line"><span class="keyword">case</span> StopType:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;StopType&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;unexpected TaskType %d&quot;</span>, task))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// TaskStatus</span></span><br><span class="line">UnDo TaskStatus = <span class="literal">iota</span></span><br><span class="line">Working</span><br><span class="line">Finished</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(status TaskStatus)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> status &#123;</span><br><span class="line"><span class="keyword">case</span> UnDo:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;UnDo&quot;</span></span><br><span class="line"><span class="keyword">case</span> Working:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Working&quot;</span></span><br><span class="line"><span class="keyword">case</span> Finished:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;Finished&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;unexpected TaskStatus %d&quot;</span>, status))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line"><span class="comment">// WorkFlow</span></span><br><span class="line">OnInit Flow = <span class="literal">iota</span></span><br><span class="line">OnMap</span><br><span class="line">OnReduce</span><br><span class="line">OnComplete</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(flow Flow)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> flow &#123;</span><br><span class="line"><span class="keyword">case</span> OnInit:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;OnInit&quot;</span></span><br><span class="line"><span class="keyword">case</span> OnMap:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;OnMap&quot;</span></span><br><span class="line"><span class="keyword">case</span> OnReduce:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;OnReduce&quot;</span></span><br><span class="line"><span class="keyword">case</span> OnComplete:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;OnComplete&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;unexpected WorkFlow %d&quot;</span>, flow))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CorrespondRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CorrespondResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">File <span class="type">string</span></span><br><span class="line">Id   <span class="type">int</span></span><br><span class="line">Type TaskType</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> InfoRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> InfoResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">NMap    <span class="type">int</span></span><br><span class="line">NReduce <span class="type">int</span></span><br><span class="line">Close   <span class="type">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReportRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">Id   <span class="type">int</span></span><br><span class="line">Type TaskType</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ReportResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(response CorrespondResponse)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> response.Type &#123;</span><br><span class="line"><span class="keyword">case</span> MapType:</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;&#123;Type:%v,File:%v,Id:%v&#125;&quot;</span>, response.Type, response.File, response.Id)</span><br><span class="line"><span class="keyword">case</span> ReduceType:</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;&#123;Type:%v,Id:%v&#125;&quot;</span>, response.Type, response.Id)</span><br><span class="line"><span class="keyword">case</span> WaitType, StopType:</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;&#123;Type:%v&#125;&quot;</span>, response.Type)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;unexpected Type %d&quot;</span>, response.Type))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(request ReportRequest)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;&#123;Id:%v,Type:%v&#125;&quot;</span>, request.Id, request.Type)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add your RPC definitions here.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cook up a unique-ish UNIX-domain socket name</span></span><br><span class="line"><span class="comment">// in /var/tmp, for the coordinator.</span></span><br><span class="line"><span class="comment">// Can&#x27;t use the current directory since</span></span><br><span class="line"><span class="comment">// Athena AFS doesn&#x27;t support UNIX-domain sockets.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">coordinatorSock</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">s := <span class="string">&quot;/var/tmp/824-mr-&quot;</span></span><br><span class="line">s += strconv.Itoa(os.Getuid())</span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Lab1&quot;&gt;&lt;a href=&quot;#Lab1&quot; class=&quot;headerlink&quot; title=&quot;Lab1&quot;&gt;&lt;/a&gt;Lab1&lt;/h2&gt;&lt;h3 id=&quot;mapreduce&quot;&gt;&lt;a href=&quot;#mapreduce&quot; class=&quot;headerlink&quot; title=</summary>
      
    
    
    
    <category term="Lab" scheme="https://blog.ryaoknw.site/categories/Lab/"/>
    
    
    <category term="MIT6.824" scheme="https://blog.ryaoknw.site/tags/MIT6-824/"/>
    
  </entry>
  
  <entry>
    <title>CS144 Lab2</title>
    <link href="https://blog.ryaoknw.site/2023/4/356cea6e7c3a/"/>
    <id>https://blog.ryaoknw.site/2023/4/356cea6e7c3a/</id>
    <published>2023-04-02T06:27:30.000Z</published>
    <updated>2023-04-02T07:38:22.136Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Lab2"><a href="#Lab2" class="headerlink" title="Lab2"></a>Lab2</h2><h3 id="wrapping-int32"><a href="#wrapping-int32" class="headerlink" title="wrapping_int32"></a>wrapping_int32</h3><p>实现序列号、绝对序列号与流索引间的转换。</p><p>出现cmake报错为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMake Error: The following variables are used in this project, but they are set to NOTFOUND.</span><br><span class="line">Please set them or make sure they are set and tested correctly in the CMake files:</span><br><span class="line">LIBPCAP</span><br><span class="line">    linked by target &quot;tcp_parser&quot; in directory /home/kangyu/sponge/testslinked by target &quot;tcp_parser&quot; in directory /home/ryao/Projects/cppProjects/CS144Labs/tests</span><br></pre></td></tr></table></figure><p>需要安装<code>libpcap-dev</code>库来解决. <code>apt install libpcap-dev</code></p><p>文段中指出了三种序列的关系，其中stream indices就是在lab1中的序列。</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20221117141326664.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221117141326664.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><img src="https://cdn.ryaoknw.site/picgo/image-20221117141427341.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221117141427341.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>照着写就行了</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WrappingInt32 <span class="title">wrap</span><span class="params">(<span class="type">uint64_t</span> n, WrappingInt32 isn)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    uint64_t m = (1ll &lt;&lt; 32);</span></span><br><span class="line">    <span class="comment">//    uint32_t num = (n + isn.raw_value()) % m;</span></span><br><span class="line">    <span class="comment">//    return WrappingInt32&#123;num&#125;;</span></span><br><span class="line">    <span class="keyword">return</span> WrappingInt32&#123;isn.<span class="built_in">raw_value</span>() + <span class="built_in">static_cast</span>&lt;<span class="type">uint32_t</span>&gt;(n)&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! Transform a WrappingInt32 into an &quot;absolute&quot; 64-bit sequence number (zero-indexed)</span></span><br><span class="line"><span class="comment">//! \param n The relative sequence number</span></span><br><span class="line"><span class="comment">//! \param isn The initial sequence number</span></span><br><span class="line"><span class="comment">//! \param checkpoint A recent absolute 64-bit sequence number</span></span><br><span class="line"><span class="comment">//! \returns the 64-bit sequence number that wraps to `n` and is closest to `checkpoint`</span></span><br><span class="line"><span class="comment">//!</span></span><br><span class="line"><span class="comment">//! \note Each of the two streams of the TCP connection has its own ISN. One stream</span></span><br><span class="line"><span class="comment">//! runs from the local TCPSender to the remote TCPReceiver and has one ISN,</span></span><br><span class="line"><span class="comment">//! and the other stream runs from the remote TCPSender to the local TCPReceiver and</span></span><br><span class="line"><span class="comment">//! has a different ISN.</span></span><br><span class="line"><span class="function"><span class="type">uint64_t</span> <span class="title">unwrap</span><span class="params">(WrappingInt32 n, WrappingInt32 isn, <span class="type">uint64_t</span> checkpoint)</span> </span>&#123;</span><br><span class="line">    <span class="type">uint32_t</span> offset = n.<span class="built_in">raw_value</span>() - isn.<span class="built_in">raw_value</span>();</span><br><span class="line">    <span class="type">uint64_t</span> t = (checkpoint &amp; <span class="number">0xFFFFFFFF00000000</span>) + offset;</span><br><span class="line">    <span class="type">uint64_t</span> ret = t;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">abs</span>(<span class="built_in">int64_t</span>(t + (<span class="number">1ul</span> &lt;&lt; <span class="number">32</span>) - checkpoint)) &lt; <span class="built_in">abs</span>(<span class="built_in">int64_t</span>(t - checkpoint))) &#123;</span><br><span class="line">        ret = t + (<span class="number">1ul</span> &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (t &gt;= (<span class="number">1ul</span> &lt;&lt; <span class="number">32</span>) &amp;&amp; <span class="built_in">abs</span>(<span class="built_in">int64_t</span>(t - (<span class="number">1ul</span> &lt;&lt; <span class="number">32</span>) - checkpoint)) &lt; <span class="built_in">abs</span>(<span class="built_in">int64_t</span>(ret - checkpoint))) &#123;</span><br><span class="line">        ret = t - (<span class="number">1ul</span> &lt;&lt; <span class="number">32</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用 <code>ctest -R wrap</code> 进行测试</p><h3 id="tcp-receiver"><a href="#tcp-receiver" class="headerlink" title="tcp_receiver"></a>tcp_receiver</h3><p>实现tcp的接收端。</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20221119213414108.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221119213414108.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p>要求为：</p><blockquote><p>In the rest of this lab, you’ll be implementing the TCPReceiver. It will (1) receive segments from its peer, (2) reassemble the ByteStream using your StreamReassembler, and calculate the (3) acknowledgment number (ackno) and (4) the window size.</p></blockquote><p>需要实现<code>segment_received(const TCPSegment &amp;seg)</code>、<code>ackno()</code>、<code>window_size()</code>，具体的要求在文档(<a href="https://cs144.github.io/assignments/lab2.pdf)%E9%87%8C%E5%86%99%E7%9A%84%E5%BE%88%E6%B8%85%E6%A5%9A%E3%80%82">https://cs144.github.io/assignments/lab2.pdf)里写的很清楚。</a></p><p>总体还是很简单的。</p><p>需要注意的有：</p><ol><li><code>ackno()</code>: 对于SYN FIN 是需要单独占两个位置的 如果SYN出现了 需要+1 如果FIN也出现了 就需要再+1</li></ol><p><code>tcp_receiver.hh</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TCPReceiver</span> &#123;</span><br><span class="line">    <span class="comment">//! Our data structure for re-assembling bytes.</span></span><br><span class="line">    StreamReassembler _reassembler;</span><br><span class="line">    <span class="type">uint64_t</span> _abs_seqno;</span><br><span class="line">    WrappingInt32 _isn;</span><br><span class="line">    <span class="type">bool</span> _syn_flag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//! The maximum number of bytes we&#x27;ll store.</span></span><br><span class="line">    <span class="type">size_t</span> _capacity;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//! \brief Construct a TCP receiver</span></span><br><span class="line">    <span class="comment">//!</span></span><br><span class="line">    <span class="comment">//! \param capacity the maximum number of bytes that the receiver will</span></span><br><span class="line">    <span class="comment">//!                 store in its buffers at any give time.</span></span><br><span class="line">    <span class="built_in">TCPReceiver</span>(<span class="type">const</span> <span class="type">size_t</span> capacity)</span><br><span class="line">        : _reassembler(capacity)</span><br><span class="line">        , _abs_seqno(<span class="number">0</span>)</span><br><span class="line">        , _isn(<span class="number">0</span>)</span><br><span class="line">        , _syn_flag(<span class="literal">false</span>)</span><br><span class="line">        , _capacity(capacity) &#123;&#125;</span><br></pre></td></tr></table></figure><p><code>tcp_receiver.cc</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">TCPReceiver::segment_received</span><span class="params">(<span class="type">const</span> TCPSegment &amp;seg)</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> TCPHeader &amp;header = seg.<span class="built_in">header</span>();</span><br><span class="line">    <span class="comment">// 判断是否是 SYN 包</span></span><br><span class="line">    <span class="keyword">if</span> (header.syn) &#123;</span><br><span class="line">        _isn = header.seqno;</span><br><span class="line">        _syn_flag = <span class="literal">true</span>;</span><br><span class="line">        _abs_seqno = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!_syn_flag) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _abs_seqno = <span class="built_in">unwrap</span>(header.seqno, _isn, _abs_seqno);</span><br><span class="line">    <span class="comment">// 判断是否是 FIN 包</span></span><br><span class="line">    <span class="type">bool</span> _fin_flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (header.fin) &#123;</span><br><span class="line">        _fin_flag = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint64_t</span> stream_index = _abs_seqno - <span class="number">1</span> + header.syn;</span><br><span class="line">    _reassembler.<span class="built_in">push_substring</span>(seg.<span class="built_in">payload</span>().<span class="built_in">copy</span>(), stream_index, _fin_flag);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">optional&lt;WrappingInt32&gt; <span class="title">TCPReceiver::ackno</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断是否是在 LISTEN 状态</span></span><br><span class="line">    <span class="keyword">if</span> (!_syn_flag)</span><br><span class="line">        <span class="keyword">return</span> std::<span class="literal">nullopt</span>;</span><br><span class="line">    <span class="comment">// 如果不在 LISTEN 状态，则 ackno 还需要加上一个 SYN 标志的长度</span></span><br><span class="line">    <span class="type">uint64_t</span> abs_ack_no = _reassembler.<span class="built_in">stream_out</span>().<span class="built_in">bytes_written</span>() + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 如果当前处于 FIN_RECV 状态，则还需要加上 FIN 标志长度</span></span><br><span class="line">    <span class="keyword">if</span> (_reassembler.<span class="built_in">stream_out</span>().<span class="built_in">input_ended</span>()) &#123;</span><br><span class="line">        ++abs_ack_no;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">wrap</span>(abs_ack_no, <span class="built_in">WrappingInt32</span>(_isn));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">TCPReceiver::window_size</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _capacity - _reassembler.<span class="built_in">stream_out</span>().<span class="built_in">buffer_size</span>(); &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Lab2&quot;&gt;&lt;a href=&quot;#Lab2&quot; class=&quot;headerlink&quot; title=&quot;Lab2&quot;&gt;&lt;/a&gt;Lab2&lt;/h2&gt;&lt;h3 id=&quot;wrapping-int32&quot;&gt;&lt;a href=&quot;#wrapping-int32&quot; class=&quot;headerli</summary>
      
    
    
    
    <category term="Lab" scheme="https://blog.ryaoknw.site/categories/Lab/"/>
    
    
    <category term="CS144" scheme="https://blog.ryaoknw.site/tags/CS144/"/>
    
  </entry>
  
  <entry>
    <title>CS144 Lab1</title>
    <link href="https://blog.ryaoknw.site/2023/4/f440e1660a5f/"/>
    <id>https://blog.ryaoknw.site/2023/4/f440e1660a5f/</id>
    <published>2023-04-02T06:25:30.000Z</published>
    <updated>2023-04-02T07:38:05.799Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Lab1"><a href="#Lab1" class="headerlink" title="Lab1"></a>Lab1</h2><h3 id="stream-reassembler"><a href="#stream-reassembler" class="headerlink" title="stream_reassembler"></a>stream_reassembler</h3><p>实现一个流重组器，一个将字节流的字串或者小段按照正确顺序来拼接回连续字节流的模块。</p><p>要求：</p><ol><li>接收子串（由一串字节和大数据流中该串的第一个字节的索引组成），并提供一个<code>ByteStream</code>，其中所有的数据都被正确排序</li><li>注意考虑bytestream写满了的情况，以及reassembler满了的情况</li><li>注意边界等号</li></ol><p><img src="https://cdn.ryaoknw.site/picgo/image-20221116144212736.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221116144212736.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><p><code>void StreamReassembler::push_substring(const string &amp;data, const size_t index, const bool eof)</code>会接收一个子串，用_output.write()将串整理后写入，同时bytestream中可能同时调用了read()，此时会改变边界。</p><p>维护一个buffer list保证buffer不重叠，当data越界时需要裁剪。同时在write、插入buffer list时维护3个边界。</p><p>一开始我的想法是维护一个buffer的map，在插入新buffer时找到左侧已有的buffer判断是否重叠，如果重叠则合并两个buffer串，做相同的操作直到右侧（<code>index+data.size()</code>），同时还要维护整个map的capacity，并做裁剪。这样写出来的逻辑非常复杂。最后面向测试编程实在过不了所有测例，在最后折磨了一天后决定重写。</p><p>其实可以直接用capacity申请一个buffer的列表。没有字符的部分相当于字符<code>\0</code>，在插入子串时只需要计算出start和end的index，然后将buffer表的这一段覆盖即可，这样做就只需要维护unread，unassembled和unacceptable三个边界即可。在理解上和实现上都简化了太多！</p><blockquote><p>tips:实在调不对代码时可以尝试检查前面lab的代码是不是真的写对了，比如把别人的代码copy过来如果还是过不了test。。。不然就会想我一样调了一天都调不对</p></blockquote><p><code>stream_reassembler.hh</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StreamReassembler</span> &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// Your code here -- add private members as necessary.</span></span><br><span class="line">    std::deque&lt;string&gt; _buffer;</span><br><span class="line">    std::deque&lt;<span class="type">bool</span>&gt; _flag;</span><br><span class="line">    <span class="type">bool</span> _is_eof = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">size_t</span> _eof_idx = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> _unassembled_bytes_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ByteStream _output;  <span class="comment">//!&lt; The reassembled in-order byte stream</span></span><br><span class="line">    <span class="type">size_t</span> _capacity;    <span class="comment">//!&lt; The maximum number of bytes</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>stream_reassembler.cc</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">StreamReassembler::<span class="built_in">StreamReassembler</span>(<span class="type">const</span> <span class="type">size_t</span> capacity)</span><br><span class="line">    : _buffer(capacity, <span class="string">&quot;&quot;</span>), _flag(capacity, <span class="literal">false</span>), _output(capacity), _capacity(capacity) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \details This function accepts a substring (aka a segment) of bytes,</span></span><br><span class="line"><span class="comment">//! possibly out-of-order, from the logical stream, and assembles any newly</span></span><br><span class="line"><span class="comment">//! contiguous substrings and writes them into the output stream in order.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">StreamReassembler::push_substring</span><span class="params">(<span class="type">const</span> string &amp;data, <span class="type">const</span> <span class="type">size_t</span> index, <span class="type">const</span> <span class="type">bool</span> eof)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// size_t _first_unread = _start_index + _output.bytes_read();</span></span><br><span class="line">    <span class="type">size_t</span> _first_unassembled = _output.<span class="built_in">bytes_written</span>();</span><br><span class="line">    <span class="type">size_t</span> _first_unaccept = _first_unassembled + _capacity;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= _first_unaccept || index + data.<span class="built_in">length</span>() &lt; _first_unassembled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 裁剪字符串开始和结尾的index</span></span><br><span class="line">    <span class="type">size_t</span> begin_index = index;</span><br><span class="line">    <span class="type">size_t</span> end_index = index + data.<span class="built_in">length</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (begin_index &lt; _first_unassembled) &#123;</span><br><span class="line">        begin_index = _first_unassembled;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (end_index &gt;= _first_unaccept) &#123;</span><br><span class="line">        end_index = _first_unaccept;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 元素入队</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = begin_index; i &lt; end_index; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!_flag[i - _first_unassembled]) &#123;</span><br><span class="line">            _buffer[i - _first_unassembled] = data[i - index];</span><br><span class="line">            _unassembled_bytes_size++;</span><br><span class="line">            _flag[i - _first_unassembled] = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    string wait_str;</span><br><span class="line">    <span class="keyword">while</span> (_flag.<span class="built_in">front</span>()) &#123;</span><br><span class="line">        wait_str += _buffer.<span class="built_in">front</span>();</span><br><span class="line">        _buffer.<span class="built_in">pop_front</span>();</span><br><span class="line">        _flag.<span class="built_in">pop_front</span>();</span><br><span class="line">        <span class="comment">// 为了保持队列容量不变需要在后面添加空元素占位</span></span><br><span class="line">        _buffer.<span class="built_in">emplace_back</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        _flag.<span class="built_in">emplace_back</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wait_str.<span class="built_in">length</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">stream_out</span>().<span class="built_in">write</span>(wait_str);</span><br><span class="line">        _unassembled_bytes_size -= wait_str.<span class="built_in">length</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (eof) &#123;</span><br><span class="line">        _is_eof = <span class="literal">true</span>;</span><br><span class="line">        _eof_idx = end_index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (_is_eof &amp;&amp; _eof_idx == _output.<span class="built_in">bytes_written</span>()) &#123;</span><br><span class="line">        _output.<span class="built_in">end_input</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Lab1&quot;&gt;&lt;a href=&quot;#Lab1&quot; class=&quot;headerlink&quot; title=&quot;Lab1&quot;&gt;&lt;/a&gt;Lab1&lt;/h2&gt;&lt;h3 id=&quot;stream-reassembler&quot;&gt;&lt;a href=&quot;#stream-reassembler&quot; class=&quot;</summary>
      
    
    
    
    <category term="Lab" scheme="https://blog.ryaoknw.site/categories/Lab/"/>
    
    
    <category term="CS144" scheme="https://blog.ryaoknw.site/tags/CS144/"/>
    
  </entry>
  
  <entry>
    <title>CS144 Lab0</title>
    <link href="https://blog.ryaoknw.site/2023/4/c97217e90828/"/>
    <id>https://blog.ryaoknw.site/2023/4/c97217e90828/</id>
    <published>2023-04-02T06:24:30.000Z</published>
    <updated>2023-04-02T07:37:55.450Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>cs144的lab文档非常详细，非常详细，详细到每一个都有10几页的大小，像一个仓库的readme，<del>以至于菜狗花大量时间读机翻却没看明白到底要干些什么，这也导致在开始lab0时根本不清楚自己要干些什么</del>。无论如何，这是一个很值得写完的lab。</p><p><img src="https://cdn.ryaoknw.site/picgo/image-20221116140320977.png" class="lazyload" data-srcset="https://cdn.ryaoknw.site/picgo/image-20221116140320977.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="></p><h2 id="Lab0"><a href="#Lab0" class="headerlink" title="Lab0"></a>Lab0</h2><h3 id="webget"><a href="#webget" class="headerlink" title="webget"></a>webget</h3><p>在<code>webget.cc</code>实现一个webget，实现访问外部网页。</p><p>需要使用<code>TCPSocket</code>和<code>Address</code>类</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_URL</span><span class="params">(<span class="type">const</span> string &amp;host, <span class="type">const</span> string &amp;path)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Your code here.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// You will need to connect to the &quot;http&quot; service on</span></span><br><span class="line">    <span class="comment">// the computer whose name is in the &quot;host&quot; string,</span></span><br><span class="line">    <span class="comment">// then request the URL path given in the &quot;path&quot; string.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Then you&#x27;ll need to print out everything the server sends back,</span></span><br><span class="line">    <span class="comment">// (not just one call to read() -- everything) until you reach</span></span><br><span class="line">    <span class="comment">// the &quot;eof&quot; (end of file).</span></span><br><span class="line">    <span class="function">Address <span class="title">addr</span><span class="params">(host, <span class="string">&quot;http&quot;</span>)</span></span>;</span><br><span class="line">    TCPSocket st;</span><br><span class="line">    st.<span class="built_in">connect</span>(addr);</span><br><span class="line">    st.<span class="built_in">write</span>(<span class="string">&quot;GET &quot;</span> + path + <span class="string">&quot; HTTP/1.1\r\n&quot;</span>);</span><br><span class="line">    st.<span class="built_in">write</span>(<span class="string">&quot;HOST: &quot;</span> + host + <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    st.<span class="built_in">write</span>(<span class="string">&quot;Connection: close\r\n&quot;</span>);</span><br><span class="line">    st.<span class="built_in">write</span>(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span>(!st.<span class="built_in">eof</span>()) &#123;</span><br><span class="line">        cout &lt;&lt; st.<span class="built_in">read</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    st.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;Function called: get_URL(&quot;</span> &lt;&lt; host &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; path &lt;&lt; <span class="string">&quot;).\n&quot;</span>;</span><br><span class="line">    cerr &lt;&lt; <span class="string">&quot;Warning: get_URL() has not been implemented yet.\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="byte-stream"><a href="#byte-stream" class="headerlink" title="byte_stream"></a>byte_stream</h3><p>需要实现一个可靠byte流。</p><p>大致需求：</p><ol><li><p>需要限制缓冲区长度，在缓冲区未满时才能写入缓冲区</p></li><li><p>字节流可以无限长</p></li><li><p>它是单线程的，不用考虑并发</p></li></ol><p>无非就是维护一个bytestream数据结构。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ByteStream</span> &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    std::string _buffer;</span><br><span class="line">    <span class="type">size_t</span> _capacity = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> _read_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">size_t</span> _write_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">bool</span> _input_end_flag = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> _error = <span class="literal">false</span>;  <span class="comment">//!&lt; Flag indicating that the stream suffered an error.</span></span><br><span class="line">    </span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>byte_stream.cc</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">ByteStream::<span class="built_in">ByteStream</span>(<span class="type">const</span> <span class="type">size_t</span> capacity) : _buffer(), _capacity(capacity) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::write</span><span class="params">(<span class="type">const</span> string &amp;data)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> cc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; data.<span class="built_in">size</span>() &amp;&amp; <span class="built_in">remaining_capacity</span>() &gt; <span class="number">0</span>; ++i, ++_write_count, ++cc)</span><br><span class="line">        _buffer.<span class="built_in">push_back</span>(data[i]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] len bytes will be copied from the output side of the buffer</span></span><br><span class="line"><span class="function">string <span class="title">ByteStream::peek_output</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> len)</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _buffer.<span class="built_in">substr</span>(<span class="number">0</span>, len); &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! \param[in] len bytes will be removed from the output side of the buffer</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteStream::pop_output</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &gt;= <span class="built_in">buffer_size</span>()) &#123;</span><br><span class="line">        _read_count += <span class="built_in">buffer_size</span>();</span><br><span class="line">        _buffer.<span class="built_in">clear</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _read_count += len;</span><br><span class="line">        _buffer.<span class="built_in">erase</span>(<span class="number">0</span>, len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//! Read (i.e., copy and then pop) the next &quot;len&quot; bytes of the stream</span></span><br><span class="line"><span class="comment">//! \param[in] len bytes will be popped and returned</span></span><br><span class="line"><span class="comment">//! \returns a string</span></span><br><span class="line"><span class="function">std::string <span class="title">ByteStream::read</span><span class="params">(<span class="type">const</span> <span class="type">size_t</span> len)</span> </span>&#123;</span><br><span class="line">    string data = <span class="keyword">this</span>-&gt;<span class="built_in">peek_output</span>(len);</span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">pop_output</span>(len);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">ByteStream::end_input</span><span class="params">()</span> </span>&#123; _input_end_flag = <span class="literal">true</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ByteStream::input_ended</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _input_end_flag; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::buffer_size</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _buffer.<span class="built_in">size</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ByteStream::buffer_empty</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _buffer.<span class="built_in">size</span>() == <span class="number">0</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">ByteStream::eof</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">buffer_empty</span>() &amp;&amp; <span class="built_in">input_ended</span>(); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::bytes_written</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _write_count; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::bytes_read</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _read_count; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">ByteStream::remaining_capacity</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> _capacity - _buffer.<span class="built_in">size</span>(); &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;cs144的lab文档非常详细，非常详细，详细到每一个都有10几页的大小，像一个仓库的readme，&lt;del&gt;以至于菜狗花大量时间读机翻却没</summary>
      
    
    
    
    <category term="Lab" scheme="https://blog.ryaoknw.site/categories/Lab/"/>
    
    
    <category term="CS144" scheme="https://blog.ryaoknw.site/tags/CS144/"/>
    
  </entry>
  
  <entry>
    <title>向这狗娘养的世界</title>
    <link href="https://blog.ryaoknw.site/2023/2/7e899c277a7b/"/>
    <id>https://blog.ryaoknw.site/2023/2/7e899c277a7b/</id>
    <published>2023-02-26T08:56:50.000Z</published>
    <updated>2023-04-02T07:39:21.747Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="抱歉，您输入的密码错误，请检查后重新输入。" data-whm="抱歉, 当前文章不能被校验, 不过您还是可以看看解密后的内容。">  <script id="hbeData" type="hbeData" data-hmacdigest="2b724b68873b7a4315706a0bff5c3e1cc7e85b36e129837c49a37d5f7d934c37">688c91111db14f9d3aa396aa4128ccffdacdbe782570004c361f8b69f19568aeeeadaff6c616a36466967f4aa1a0a0541960d207ab8a56812ebfb99e843497742848826da20fefa43941c2853ce072323a7e60b2c9559d04c588a7552a5530ee3889a60a36503823ec713f283d04817a3b749f04c92a972c7e7a8dcfb81a4a6a7172b07c75c599cd90020bb7fb7aa784302b8a8e8af36df4e97cf259725f0758d3aefe0dc89bc726a1b0ff4cdf3f4faa30c4fd392b2491865d5e85402cefa43acd170a42cc49d67ba4747a931bca1fdb7b41e1731dd443c1e18e273648c845686c1fb0fbb325f8320097076347b7a41c8d88e424a5e2f637e5c2e370a77ad436840fb61fe7d2203e9047f9382477e81e3cfcc84dfd6bf096152c61a8231d130cfd6f96181d3a75460696d9156ba828d1955f881e42f33967a2a6d94cf8885ab396726c4e5dc14a112d2b5ba8b155a4dbac73f874e8d5e0b3ad3773f60f4fd4b99c0ead70780d146b0ad8815c648b967b92a5000f281b5ffeed6e9b12a79c27dc9fda1403c9c8e1d079eca4d241da2d7be8903947522f48497bc459b88fa8236848ff547d43d99c4b0bf7f7c663cbd50373651f7e438107a465eb9c4a356038c218de855385d207d9850236266a54b88c04e51f15e3c7563757cba571879de170fccd457b6dd4bf3fd0010798a07f6490dea2ec367ab9053ac9902417bd067d9d7e7fe1ea82e7e77f752d94d85b770eccba06bbd9398099a8ada08e449f90ff8d95a85e3fdef0dab66f4540033c7325c93b600fb46896fb8df6ffe02af3b99cd34ba1f104201f1ac2bc534590a74cba0063bd94e60ec64df3b4548f9805c97aab4bb75a62323fc38de12699db59ab79cca48574d457b66cdec08bcb5604a30150acf2713bcc44e11f90f850c5285735ab46a1b645098ff8acc96780abc2a8d68d07293724fcef0ab0d85dd3384997f898d0e426f1d73d2214f4bf7870fccd8fa5b60a57ab69b2227a39c668f9fec735ab82e2e8f5cd890097cc4c8961c61366017e0c60a313c4fff6477894e9bbb8729beb84f604dea2d9b88a1920dcde8b0cf89169b456459edf54a65d8e3a4472cc894781d686bf54d95f8e67385be8e7003b846a04217609aec65d6dc6fe8b232b97fddd4f6ea1a4a671ecf89e79d9ec7982cacb142a6b1e918349d780de7ee82dbebd0278a6c6a08b379f1149fee6f7d2fd5838d2199eae2eac771278fb872f3dc04edc0884f3fe1efa84dea2f630631a1aa20ee552d2795872b17498a9191f257e5accf64f12d10f1d7076978e84b2b120d457e3a43adba8f6a21e5db6f65de89a8f9aade32400cfcc860ea6cb1deb7eb613cd843c878e495e0a168ee7d06610a950cdd38eb774051ba709c6c4bcae1b1d0a5ee2cad40713b608c65dd6bd5f01a6a26ab016b60e80e3a88a2bc770fdc1d9a19d03957e449f6b2aeb8860dd5e4bfd41759a9f361c11c9bbb6254bdabe60fae78025c17fa8e477f0ca0468f04f41092052d6c574176d3b57217144ce9126ff727b89ed8b27c4f5e2f133b3c3a168b671a4bb23b2544e47082dfc30db6d094de5cbf574aba8308e0d99a834e589126b1e56f9b282c28b330bb883af10bd511a9de5f8cbe275aced1a36e8d94d4b7f95c922956ab3f7a3ad5fe5b25412130028f1e3c72d9796de840514c322fd44e34327af30ffd35791256c4dfe4773b16a577e48365cc74fae7eccb62091cee796b9bd7829f40184270de27ba5c8b3574375b9effc0c52d25e906276aba95bfaff8c4f52ab90006f256155b3057ef208742fe0ba82967ce35abca9265a056b58176a7d15e5c079dbe4a5137a69f9d0c7f281af7835490a0bd8329590e9635c92c96dc0dcb494e7d12c4ebb60abbe173ed67488b7fee843ff486e5283242c57e1cfb67370ff1e78779621c5b12d8a3519c7b6b0a7cf703add8f23ad043062df6a744968f91aaa99dc1ba055367a975d3083c75b18fa356cfc5824651ecd029fb9271be62e647d5e0a4e889889d5c88d56e1c925176f70d4441930d76e5962a711f5b8caffb641f208a417a0867a07fcd7d8ec88aabc655c7dad853bbabd7f457ad51007c885ed7bd4baa5d07d993a98fc819d6bfb1642491d4ae15b23073940880ca86100a6ab58c475e7d15500ae38a2539cfb947d422270fe69ae743e0961c2f395be4eed3f093b45aa32e66b6bdc895280fbd43998f80dd9d0e7e9e6f59dc3e981d09ff13a86d10b3b83509d392cf3e1200403c334179d9c8282fc27e7af0ae3324deb2432e5998921b7bdb269281635dd16c3f999f0adabd9825554c97417f99151813e6cb7d66df2ffbb0bcd6794214717997f527c619dc3e0bb0ba038f5a84551b6d567f81fe40c74b42d32b55b8a5249e7f614f61633257167dbd79e529bb829907f9b0296b322fcc90d65a2ed16c7686be1f4888175a694b59ebbf772b3cf251323bf616fb4de01d288a3d83a225d035cbcca3e43097ba1d9dd70a645043db3c46240381a01015f1c97895fc0d35c670d76be4ac94203fd7d444d36b0d58a37bb0405a1ae4ea71f8c49b0a24dbea7039e599bc2a49cb8c68f97ddf127ddc4fef182fa6523894904793fdfee30ded8602daf2d626b08acf1ab59152395591623509e29fb65bbbe94885a14c806f4f1f086ffb0aa6cffa5b7c519968bd18fde006778ff869cbd85f33a1457fd308d36e1b09419c1c22cd0c096f0cd4425612efedb5d0cfc887b4c4c581fc0bb1d37940508b14e3f1ea3c1842349574cef8d8562e1759908ec98bcdeaa580b9663ff0b8c3d1377520da1e35ac1fcd01233ff791c3ef885ccc87b19e1750a7640fbc6a47031e288121ce69efb5de9e1ea98c2fbf624973c9f9fe151b81ed69f5316b3c6630ecf402e0446927cfe5d6b6c7c35b5addf209b9b7941bab060e10bc89478bc47614771fe05be045b4511934209e8313a802f7e958c074445b8177988f087b11dce647494c75704e984225491ed95bee058eba1107e826b07b30c6b5df342290467b020c081e56d20e948d5ebcb285f33773d29fa22de001a44c280752bf418cade93cdc3c46cb6035e3f6c910d3b9fd789807e68669d5a9836b32215e5dfeb67e2d1952d1ea1997f798397360d8cdebf2455ecd6aa94d0ca82bac22ddaaf568f14734dc617e7544a15e82fe3d9af94a66d9f5663d73bdb1f2f58ae3b50fffe5228fdb9408b1e869c486385aed1fb4f0afe75b647280cd6d2563efcd4defbfc14e87ef2593e1a3f1c1d8e69622a15d044b68234095557979f29cd7b7b6e8ac16c203cfede481a98034f4802c18c89ef06deaa120af9d88aa099b71563f96e6b62ee6887b3be5749a0b07f4c262aa781918f676383655b2e91bf63ec3c0bf0a13cb2bcfbb4aa3ef89b528939ac70f19f5ecfc363fd015ba916afbba0e4301c5cd92de6fbfe204ec22740cd095e643788d53aabd40f5ebcbfa6f2344038d9ce109b5e87be46015acc7dedbe3fc38c3909c222e8f7e38f7bc4ead9eee60c9df7baecc5ac58d17c909759bac6eccd2970736aa57012a5d3e9d377d3dfd4fd28910d147c2d1e487650caf9dfe162706b6a49a8bf866371918bcc7408d3040df3041eadc3030c8e37f36e1e4145d81da75e6aba6391e675e2a1821b7d58838cf5fe53ec30c3e13346a9affa506d88125df93a9b78affae751dfa74f7c668ee8cac51d4fd913a702314ecd0b19927ec697ae0f241699d433d4cd67d1753aa40014152d3c636aed752d13b31b538034ca4a98a46539da0085e6d0dc52768b3cad183a0001e6477e226590969d6b75936c2a6aeedea51d4e9243d642f311bc75d57321bdf197e9aa6a0a92ea6293edb1de8b734facce373d339cbbb9a33aae119e2838b1123944487b2828ce8ccc9435cdaca33f95ae6dccfd29f17b7dfd0c5e8660afafd688ecbadd2b78752b38e125c85401caec0f7372767f1f96f20cc52efb4d2c6413ce594a14d50cc71df755ceaef7bed9ebdf6293d9dfa9c7ffc8ef1903c6c12147d0f8368fdf5ff876e0b18d0e75a1d803b7d8f26dd49eba0059f394bdb7e07d3ef5d6d490e6ee7d307459a0206e39233589950b476b195ba31c5d3b47d7dbc4f56b10d19124ce5348ebb47fa7c482560a2231f4dbb077667a2a376adedf030bb3e85745e9a4b202d0995f03aab0b38b217e77cf3f11030b2dad42f10301209fcc217548a4529a151257037117450405b32f2dcc32232d9b7944dac72ae090db254134107c032258167080e555df52dcf39a15c4639ebbf4f3688a391409695f39dda4ceb2141330b771b881fb9fd48d81efd659bbc5bcced5a360083e09e625a6b2bee797e3b867ce21740462782e4482f5dd36e4ebc49f5dafae9374f18f943331d9d8837353771c5a448f8cd85969a1e2021982f2bdfc19fd56c6f49fe4088d49fe57bf8440faa88e83ca41f8db39a1fa267aac69c4e163e3fe2bbc3aaa06852cde374fb9a01134d47203f782b033e1dcd575c06cda55d739b1f5d22038a17a5f00b25e4ad5c0521b2e9eb7f4436cb0c7b441233c69c8e40af3f692e937666b1577d1c3b3dc367c8a694d5ee79d6c04a2b545a909a1c27609d110209d0c27be029cc6e0d0141147339ddeed6579d81c15205cbb88f64e313c03580157a2abe76f64be2af24749c964158f4aa33592b37e7b719b47cccf5f56426775102bd2c8464ebc17871d20c0c7a4a5be68c4b68b116a9f566bb7491d5a4b8783aa66c5ca88b1b4e0865c4de42345a0e08fe62e166863b8caece8575449ee2c5f61e0b98b99b06233762d5cef9b999b322b7f081f6f9670c9ad23b5f6f9143c4d1d9c5c221e7b7abcaaaf2e39d95b117887c85e38982238c57d49f01decaab6659c060a697fbed221d7cc8391444cfda0ed491e5e4cb20beabe7cc3e74fcada5148ed4726157ae41c3fcc6b3d19ff830a6f613e64e6306d8684168994dda1026ebec21122d72e2e7a100d5a16bc75a9ea12afa062f6a5bdf13045235effba5c048cde334d5b15aba0b570060b857e338db8374162eaf55de3cd9693541355a3d2811c09cc2af2c8439754ddb870a6b738c02f1045be89fbc1651b32218485b109919156377f24584025c16b77d81ac2e17a230dff4860bfb962cdfa93528bcd4c38a6a17d2275a1d662d71c3fae4ef1e92f26e2904664fb8c3bfa16c55a30d767150e3c9541893b793aeec379cac1f3da29f90ee548f4a0d6027e98d2ebd102c5e42d0bba1de46c5acfe8397be29f00cc88a85181486074b85813b3776d8a600f5870c5a08b34d36dc159533091097356e4645f43f78691bb8edc8f7823381bea0b3071882c4c84c276c639009cfd3f2a486248e57b2f7596ffb856f2148790a71f1c30aaabc204d1e3b4310f86559d5efd50ac591f388097c1a3a3763032a4404b68c0c7a798e415542cc3012dc70836ed5e0e9be174ddaf2ebed57e108e9cb2adb2bd604899cfbf9172e5353008c47f5a28606e0d7aa1cb87e0b3426d08b7f255e88c6666b324ea7853825b054c9ca3ed7681170a5cf8a76c0ff509efb2283c582fb877fd232cf5ef522cd01ecc9475ea6d853271badc708be7b60aca30886c6a48086f32a24b881153eec6a443b87863ef017614198fb302d816ad5d374fe11dc4b882e95968e58582faf0354f90d9996f0cf52b5cec03a6c8d710b57ed0cbb153fe9b546e74bcb5b3c76049142dd428d44e4db76052d766d18fb8f895795c7a25e5b89de9bea3eb231574bd40ddac22416154d981b856e47760b3e1f0f326f834177deace521ababef6f54320d8fb4bd4099f4248377ba6224d36a93f023defef3373f33322e6af1f79cec0f87fb5cf1340aa2509c719b4a63a85e0b62ae7066f915fc08b049697889e208b28c2df9187d2cdd87c9c1e696ff8d873c0c0e1eed1d2063825c6ee09c9eb09b8316d541e4d55d638f201a55fcab094a1e273914cb6531fcb2546631a977c4c0aebdcf90182667c76b113718a2e2eabd4eea03e01d2398f77ac68d0d3f3e0a55993813d74916e283f58252b09bbe5f10bd0287fba03054228a0013d145d9577f77009f02dec8dd53cbedbb8870af62e52c04aad8ae7c5a30d055e9df31b6930b4949578e209983d67d982126999019e58ddec9507ba567acecfac4ee8672680f6f9522bcd1d443cf80fdff62edddc8b17d32485662534257d6d952268932af29fba7e9bc46a9f4ba3f60434544c06a2d7e04a12b054a04febce8b361a26f02a4ddde7171d86d0b6f0689584834859d18106181e7d65d6d065865bfee6a141319b8a34582a6c7602139bc0103f931de99ae94729b0a23fa7facd0e032033dc6f0d77cb6c70c48946b59f2bd81fbcaab62bc27395c6b7dc9b44e1c652f963eae3b93df412b6d1c2e456fc1cf8f524eb94bdb5c2a3da15d662a90c72c5e4690764a0751a8ee227c849585697ec04dee202537671992af6a8e957e97bfb4d8526e645f5d28b1651e8aead14bede03cd28a6bc86415a4e3959cd2e63b7a73a55fc5026db86b365359a90ce2752781104fee6f29edc40776d7d2a8a414781dc05fde9588b6dd10b34792313e420994474e93ddfce6b46730d98fc6efb9a1a4ab8cd2beebbb7fc9300f722a06bdd2ad65232926acf0b400c7a16a29d0ce193754c57a1432f9b26dd83977d4da598d14fe1fc5813022779fb4461453cbdf1bc643b82d08729c8b01b8197f06e94f9ad9398542a827b4f2ce6d06f505d8911c392c3f79247dd51d750ba6493c75fb6aa9fdcd817cac1ddc75febe6a107475a83356d11c87c2ce94f6542126e3447c57cf70ca6f6b369c18dffc4710054f3aef4c0879214c26326515f061955ea64c9fef7df2dba609c9dd4c4070450c809f371c6540484c38dd0a6401e342e1858abd42b5f63ca228f5fc066137e3b4d914773bcdbac7cebd9bb0815d9e1ddb2d4f576adfda90000222a89c5557df2bbb11119e0de063a5fd6691cad3f062cea55551a80b7b27056f869017fa7b2026ade8fd921e50bbbf8a2d30fd3206deb9d4caf71eaa3cb8643b51133abc16ec4192f40cffe08c3633dc26d01cfb34e2531f470e702451774f60cee78a5b5ae116e30139ff3c3d9cb9a3bed794de78c35ae85515bbb7e6064c4f6d856b35ba186f62d114a83cad903edc3e7767614acce40fc575d8ce9a7e59d35d35215bd056fdeca0294c798a62089f9e90809e87fd938f37bf605722fdb5da754a6f389ec6eb61b32c7a82bac06738abb20828aa06507d44c5498339e82b85f37456629103e43eabc23dd987f0b0c228427b9ac4b73149f12f47b847104cfb93226cf867c6ba008cdcba8548355806c7bbca1c8994ece7f1776be7dcd1857d5feb2f0a89af007d11a90809d2f3e728df0aa4d790122d89dcd4f3422bf302289fa177741d6c36839128112599d25ecbaa9cc592aa939e83d9ac3d137b8125504b769aab272f8c70fa465be5eeccb5f27685eb23ae116cc919311d6869998aacff6cb28a2506d1ad4f4e0b18197608bbc86cde923bef36121d1ee89b98bbeb82ab2a34440036ac888bce404c12c0c66c593e9e651d9df3ffaed571bd1d6a4f8b93f0436b38245dde2d08913dc07359e967087952c2c239d0a05d6181452c30b433a16a8ca71b374d9116f88a3477e40343af58cfbe66268d7f793a8af40124cdcda2a1f55836a6a1977980ff1d526636954421f01cd26aaf1ced42ab958c7aea235c1a68d081d9a94a2979090b2a37038889761b327cefd8c344a4c39f36e0f4f06ee201eca99f4dbbafd5fb7cdc9ae46ca098ae141e419e426f07945e03e3990e61a3c2e4b48f2005738a800ca37ad0068a28391e6061e6ae623f7b8b7685ac422129f9f54294ac36bd3b86d8e3d2a5607767bd954aedd9e19acdd2c25b308d229095e76b4cfea0fed0b202206142356b4588ff5ff5379b98b5f48fd43432794083f262722984809863c805a5a3b0a0b78234b61e5d94db7cce0ac0cf565e0bf847920cdfac04eca20225bb18e1992605c01d90dc19b64ed6a7ec02970fd5381dcf504d368b0e5d6bc8aae2e59be9adae86014fcd770bbf096825e75852c2a82e57f10aa63e55d5b5c6c57d158131488945a63c9b3a924cf642fe6e1b29f7ff54a4028b0aba8184063898fdb452b18c869a4e9fe034a3040541171f2edbe718f12a9ef0b720c913821e4196b9716d722b4ef4791a3f7ac9fd3cc5f25f2d7eac91bec6633a1b75a468148b9e29d1690bcd19f48a16407eceb0d76251c99ce2eaac18de80cc933df52288f03e3222a77e2b1e8de47f9f1969b371ce52dc0efcfad37502364b6242dd96168ad2bf8652d9447baa8569a203cff2c7cfab08910a1f755ef7b25141a256ee8ee6b08269fdf08392d2ed29cc67d783bf2832e1c005452ac8de8c6272947c4692fb4118f547096bc6c50ca0aba56ea38f7efb72bc19a3088f3d9e51e9e131cf32cdbafe59275f724451f33ff65f5ac0f656738bc280cfb3f9ac24d04e5955c607c0060fbb84493938766b8e3afbb5226dac6358c7b560d47e5316591bea1b668701bd8d95d2cde7db69f7dcde99c2ba7f2a61f54052df4d6f4c8e789b5cf569bfc2f7f454f7051bbd2616d4ed2c2aca5f781a4d733e7abd8bae9189f4305e5d82ddd85b24f86419068957630da33dca436c664cc814c70b5318ad7698056a0e19decbf157b934392ebbc1fe0a9790cbaf7d50a5e68d105bf82af14ca16944663dac6a68a0e54a6261ad16a4365d8a84d2048145ac7495365a023588a8f7626f70e2c8995b7cb94610714042708a7d6f06da46636de3a4feb29d0114685219eacf174c54dc36bad75d99486c1edec1a4e6fc64ca98ea0ef187fd2dadcb4d450378f9a1ace265aed295efe1503f44a83d323d3ce177c27f8995545775ebb13ef8f32218c3e67b0f124f83a3d1042741c6ba1451095f5518bfd7de7318714a6a74cc692238a4cbc8d974f8d06ac8cc03a1cd22c141f8780c6354a84f3c042fb9ed96976d2f6492ca41a2d83793327559a5c44a7a765a462e720818a9d0be2def48366b39b5bca5b38aed283df97ad276b78252eb74a0894b8e797251caf8714fbcfedc5062a67afbb63577c2f3e9c333092314faa2523c3ac28a307bff4cd5e41f1523781d7d248e49f0af125a1ae2eb8dcbca4992651ca4253e7957508819bff9f06f73cd92a1f1fd7ef0984877625037e7cbfd4a1bc2f5c12fe171493d50fa191712f9940ae2f7fbb2fc87ca15547a18d602f9a7740a502d160164faa9d0b953e4d6d8da43b556c703139b5d3e09a6b9aade831fb25a96b80fa42a3797503401caa11714d7df6a82ba7ab3713c2a5496a45d9858b32cbaed4ff906ac195a82dedf37f71ea7a2c385606d55a00d3894c801f379b63c0cdfeaaa19d15d42393aa708d11169989113db71734be2890fe76f6443bcbc8d8e83e74161eee6f32e35f6d3e7a290a6a1b01697f3fdf5042fb91db7f0f4d447a8aefa3bf4da5c4c78191a5a829de7500b2450bb2bb438dbfb70b04d4efee5ad625e3eb54cb3e81a25534e424aec20a778cebfc4e7b48672121ab4f07d91367c891b5cebbe8b85f7bca1e4f2ce4991d31a0d22dfe81950221d70ff1756d48cd1b364ccedfb8be290b925297df442bfa15fc1a3c2374fdcaa56e904b1a11d4424a7622f0f5e2dbb958d59ebdb5ee63fa31287332a5ef5f1a8dcc5a654a0a7b2d208e1ad57f8338a9b6a62252fa9adabff59b957ea12cbd9987f1f8de9522a15adc6f62c8367e7e6ede6f3b7b1eb2dbe1cb229bbb24c4c41111985a9cdfb17db68a00927905745f555e94c2d2080bf5b3361c8a1c7da39b13731ee2005b2008d87a816eeb689a22809638ca73d42233c6db9b4e9fca6cca288b403cd6faf2bfd49687d6a666db4cb72fedb14445a6ce3a18c63dd4902376237cb2bf96f6cf4eaf6e15835d7f519d2cd583d6880525225c03e37f02f64356ffa208ae97eb0ae52c9a81126f65e91c9139c77be8c48f61df690429a74530a9a9807e3c17f07d68afc931006aa6313e6f223cf7f227eecaa0f0e4614eea0a7a41b334a918f9370835508a9820c3527063c4fe026b90a6fc0ac52b176c6bb4b224e10d9c099ab2de3dca777cd75f28583ae5e6ae5e4b2be4be5f94a82f853f5957ee2e011a443c4291a467a25e609dfb6d61e4531dabdede9d00b1ebe51458d5ce9ba64557b51e15676bf024d99c7ce6b00eeee7d455c01725545b5d901ebd2b11401643d6124d84af79430c4acde6b714a459eb11464ae7bcfb74aa7f137052191b2ba106ee67e324961f5f52936646090748a7d914eb2749816833764fe8445e195f72fea591642bb1dd9639cee29def56025590b942e68c1d497a67f9ffdf314b306562aecbd274d48718016260862ee531a1b15ea6ed4d2585cebc835adb177ed313609fbd6b256219f70d4fdeaca6f5e96a64a0f163ed8f4f97dcc10ebc938f1d1e079e698e55e45d1ff98c096132557287b5a1c594c0692f8ba55e7e47ffb018335542ba87e3be795db74912bc0ea482489be08b1a83b9dc9b445779f3f66fc3e4159b5be34a714f91043c5e9c4ab73c31585c6755f7f9124fbfe9e2ea401c1bf1321243f7efdaaa7166919b19661a2663fae7a3ba5f5f9fee854271485b2adc81c21c22059132d9776fb180b04b40cb4728590f7b8e4eae3de83648952db712bd48ead2573a239021102b3e4cf6ba0f2dca171b35f517c3150d99b449945d9e003f2bc7b0ba543092f67cc37ee2de0545e80322cf9b238920b0462cacbc7a68a0d24c037eb2eb62f269a2089948b0a99c64096f3b0b8679e12174bf30a7b7a8f7b38f2a16f281970571e9fbfe131441ecb054cbe19a0220294f2a1863ea004e3fd110947d9d959ad104055fc60936cf75f5033f01c29aca9bbd84fe0941083c0626b9ee349bc8fc767c8bff9061b570d91525ebc1c8643261e45c9dbf41ecea16bd62733b3d17f7f4d73ae7ec4ffe31468be4df96750111d26eea6439745c08955c9da97ec3075f22a1eb9eb4a5e6d24fadb4c4c6e52dea3299b22a0a64dd8a09853e94027c3e8d7c8c9659b70aa2f8ba3a17ee614fbcb9b337815d7ffa8289082d0e139c94a4734f682f0dfca276f4669c6791afaef750044402cfc16e01cdb22e6a8680d707b52f46cffaf6dfcfd3bf0665decffe31c861b8afed963fd8c7451a347807157d367717dec33eeee9c7205fbd960ac4d0213098023d6f3c017dd2f99790059a3d42e3b0c3fece9c35c70d288f251f26f764515a9a3b7144ea90370c19bf1d95e87f901504806f11cffff1fb794fe11b9267428c274f24db5b33e9db59eafbbc3c99099ebafb7e5fb27c28221f6ab6ef6612d17e8f9e8c6b55f430a6d1d57f1d86af549d02d8f3d8ce37e69c9828ac821d80c52d50fbeba2eb58cb124dd57be7d9fce1aea28d48746e935c6e13ab941b1cd0e1a6d4fc21f6fb484bf7e92b2e11dc282ef20ec025c36c2099fdf7003dd1ed4acf601f57822aaffc36b609a120be71da2cbbacda25c23f5c8e3f46b3fae88bc7f6f0e9d6cab7c40ab989078fed53db51346c8da571bd38edfaf0ae09d0989c84754a91b2d6fd09ebe475f9b110f03b9f43ea9e4d8c456104c45190d0ccb417710854e826988cc327e8798cf91bd45a2297222e3a505be75aafc35f38c30185289583626cb26e03d7363b7b77eeb84ce03afd6c96d3ec74f0fd8a2591961335da61367cf9620e732c31aa1fd3e5537d6be47a0988d76110477c7765067e34dcce7177e2b605af1d4435a8f93c9ef76e638bb6d5d0c541d53b4c55d716777108c9a90e2363fac80111b8bbe4721214dd339b46d1a1876e5caaf8e4d41394bd9c19a910c7428775e313da7c4fc20265550a89ba4a17f3fbd51d6e4389ad9f2bfc7bc918f894510ce15608f1c689319ec2ad5c3cabd186a382ef213e3a86f9aaa1e9ee37f52e187f841fe23a08d8d5a540ad4500ab43bd0b98a6a8a60bd9cb5dcd7c2b8d3325ee4024808de9d2e558565b5c754bb2c0aae0393e857b9169ee7bf5616325b1eb5eefbb174d0913071d240f25bcb42e4fe43c3478ffb41982738a48854d4860a2f5d7551402139181fcaf57d80e2c8060e8eeea48045bc88e63beb15150a927a57b9729aab1dddbb785ee458b54aa5d09f065cee35716bacb483b248fc90d7fbd749f768239b68eeea5b15ef1612924ad34791405b762d83baa04ce783dc8fcfda8c755ea2efa7216a329aad514bd03dd0471ab1f3bc84f929705a1acd101dca37306a413ac8e4b3d0e869f93c303b6ed36494935d07ebfdb87c3feb1d25ce4fb2c962dabf679538cdb4b9c78f54e48bc93f988b30f1c8568bafda6ea2454446b19fa599cf65152f28626adab5ddc9ae47e62c56df2618b96db9473822d437204906f210209600a492e7803363fc483d4936222fac8c0ab3439ee9be53b4d8814033395439a6cb9c93b9a8ed4977e1b4618fd53d9cbbc73ec13e2f5561f7990ef63add918f4bc8aa3170aa80c09a8d5bff96f40aaed323841a7a16d0a30ff9adb62bdaa4da88161823bc02deb63537eca109e7b265d71fc3c11b33b06125f70c0680e0fe974987cb1048ffd405e92f16ead941f4d41f457261931363f801dfd0d54864609bab19510d0741ab8e0b2f1307468110bb6172d068f5adff0ac5b775dc9aa9e436b7f24f8b19196c0e3fa7ef0dc683ab4a4566f68f0211955d333e96d147694be384eb63c4ad9c717a6c9112c5190b5367382198539e8c811044b5df00dabd8562f056b677510159a7a3bed5da2e468110a9de4981004cf848097238441ab95df2dc541c6966e9fa9dba1a05ac6fd04ebabb7ca6cd17d9111577fbda68812da8e635caa414e983b102df97863910e1f6ad7c746dcb9516dc6e3b73cb56ae30d1ba3385981d6b03ecb1fb242c56e9abd7b786aaba8ada05c519c221e8487efa1c97af98ba7c6001bcd5ae7d0041984080bf0f81382728cef8dd9edaadbf3f0207e14090aca8d4aca80c7b3e19c1e6149b31c6c41d3dfe7fcf655684cad74438363c60c328da71d23910655953321c63985735acbb0efd579c2176f5038a53da31bc1f2465e8a187ccd7d30c9a9454cd42d211d896424b77d2a334df43a66adecba421e7c7ef8a1ae86c0e3299295e4cc0287d1aa1a73dc883b748287433fc06a591ca47a5394a2fea414c4a977d035dfedc01910a24bca2ddd16b630a0517b29a185e0b153313963ef89185e5425c1eedaf0c948c46e259b822818dccb8fa643c42ff9486e4e4fb5d119e6d27d56abaca181129c51df4e693168f4cbdcfad722aa3b4e9d1ccf6ed8649799d11cf5a76e4bddfb078bbb9bca9cb174abfd1c9980b6bbc33f76819203e4429d2edb0c3fd4bb01f26f642681b734a84d1ec43cc91247503dc0b5cf09f4f0a931846d6dee873ddea950f7423a3d61a26468403b38d5e2316c26184c842afd6c9463d9f0202cde21a19ad4c7fc0cdb8b446eb9f97c5cf0e47342c178667de95fb6f1efa8477ebfb239ed74d0c34dee1940ff96ed172ff027e41755912ced7aaf47f8b0adf76ad401937dc2fd600fef140a47ca8eb18a90ddbc55d51307d015050a4705668aad66f0d2d420c2ed695aba786d6a1344f5d0eeebce30e832c69e73ab5619777198bfb3c545901ba31b37c4eee3dd1cf26feb355d845e8c7d187acfc8cdd9c09d634cfc755d86b58767de0acd92edabb9ae8680569ff04360dd26e03a5bdcf44de3b25f7df8d3f3745e627dc58c5791426ed50fceea2ab69dbacec2a40331d9d5b4cba374b8404ce66e603d74c5185dbd2ece18586dc3283d0ae2a67aeaf918f9ad229c65db8301b25570e33273ee108ed28227e3ecb8588ea86ce04541d5eaa6781abaa20ce6c7c822440418bd70b8aaa10cafb39a3b38bc3df62abf4741c12ba3490276e93e1669d29bbfc9f23de7b2a80995fc119816e55a5baac09d03d4f8dc32249942c5591ce42056eefa130ee7332ee1f0ad685b669fcfb626b6927647e697ec63d3cb141f87713c73b8c5ada4d419493587843a3773ac3d14fee7abfdacb5fdb0c86947f1678f2be30b3a124e484f70f6b50b5e85f9147cda2732b918edc96a512c21192170c1f14492c2ade3e6d87648ba0e8347bdd5a0d996908291489611eb85b57fbf86e351e873b4ea9cd1d6c06aa7b361165b499af5a27d4e1be2ef4195cbf46e7de87cd83029fadf5aed2701d51fd0fd80492b1a0c9e173abd238eadcd79254eadb49c58f69913cb436b75966e9c5f8c1adadc70389a0fe4f78e2a09bfc1c510297ba5c2933deda0b3b447a86a709961c654669a0a6ca8cf5d7b69d70ea06149734232725bc9845fb482969c51eca24c722398e80e25085ab26e1a001d7a09c08c2ee18f8fea24d19245e6c3078eefae67091213322bb276305d4aea32c1cd703cba4a90660864928c46332598415f0f4d4ff9a0503a6d501d7f1685b404991f726b82d98856ad07fec7feb55691ea4e7a631536eb70b6c7edbd71ac5de3f1465f484d0ac0559697dc1caab8b0d391984de6344a4ef2dd95e9c96609fa58bdeb8b8e8f761bd1da31a03e73c7509ab6b476dc9b7e2a55afe727e6f23d65c3162591fe7802ab0c7007102ef4c8b63f324833804ba0a24c447ae8987a930027f340055c62db134e0c55d16f26033e0014e3d376ec980fd195da08c3f73f8d4fee50d30f0a3122fbb4603639db4f5b2d3c1d3b0daa711a732ca5b287597b7ae44911a9689584ec0ddac37800709807a29f1a2112521d7c95d41268014cda26c482d6d6e3046ec8a224b6955303f396a8ff09c9c18beefd4c1e3abfbd150f4f910a156121b7d34760d602c38c9034a790825f76fe92957a9a8100303387e028cbab1dfb45860f35406c0f55548c936666f017c85c14b2fc9c41074caeca997e2ccadf0673dc4299edcfbb75873084e029dfa9b7401a168eb8e876535349749b753a704f25ee25b905d3ad13d51a89c1aea335fe0032b4301dcef53b641502ad88ed1d2bc862c463b6049bee638584a8f362bb8c0bababa0e5079b31721155ff9780be8e141cfd22ff28743a07be8447dab0ca2e1ab253efd95c8f18c7ce20f77be278b076bbb35522557d1cb797ed3ca26abbbd8e797173efa0ad633ad2d34b364e6c1cc97a9195871b8db97cc5914b97cfcada3d01fb579dd92c0f227dc67308d0346ef66308a67f549706c20ae78ca165cd37659b9f008d666dbe32385b2c0ce5b7bdd8a7d07db4c6e4487da88dd51b406adaa9973512cf5a73ea2f497822f4ce1d37c54a07de8c27c214e87128f12e5d1da2f41066d9b345a030bb448fc216b4fb08328de427f8042c84663a0209a000a847d534c615214492bf06c771e9914f3412c2925b06a84f1e5f542b8a87519e5bd86059c67e13ac48d1412b2e6ff6065cd8fa74fa35b709304ec479a46d928e0d5c605219cdb55fd0a49026ffddcbdbf3c4f22a15b99e89a38bfaff6f1f1ed1d105cd3069243aec50c2c6c0c44f94ec948ed7f890d01b72fce7194ee1fc049bcb8af4d99e7a58b62c566d67950a4411eb28cef7af760081f5b7d3acabec1e1aefe51e98a9306db32b32a8bc96a5e5eac22724752cf56328c6cb44a263435cf600dc3676f0be3cad316fb9c5aba5322bf58461bfbe2d6f803a0eb2f44e7c74e8eb97e5e4073dd892947e99bb52f44ba31d97f02a7eb395ca2b3d0cf482545475b4ddadb4cfe55602e5b1765ded8b4ba0e3254021d77ffd02ae9e667b971e54ca6438194504f8b6b1c7cc35927abcad25a5d3fd7859afa4a67ae3841c78be5a8af464990f64aa1ea449a7d18b1ac7a25013a80117e5e6a1c83d53bad607dc211fadabfa23fcf6cf429a867ddd904dd0d2fccd5012cdf809509b1a7b02fc584fe303a36cc7075a6ab03dec671d6c5a7635007752e517bb2c6f8f293bf2d22cbf3f7f57c38b3edbf767bff86072139d6f8e225a21a46316602de1208e6f219f011d490f8f2d1be36490f7f2d8e9df105d000d44b57dc71f55eb342d21c880d41481671d3b420d7cc96eb879356839e0eea8c83ca43407f76e849b39403bcfc80349b8e48b499775a362da72d91104c48c022da425fa23e7cebc39c3ef117eb976c5e4ba6ae20d34834fdb1f1ae327a1702f42b78ee9509557fc03ce40a8c2a5316979d89c02944dbcdf40800f6a8a3688a62ceaf512ce4c90e04b08835b75275d93ee5bea22ea48a64a60fe6ff5f72f95f6a3ec99ff1e80eead731102b09d42b9d21b27ba78e8528bdac1d3ebfb71b750aa19184048ab09be23e0c3464fc1b9e5a874294476a2f058f52b1d401891bf410cb115a044d9f6c8797d549dea2af53583156c60e380c5bf950f41712283c2d0add7ded2673170adbbb36c19ecf942b67897b322595745ffc754793d4e0b5174567fd02ba736f8646679a2ad0e8bd3a3aef4b7b88cbdd8a275252e772c6ffcbe146bd8731323695b2c1fdf33ab8334b60b97ebde91bfe9aeedebff2f9ffb801cc60900fbfefff6e6f176d0833d3062041fb67dff1089a335d62068b95f129553d032115eb55fda40467b6a676433de4692178f88e4110064d00d58031babe081b96fe95ab56e661513a4e912406567a6db90044dd28b55329b7f29ec8a218c6e17d08627b16cef0c8b41c866e51cc4d2045f10042b109ae5061d8cc21b308bd1937565ab4ad8f99bee863cfd5c722aefc283bb6a666e56f2b5fb738ba4c4209c7b362bce3b7a1a6a20e11c3bc7a16dafef12b0abdf929277f5b88f57a15e8a91690df9a1c991e54d436a7830aecda8d9507707503eaf81280118978df8dc17e829868d4403ab69da509eed00fb21520115924e2286a8ca84328f1d1a16d3cab8c77aa23942bd4d6fa8f2df462f5832f4fce8c7dc141bbb227bf66a4a8df8413f48d610b2a4c19f463e29b4f26d1403aac5e889d947af7671c12447236fb7ce033c1598cfbb9f44d081b1e34b17b3cf0805130af2e8a3478cd0cf10057645ea3d7d9c8ad63ca54f54251b320014a96c6df42708ad1efde0a53e9adbf3acfc630992382e5a3e56fb818b860b8f9661465f721d243f55f3c0b4a65748564d44e3db2200c85ad1b9fa98ce2329db45dce58a77273e68447726364204cac8d7a9dccab4cb0c33f7a6f48681eba8b5a1f698a722301378bcb32b9aed8a8a00134462e382038a082f69c4c8ab43ee7462b1212a11cd19ddeca3e3ac512cb4dcaebdef141a73b2649c58020401495892a9f3686049ee8c9dbe1b45768e9cf0ec3c945d7afcf9824a0652c4e8e9585fcf5d228146ea52db99d0e700a3c2961f59528020df13b6ffb4a47e3cb85be418aab4e4beec48b92d1a7a2e89dc889fb27ecc51dbbe67922d50970bacc80cad46402409ac9ae72927d0e7aa4d1686c31a6bad44e3987f26d57607c827bfdfe23320964395d2163cc1c7d210308819f04141ae19b7e58fb0196a95f3e85759285e8ab4cb890832398efd7a210e318fd0fd2d22f2daee082205183aca5d5f3519572eb9d1e9c52af1ee513cf5da315c0725f979fb9d802052bb60587bde14fbb0a0135d69ce2e6286aad99c8069f7d4984bbebb8e0701fd24971b978a1b27caa0889fc27c79af5d593841244ba4c91610ccb7a5ec63d60f505f6e62bf14d0da6917dba3336725c63e033f065e5f3d6497ce2df848564e93881ae8d04f10f3c9df739fe15e5aad625554f4d8df28794bc09e858a29986855354c3ecc6eddc76b41bb299fcdbab69d64d420a5afac01d237efe2e48b1590446e4db8d7a587f5f7d917166e3ebe3014fcb33dcc46d626f38c3bb63bb2cc20a30bf64242f95f05c94417fe740191a58dfe06ebebfba51231553104e6026d500c707bcdb882812846aee83209ee88fc8b7b37a5129b93621987cd77145831b28c2715ae49c3b7fe09f88b09f897b18b83dc0a1022669a9989ccd125b3d912b7ca9d34d26562c84290c8331aa7a87f1f957c3c7eddd1906e7270386edb6773b284268a03b44e4f9fb192a65868a84985fe26358b203d4ac6f8ffeacb4c8f78fd939d384fd6d2adaf522f50aa22a90c195b0133871cb4e662a9324f748cc4ae2ceedae46e90c5ee77e9aea2d480b18d9a840fca567ccca8945ba5ccc2c136cfe278b33728be36db1f9de6200298f1cd75c8b5a80ed3d8c04801191e8aa250468a61fe0ac7bc3cad2b2db788733c167865d730e290506cac71d988e913669ad33c26e349a4822afc38b21f7fe08000bfd63c7d209617b05658278cb220b38ad2528dbe8dd681aaab85ea806285cde04e3433392ed5d7ac27c0a08c7a5ec9f748b45c3a94593556258f0a2f9f1e45b9824ca7f683fd1864ca187d2ac6c145986c2755cbae4d441aea9706ba451f5c506546fde65f6e263b996d6ab133514a27519b3786d135ad5b1eaa26ef4a7c2c82857f4afc3219e446a6b72efa89768286e119b61e035a0aa7d9b68a33eab4be704a2f1d553bba18d8e2a8c84da78b84c449dc77f7c4382c17aad3d8af1c2c6f532fc68c42dd54c62c65a3dc08ca84f1939042799d89f2a2dfbc59d7c9d8bbc2ff9d6c51e0cf7a3eb1af56364cf53a3ba079fa5af81817a9128db3ef66ad9e58b6001218519acfeccbbdd20ca1bc19fc7d26698123c71f6a15590b3d52fb73d518e5254626565c82fd18d55ebc63a90da746aae2b3eb0a7e86f72f2232d9d6b63ac29fd3317e7989da79f5187d8d5bd2901836716b205dced5eda5f00ae91daa8f8be8241ec82182e1c5774157fc437829faf3144828bee91602ed076f0f19139b0aa572817d7a2117b46cf2d1cb06ee6b00825b3fa18751b5a68418831f1391aed8dfbe5bdc38468193b95eed99dbb1ea3fdb77586edc5f2b75446ecd423ade60b57f3c4baf91ec2c17a9f004db6d7145a0d20ad060f1d4bd4effe053b5735bc719c41b4b4762d1fdb97a9233ece6f420348aaab748668326c95e97e3ed96235371c4a65ff9d56873cefe3c2370c7e8c4be8b0f66b6eb20c0e97aa01f38474c7dcdc4f47a706069444dd221e350a28eac3da4d91904257441fb30a683cd6815ea12834ad4fdc1d238fede20cb618ba94021616f7db99c731df7ffb54e7a7992a9cbecfeccd3dd07f665ddc3e1f0b18ac032abc9f1e197ae99876fa4092a3b28dfb1e0ef4e8983aa8ff9440909b21e718802484f49e39c7bd3f440a11a8586a5858c9e5b7b5d8d6ad677a23a6581d59132333505d7be786e354279bb4070f58bb29ae506a3bbe5e7d1bbc702a54fe8b48ca0f93f5f19516362aa3841909083a696be3a3f9eb72464566b9bc91b575ba74f33778af44ef90d0b4078c9ac8379265f014fa45eabb308dc10a08ad1e76319162d2d5ea6b2440dd91d2727f8fc7b102560de011cd65882560b5474c18fd0eac3e07567673c27ec3b73bfc453a7a44f6bff3dc283edd41e158edc923e55cb863d106251077daafdfa7036dd4cd4cfa0d74754c8c89a2099aaa706e3c9e49c861b1bf61a385dfb852a51e6eb091d82445ccbf6df587f1ebe933c28bacfc107019435061186dbb20f97c8b93c6c0a02fe69fab8fa6f0da47b06a0c75da718d6675372693ca16df70ac69f42a181cd61543e9c33d7bb124aab180537f02368a3db64453de923ed9baf4ec89fbcb1e31bef2bf56390faadc4f4a106e5bba3bdccc17c0b7128284e5a09862a98be956bbe568be02742025e7be9e2cff67fb5c28fac2e3fe1ebb11ca4852e2e84d2800bdd4fc5a259c6526fcf0c83a9a3054752224318e8c7a16c4f2968187e61974dd39c91963130085bcb8cda9223048cf60474c64bb6d6272f2ecc0a55d90ea1a1dc7269211a125d7c7edf4d3f836a0ce3203f9d2804de016f2d75310a521cf34c3d180713f799b0b43727a3bb2160f2013eb3d7168e83f2e0d41f886d2cb20fd0f69be80f1cd5ec7bb2b11a407fe215f2f19e75664aaac2424f9429b36ef02a8d77a000ba81df641554ad5d11b6916de83f6bef568e80282b2573c95b028a28b0ab2fc3700a08d5968fe55effd88c3f80493fc5f2b550977bb21d15bd72a70d422d</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Password is required.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">[ENCRYPTED]今日、海を見た。もう怖くない。</summary>
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
    <category term="杂谈" scheme="https://blog.ryaoknw.site/tags/%E6%9D%82%E8%B0%88/"/>
    
    <category term="private" scheme="https://blog.ryaoknw.site/tags/private/"/>
    
  </entry>
  
  <entry>
    <title>2022年10月追番锐评·兼年度动画排名</title>
    <link href="https://blog.ryaoknw.site/2023/1/72c99cd69d60/"/>
    <id>https://blog.ryaoknw.site/2023/1/72c99cd69d60/</id>
    <published>2023-01-24T11:50:14.000Z</published>
    <updated>2023-04-02T06:44:06.894Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>懒得写但又总是想写，<del>于是便随便水水罢</del></p><p>本来还打算单独以一篇「看动画破放了怎么办·尬黑·孤独摇滚」来作为评价的，但是懒，以及感觉怎么写也无法准确表达自己的想法，<del>于是也随便水水罢</del></p><h2 id="2022年10月"><a href="#2022年10月" class="headerlink" title="2022年10月"></a>2022年10月</h2><h3 id="电锯人"><a href="#电锯人" class="headerlink" title="电锯人"></a>电锯人</h3><p><img src="https://lain.bgm.tv/pic/cover/c/26/b4/321885_92uzU.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/26/b4/321885_92uzU.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：7</p><p>中山龙拿着电锯人ip的红利追求所谓的“电影感”，最后做出来的东西实在不太符合期望。</p><p>可笑的是吹的几话都不是龙哥监督的。</p><p>作画水准实在不敢恭维，一堆异样的走路摆动幅度，极其粗糙的长镜头运镜，是否搞错了真实系作画是个啥？更不用提各种谜之演出，战斗节奏说停就停，还有一段意义不明却占了几分钟的清晨生活特写。</p><p>期待龙哥的后续发挥，但他实在不适合来做电锯人。</p><h3 id="秋叶原冥途战争"><a href="#秋叶原冥途战争" class="headerlink" title="秋叶原冥途战争"></a>秋叶原冥途战争</h3><p><img src="https://lain.bgm.tv/pic/cover/c/da/3d/389450_BbZ4n.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/da/3d/389450_BbZ4n.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：6.5</p><p>PA原创动画</p><p>套着女仆皮的日本黑帮故事，全篇充斥昭和味。</p><p>在看完前几集后，黑道女仆的噱头意味已经淡去后，本番本质上是对黑道元素的利用，用极其荒诞的展开以及一堆女仆元素来展现黑道题材中的对于无意义无结果的认真与坚持。在荒诞背后透露出悲剧，而只要将这层荒诞稍微减弱，悲剧色彩就被无限的放大。</p><p>本番剧情的展开十分严谨和自洽，在每个荒诞和反常识的展开背后，都有前文的伏笔作为呼应。</p><p>动画逻辑的核心是对「女仆」职业所抱有的“认真”和“大义”，这种坚持与大幅度流血与牺牲形成极大反差，体现出「无意义」，全篇都在以一种荒诞的形式来讲述背后的严肃内涵。</p><p>但要说内涵，实际上除了从9&#x2F;10话开始的正剧，到最后岚子被杀，我只能认为这是一个“形式”大于“内容”的作品，就和上季度的孔明一样。</p><p>不过就总体而言，这个原创还是给了我不少乐子和惊喜，极力夸张的演出风格与其背后的荒诞为作品增色不少。</p><p>我极力反对那些在看完噱头图一乐后就抛下一个“逆天”，而在热情退却后写下一句”无聊“作为口水话来评价这个番，它其实是制作组的一次用心的，充满诚意的「单推」</p><h3 id="机动战士高达-水星的魔女"><a href="#机动战士高达-水星的魔女" class="headerlink" title="机动战士高达 水星的魔女"></a>机动战士高达 水星的魔女</h3><p><img src="https://lain.bgm.tv/pic/cover/c/f1/fd/349441_uND33.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/f1/fd/349441_uND33.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：7</p><p><del>大河内将重新定义高达！</del></p><p>大河内携手高达ip，将其打造为现代的，符合当下主流审美的高达味。本作抛弃了高达一贯坚持的宏大叙事，从校园、百合双女主以及融入其中的各种要素来讲「后退只能选择其一，前进兼得两者」的主题（当然，虽然还有一半没出，但是专业的动漫高手是不对其抱有乐观预期的）</p><p>值得一提的是ep11长达4分钟的调情演出真的太精彩了</p><p>总之还行（至少我认为整体比电锯人好看）</p><h3 id="恋爱FLOPS"><a href="#恋爱FLOPS" class="headerlink" title="恋爱FLOPS"></a>恋爱FLOPS</h3><p><img src="https://lain.bgm.tv/pic/cover/c/ac/ba/375735_AR8Al.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/ac/ba/375735_AR8Al.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：6</p><p>以故意典为卖点来消解因为典带来的烂俗感觉，脚本安本享，著有石头门混沌子等作，是5pb、mages的脚本家。</p><p>由于脚本我可熟了，后面开始“神展开”的时候也没抱有太大期待，从前面的水准就能看出不太能期待，以及对5pb等作一贯神展开背后没什么严谨逻辑支撑的了解，最后失去了典要素为卖点后，本作也就没什么意思了。</p><p>附科学妄想经典番茄酱：</p><img src="https://s2.loli.net/2022/11/24/JqvRzINy2fSjFCA.jpg" class="lazyload" data-srcset="https://s2.loli.net/2022/11/24/JqvRzINy2fSjFCA.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img" style="zoom: 33%;" /><h3 id="孤独摇滚！"><a href="#孤独摇滚！" class="headerlink" title="孤独摇滚！"></a>孤独摇滚！</h3><p><img src="https://lain.bgm.tv/pic/cover/c/e2/e7/328609_2EHLJ.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/e2/e7/328609_2EHLJ.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：8</p><p>值得逐帧去看的萌豚动画，制作水平太高了，动作细节设计的太好，改编的部分也精致有创意。</p><p>太厉害以至于我唯一能想到的尬黑只能是原作自身水平，我将化身成为cloverworks厨，这是今年给我最大惊喜的动画，它甚至只是芳文社漫改。</p><p>演出形式又新又整活，以至于你能很容易的制造各种题材的二创。</p><p>制作团队厨力拉满，以至于作画演出水准足以让平凡内容焕发新生，喜多厨头子けろりら天天在twitter高强度摸喜多。</p><p>这样的高质量制作暴打10月顶级ip电锯人，本来7月pv出来后，我只是因为有长谷川育美<del>（明羽杏子）</del>才去关注的。</p><p>那么介于我对这样一个动画的喜爱，在看完第12话后我不得不去关注它的缺陷，这也是为什么要「看动画破放了怎么办·尬黑·孤独摇滚」</p><p>我对结尾充满了失望，它不具有任何冲击性，我所设想的有那么多人的帮助，并不是说要改变社恐，而是至少可以去展现波奇的心境转变，而不是依旧因为简单的理由（譬如最直接的我喜欢音乐）去对待摇滚，这不是君に朝が降る。在bocchi the rock优秀的背后，不可否认它对于主角的形象转变的刻画是非常乏力的，不可否认的是不管怎么解读，这一整季的成长性是欠缺的。作为一个动画刹帝利，在我的观点里，波奇的所谓「社恐」不过是一种标签化的展示，一种夸张的舞台表演，一种将笑点合理化的说辞而已。因此在最后我将尬黑为：「毫无深刻主题可言」「对社恐与他人的相处方式表现失真（对平民与上层阶级关系表现失真）」「缺乏主线连贯性」，这一点更适用与另一个评分高得离谱的动画「辉夜第三季」，只不过在那里更看不到什么批评之声。</p><h3 id="契约之吻"><a href="#契约之吻" class="headerlink" title="契约之吻"></a>契约之吻</h3><p><img src="https://lain.bgm.tv/pic/cover/c/25/cd/375817_O7LGk.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/25/cd/375817_O7LGk.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：7.5</p><p>A1的7月原创，本来是准备专门出一篇来谈谈丸户史明的风格以及其脚本设计的高明，但是感觉能力不足以写的专业全面点，于是作罢。</p><p>典型输出角色类型的番，实际上剧情不行，但我太爱了，star+1。</p><p>追番体验远大于补番体验的动画，每一集都有新乐子，要去深究，剧情其实漏洞百出，各种作画和演出问题也可以单独切出来批斗批斗，为什么有这种好的观感，得益于前几话的提纯，以及丸户脚本抓住人心的水平。</p><p>cv会泽纱弥的声音可太好听了，表现力拉满的同时还带有涩气，1月的生而为狗的表现也很好，这种cv可以期待一手同人音声以及套马甲进军里界（简直是至福）</p><h2 id="年度动画top"><a href="#年度动画top" class="headerlink" title="年度动画top"></a>年度动画top</h2><p>仅评价8分以上作品。</p><h3 id="1-Cyberpunk-Edgerunners"><a href="#1-Cyberpunk-Edgerunners" class="headerlink" title="1. Cyberpunk: Edgerunners"></a>1. Cyberpunk: Edgerunners</h3><p>极高的水准，trigger拉来众元老，用行动告诉了业界依旧可以有着20年前的高水平。</p><p>啥时候养老院khara也来一个原创（</p><h3 id="2-メイドインアビス-烈日の黄金郷"><a href="#2-メイドインアビス-烈日の黄金郷" class="headerlink" title="2. メイドインアビス 烈日の黄金郷"></a>2. メイドインアビス 烈日の黄金郷</h3><p>双线叙事编排精巧，跨越时代的冒险被深渊的罗盘所联系。</p><p>深渊是工具，将一切现代价值解构，将人从「有机」转为「无机」，“天地不仁，以万物为刍狗”，在深渊中，人变为了最原始的生命形态，在此，「一切垃圾都能变成黄金」。</p><p>通俗意义上的生命不具有「价值」，愿望获得形体，意志化为肉身。</p><blockquote><p>痛みと痛み取り替えよう<br>糧にするんだ　落花のかけら<br>すべて傷ついて僕は象ってく　形になる<br>目覚めの先で<br>行こう　ずっと　響かせよう</p></blockquote><h3 id="3-ぼっち・ざ・ろっく！"><a href="#3-ぼっち・ざ・ろっく！" class="headerlink" title="3. ぼっち・ざ・ろっく！"></a>3. ぼっち・ざ・ろっく！</h3><p>在进击的巨人与孤独摇滚中纠结，由于在写这个的时候笔者已经玩过muv-luv了，对巨人剧本有着相当量的不满。以及笔者向来对厨力和用心有着情感倾向，于是决定还是给孤独摇滚吧。</p><h3 id="4-進撃の巨人-The-Final-Season-Part-2"><a href="#4-進撃の巨人-The-Final-Season-Part-2" class="headerlink" title="4. 進撃の巨人 The Final Season Part.2"></a>4. 進撃の巨人 The Final Season Part.2</h3><p>mappa尽力了，而wit还在用古桥一浩x间谍过家家这种答辩摆烂</p><h3 id="5-かぐや様は告らせたい-ウルトラロマンティック"><a href="#5-かぐや様は告らせたい-ウルトラロマンティック" class="headerlink" title="5. かぐや様は告らせたい-ウルトラロマンティック-"></a>5. かぐや様は告らせたい-ウルトラロマンティック-</h3><p>演出大好，4月最佳</p><h3 id="6-からかい上手の高木さん③"><a href="#6-からかい上手の高木さん③" class="headerlink" title="6. からかい上手の高木さん③"></a>6. からかい上手の高木さん③</h3><p>只要细节和铺垫做到位了，即使是普普通通的展开也完全可以在制作工业化的时代做到乱杀，单集亮眼</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;懒得写但又总是想写，&lt;del&gt;于是便随便水水罢&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;本来还打算单独以一篇「看动画破放了怎么办·尬黑·孤独摇滚」来作为评</summary>
      
    
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/categories/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>通过手机USB或者蓝牙共享网络</title>
    <link href="https://blog.ryaoknw.site/2022/10/ac2b91736516/"/>
    <id>https://blog.ryaoknw.site/2022/10/ac2b91736516/</id>
    <published>2022-10-05T14:22:47.000Z</published>
    <updated>2022-10-05T14:38:17.332Z</updated>
    
    <content type="html"><![CDATA[<p>才知道能这样。。。简单记录</p><h2 id="USB"><a href="#USB" class="headerlink" title="USB"></a>USB</h2><ul><li><p>手机打开“USB共享网络”</p></li><li><p>连接数据线</p></li><li><p><code>ip addr</code> 或者 <code>ifconfig</code> 查看是否有新增网络接口，如 <code>usb0</code>，<code>dhclient usb0</code> 分配IP地址即可。</p></li></ul><p>不出意外会在有线网络处连接上手机网络</p><h2 id="蓝牙"><a href="#蓝牙" class="headerlink" title="蓝牙"></a>蓝牙</h2><ul><li>手机配对系统蓝牙</li><li>手机打开“蓝牙共享网络”</li><li>在网络处连接即可</li></ul><p>成功时网络配置里长这样：</p><p><img src="https://s2.loli.net/2022/10/05/3ZSRhWsUozHNlTk.png" class="lazyload" data-srcset="https://s2.loli.net/2022/10/05/3ZSRhWsUozHNlTk.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="image-20221005223718112"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;才知道能这样。。。简单记录&lt;/p&gt;
&lt;h2 id=&quot;USB&quot;&gt;&lt;a href=&quot;#USB&quot; class=&quot;headerlink&quot; title=&quot;USB&quot;&gt;&lt;/a&gt;USB&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;手机打开“USB共享网络”&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;连接数据线</summary>
      
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
  <entry>
    <title>葉・锐评莉可丽丝！</title>
    <link href="https://blog.ryaoknw.site/2022/10/6a26be0842f4/"/>
    <id>https://blog.ryaoknw.site/2022/10/6a26be0842f4/</id>
    <published>2022-10-02T21:15:50.000Z</published>
    <updated>2022-10-03T14:21:03.621Z</updated>
    
    <content type="html"><![CDATA[<h3 id="莉可丽丝"><a href="#莉可丽丝" class="headerlink" title="莉可丽丝"></a>莉可丽丝</h3><p><img src="https://lain.bgm.tv/pic/cover/c/65/19/364450_xx2zx.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/65/19/364450_xx2zx.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：6.5</p><p>开播前以及开播中都期待值拉满的原创动画。</p><p>在看到pv，以及看到第一集后，对画面质量的优秀、主角动作的精细程度感到十分惊喜。泷奈的cv若山诗音是老熟人了，新届热门cv，事务所也在强推，倒也没太喜欢，但是千束的cv安济知佳发挥非常出色，完美表现了千束的活力和元气。本身我对具有百合气息的番表示极度欢迎（谁不喜欢看美少女贴贴呢），于是它成为了我周六更新第一时间就会去看的番。</p><p>后续剧情槽点很多，不过制作组重心依旧不在挖掘剧情设定，倒是关注于女主角的神态和动作细节上，每一集都会出现的清新日常画面也让这番大火，切片都能上抖音爆款。当然，这挺好的。至少，前大半部分精细的神态动作，以及足立监督设计的场景让整个番的贴贴场景充满“日常感”，值得一提的是，bgm和ed的插入也非常精准。</p><p>制作组专注于“日常”的部分，而有意淡化lycoris背景设定下的黑暗一面，其实设定部分要展开黑暗面、挖掘深刻内涵，可以写的东西是很多的，比如lycoris的诞生，DA组织的实际背景，旧电波塔时期的事件等等。淡化这些以后观感是很好的（至少对于我来说，我是吃这一套的）</p><p>而在第7、8集开始，从千束心脏的设定开始，莉可丽丝转向了更深刻的故事内核（虽然它烂了，但不可否认的是，它确实有去尝试表达这些）：</p><p>DA机关培养着社会工具人lycoris，泷奈也是其中一员，他们从诞生之时就被社会赋予了社会义务。</p><p>lycoreco咖啡作为一个日常的场所，而亚兰机关和DA组织作为黑暗面的部分，二者形成对立冲突。他们各自代表一种态度：前者作为一个日常的、有生活感的温馨场所，而后者追求将每个人的天赋进行开发，让他们都去执行自己的「天职」，即使人们不再信仰上帝，但是依旧为了为了这种「天职」而追求，以此来感受到自己的「人生价值」。千束作为一个亚兰机关的孩子，而在lycoreco咖啡中生活的她并不愿意去履行这种所谓的被赋予的社会义务，而是只想做自己想做的，守护自己想守护的。泷奈在前期也对自己在DA的生活方式有着强烈的执着，觉得自己一定要以执行「天职」的方式才能感受到人生的价值。直到她遇到了千束，逐渐被千束<del>贴贴</del>影响，这种观念才有所改变（从这方面看，莉可丽丝其实也算是一个很不政治正确的番，很明显它是对选择在lycoreco咖啡生活的千束表示肯定的，同时对DA也有明显的讽刺）。</p><p>莉可丽丝所想要表达的，<strong>正是对放过「天职」，放下固化的执念，好好追求自己的幸福的生活态度的肯定</strong>。</p><p>题外话：所以说现代社会对人「天职」的要求也逐渐成为了人自己对自己「天职」永无止尽的要求，有时候部分人确实得想想，自己到底再卷什么，说到底最终能卷离自身的精神虚无吗。</p><p>正因如此，我在12集前，甚至11集时，还在期待更多，期待它完美落地后我能直接吹爆，但是12集直接让整个故事变成了喜剧「乐」</p><p>那么12集以及之后的13集到底烂在哪？让我来仔细喷一喷。</p><p>它的剧情逻辑过于扯淡了，这一点实在不用多说，只能说<strong>如果制作组觉得日本人的脑子是这样的</strong>，那么能想出番里的日本人这样行动也是挺合理的。但是其实也能接受，因为倘若仔细想想前面的剧情逻辑到底如何，大家心里应该都有点数，只是这集尤其逆天罢了，这么一想<strong>日本人的脑子确实是这样的</strong>。</p><p>在我看来，真正影响观感的，是整个主角形象的彻底崩坏，以及故事内核的彻底崩坏。</p><p>千束，作为一个故事中最讨喜的角色，为什么讨喜呢？因为她一直作为一个坚强、自信、对任何事情坦然接受展开笑容、遇事游刃有余的形象出现，但在12集中，千束所展现的只是和吉叔的一顿嘴炮，以及摆脱了杀人机器的「天职」，而被莫名其妙的“不杀人”的新「天职」所束缚的形象，她的行动根本不是对「天职」观念的否定，而只是被另一种形式的束缚了而已。而泷奈和吉叔两人，一个“心脏要逃走了！”，一个“来杀我呀来杀我呀”属实逆天，这就是你足立眼里的对立冲突？</p><p>而在13集，千束一顿操作后依旧没有解决自己对于「天职」观念的矛盾，制作组而是换了一种方式，“诶，我让大叔把吉叔杀了，让千束开个挂，这样千束不就既和解了也活下来了嘛”，属实在原有崩坏的基础上更加崩坏了。我在想千束在lycoris战友身受重伤的时候心里有何感想，一枪一枪打向绿毛的时候心里有何感想，泷奈快要被杀的时候有何感想。惦记着不杀人的想法在电波塔扯淡，难道被肃清的lycoris的命就不是命了？难道被杀的恐怖分子的命就不是命了？难道被大叔杀了的吉叔就不关自己的事了？</p><p>我不理解，为什么后面要突然去讨论一些不属于自己的话题，明明不需要关注杀不杀人，法不法治，这单纯只是一个触发矛盾的工具，只需要简单的，实在不行弱智一点，机械降神的解决问题，这样千束依旧以全能洒脱游刃有余的形象获得所有人的好感，剧情弱智和多余未回收的设定是贯彻全番的问题。于是为了填这些，再强行加上逆天设定。只可惜它还是要去讨论不属于自己水平和日本人脑子的话题，最终主人形象彻底崩坏，内核崩坏，而逆天的剧情只能让这个番配上一个字「乐」。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;莉可丽丝&quot;&gt;&lt;a href=&quot;#莉可丽丝&quot; class=&quot;headerlink&quot; title=&quot;莉可丽丝&quot;&gt;&lt;/a&gt;莉可丽丝&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://lain.bgm.tv/pic/cover/c/65/19/364450_xx2zx.j</summary>
      
    
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/categories/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/tags/%E5%8A%A8%E7%94%BB/"/>
    
    <category term="评论" scheme="https://blog.ryaoknw.site/tags/%E8%AF%84%E8%AE%BA/"/>
    
  </entry>
  
  <entry>
    <title>葉・赛博朋克・简评</title>
    <link href="https://blog.ryaoknw.site/2022/10/cba225035484/"/>
    <id>https://blog.ryaoknw.site/2022/10/cba225035484/</id>
    <published>2022-10-02T20:20:06.000Z</published>
    <updated>2022-10-05T14:24:04.190Z</updated>
    
    <content type="html"><![CDATA[<h2 id="赛博朋克边缘行者"><a href="#赛博朋克边缘行者" class="headerlink" title="赛博朋克边缘行者"></a>赛博朋克边缘行者</h2><p>star：8.5</p><p>由于会讨论“赛博朋克”这个话题，为了便于区分，我姑且在文中只称这作Cyberpunk: Edgerunners为“边缘行者”</p><h3 id="赛博朋克"><a href="#赛博朋克" class="headerlink" title="赛博朋克"></a>赛博朋克</h3><p>在如今看到的大部分涉及未来科技，新颖世界观的作品，它们被标榜为“赛博朋克”，但实质上大多只有“赛博”没有“朋克”。</p><p>赛博朋克本身就是对未来科技发展的一种悲观预期，对人类未来可能出现的社会形态的假设和探讨，它会对现在社会的传统概念进行解构，展现出一种颠覆性或者叛逆性，它的整体风格一定是<strong>反乌托邦</strong>的。边缘行者在这一点上做的尤其好，整部番中都始终展现出一种无限压抑，无可奈何的氛围，整个叙事氛围都笼罩在对于赛博社会的无力感中。</p><p>在边缘行者中，在夜之城这个赛博社会中，<strong>传统价值被完全解构，人们的精神价值依附于金钱、肢体改造、以及幻想物</strong>。这一点在第一集的诸多细节画面中有着较为详细的展现。</p><h3 id="大卫"><a href="#大卫" class="headerlink" title="大卫"></a>大卫</h3><p>在这样的一个未来社会中，大卫，作为赛博社会中的一个普通人，他在赛博社会中的精神虚无，陷入后现代精神危机。这一点在前3集中就有集中表现，比如母亲死前，即使自己对于当下生活感到不满，依旧没有表露，跟随母亲的心愿上学；在母亲死后，自己不知何去何从，然后出现一个镜头，大卫从高处跃下，落在垃圾堆。</p><p>直到被一个成熟涩气大姐姐lucy捡走，从之前和母亲相依为命的「群体」转变到了团队的「群体」，依旧在其中继续迷茫地活着，然后在团队中被Maine认可，被lucy认可，也对于强大、经验丰富的Maine心有崇拜，这也为后续大卫继承Maine的领导者身份，追求团队工作，追求自己的身体改造做足了铺垫。</p><p>直到Maine死亡，大卫的精神状态被迫接受了转变。</p><p>前三集直接让我不得不熬夜看完这整部番，充满光污染，高饱和的画面，无处不在的社会和民生细节的刻画，让我甚至需要暂停反复观看，完全没有快进的想法。第二集被lucy带走，以及拉去月球，整体演出表现高涨的情绪、癫狂的浪漫主义，在夜之城的这种疯狂中，更是进一步衬托了赛博社会人们精神虚无的现状。</p><p>Maine的命运其实也是对男主命运的预示。在夜之城这样一个赛博社会中人们作为社会工具，无法逃脱体制，被夜之城操纵，精神除了追求身体改造没有别的出路，直到被折磨至精神疯狂，在被彻底混乱之前挣扎，然后作为毫不起眼的死亡体验素材从社会中消失（吉米的大量摆放的素材完全突出了这一点）</p><p>第6集Maine之死的演出实在过于优秀，在最后一幕中，静止镜头配合强大的蒙太奇手法，配上嘈杂的噪声音乐，一整个就是极致的暴力赛博演出，实在精彩！</p><p>后续故事讲述大卫精神危机所导致的恶化，在第8集时，变为了当初自己讨厌的那类人，让自己母亲身亡的那类“走狗”，大卫在团队中迷失自我，无可奈何的走向崩溃，直到在最后一话，在极致癫狂的精神错乱中，随着Rebecca的荒诞式的惨死，自己的生命也走向了最后一刻，最后那仿佛释然般的一笑是为何而笑呢？</p><h3 id="lucy"><a href="#lucy" class="headerlink" title="lucy"></a>lucy</h3><p>我始终认为lucy其实并不是边缘行者中的主角，她和Maine、Rebecca等人一样，在这短短10集的动画中只是作为一个故事工具人，这也导致了我心中的遗憾：<del>这么好的大姐姐居然没戏份？！</del></p><p>lucy从前2集就抓住了我的眼球，一个成熟、独立、有经验的前辈，一个帅气潇洒又带有疯狂的赛博女郎，而在第2集带david去月球的情节中又表现出lucy讨厌夜之城这种赛博社会，向往一种在那时已经被完全解构的传统的浪漫、自由与解放。（多么好的涩气大姐姐，<strong>很符合我对赛博女郎的想象</strong>）</p><p>lucy和david其实有着相似的悲惨经历，这也不难去理解lucy为什么会在短短的时间内就接受了david。</p><p>后续david死后，lucy一个人去了早就能去的月球观光车，没有自由和解放，依旧无法逃脱赛博社会的压迫，极致的悲哀和无力感。</p><p>让我觉得不满的点在于，lucy在接受david之前，也就是我上述所说的一个独立的赛博女郎形象，而在后续情节中，尤其是在Maine死后，却直接转变为了一个为了保护大卫而行动，以及等待男主角拯救的传统动画女主角形象，而在家里更只是一个相互依偎，让大卫搂搂抱抱的“居家贤内助”形象，我本以为揭示lucy的身世后一定会有更多的转变。</p><p>确实，这样也问题不大，只是我觉得可以更好，现在的结局只是：david死了，lucy依旧没有获得她想要的自由和解放。我觉得可以有另一种可能性，譬如大卫在赛博社会中不知何去何从，陷入后现代精神危机，而lucy向往的是旧传统的浪漫。可以用浪漫主义解决后现代问题。</p><p><strong>不然在第2集那个经典的在月球上带着david纵身一跃有何意义？</strong></p><h3 id="吐糟"><a href="#吐糟" class="headerlink" title="吐糟"></a>吐糟</h3><p>其实这作一点都不扳机社，可能唯一符合扳机社风格的就是Rebecca了。（没想到trigger居然有这种水准）</p><p>有人说david的一生为了别人而活着有什么不好的，确实，这也是一种典型的生活方式，要多点篇幅刻画其实也可以写成“赛博士郎”（笑）</p><p>边缘行者通过多个角色的生活方式提供了一个多元的视角，在夜之城中，每个人都有自己应对人生虚无的方式，依靠他人而活的david，为了自己而活的Rebecca，<del>为了オナニー而活的Pilar</del>，为了夜之城的金钱地位而活的Faraday等等。在赛博朋克的框架下， 边缘行者对于夜之城的各种生活方式都有着一种嘲弄和同情的态度（唯一去表示肯定的白月光可能就是lucy的传统浪漫吧）</p><p>真没想到如今的日本业界还有水准做出这样的动画，trigger这波拉来了一大众元老人物做出的边缘行者无疑能成为今年最佳动画，在这部边缘行者中我仿佛看到了老gainax的影子（trigger真的很gainax），这部边缘行者的男主角david总能让我看到EVA中真嗣、FCLC中的直太、甚至包括天元突破中的西蒙的影子。他们都是在为一种无力感和迷茫感做斗争，挣扎于自己人生价值的虚无。但是david并没有想这些角色一样受到trigger以往“突破天际”的眷顾，真嗣有葛城美里，有明日香，有真希波；直太有春原晴子；西蒙有大哥，优子和妮亚。但是david却只是处于每一个人都有着深深的无力感的赛博社会中（你以为lucy是春原晴子？错啦！），在这样一个一切传统价值都被解构的社会中，<strong>david无法找到自己所应当「相信」的东西</strong>，只有金钱、肢体改造和幻想物，所以他最终只能为了他人而活，为了他人的梦想而活。</p><h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>奈何文化水平低，看不懂很多东西，没法做出细致的“锐评”。</p><p>写一个这样的评价实在费劲，不知不觉就花了个把小时，其中还有一堆不通顺的胡言乱语，但是懒得审懒得改了，如果有时间和动力，还想做一篇《双城之战》的评论，这是我近几年来最爱的，丝毫看不到任何缺陷的作品（吹爆捏）。</p><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><p><a href="https://writeas.xyz/zsn4p7dacycfy8e6.md">https://writeas.xyz/zsn4p7dacycfy8e6.md</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;赛博朋克边缘行者&quot;&gt;&lt;a href=&quot;#赛博朋克边缘行者&quot; class=&quot;headerlink&quot; title=&quot;赛博朋克边缘行者&quot;&gt;&lt;/a&gt;赛博朋克边缘行者&lt;/h2&gt;&lt;p&gt;star：8.5&lt;/p&gt;
&lt;p&gt;由于会讨论“赛博朋克”这个话题，为了便于区分，我姑且在文中只</summary>
      
    
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/categories/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/tags/%E5%8A%A8%E7%94%BB/"/>
    
    <category term="评论" scheme="https://blog.ryaoknw.site/tags/%E8%AF%84%E8%AE%BA/"/>
    
  </entry>
  
  <entry>
    <title>2022年7月追番锐评</title>
    <link href="https://blog.ryaoknw.site/2022/10/cf556c178003/"/>
    <id>https://blog.ryaoknw.site/2022/10/cf556c178003/</id>
    <published>2022-10-02T19:58:06.000Z</published>
    <updated>2023-04-02T06:42:44.054Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>博客老旧没动静了，之前还意外扬了一次，准备手写一个前后端自己搭建一个新的，上手觉得不太有趣，于是作罢了，旧博客由于更新hexo和主题导致不兼容，自己写的一些js配置全没了，不想再折腾一遍了。</p><p>无论如何，本来想只做技术的，现在发现没啥意思，不如在里面发发牢骚，平时追番完结了只在群里锐评一番，流水账一通说完旧没有后续了，而bgm的简评限制了200字，实在不够婆罗门说一通的，想了想把看过的番评放到这里来或许挺不错的。</p><h2 id="2022年7月"><a href="#2022年7月" class="headerlink" title="2022年7月"></a>2022年7月</h2><h3 id="继母的拖油瓶是我的前女友"><a href="#继母的拖油瓶是我的前女友" class="headerlink" title="继母的拖油瓶是我的前女友"></a>继母的拖油瓶是我的前女友</h3><p><img src="https://lain.bgm.tv/pic/cover/c/49/54/343106_cT6ZV.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/49/54/343106_cT6ZV.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：5</p><p>厕纸轻改动画，水准就不用多说了，设定挺好玩的，不过制作组没有玩出什么花活，但它姑且能看，这番就好比寸止挑战，该A上去完结的时候给你停一手</p><h3 id="欢迎来到实力至上主义教室-第二季"><a href="#欢迎来到实力至上主义教室-第二季" class="headerlink" title="欢迎来到实力至上主义教室 第二季"></a>欢迎来到实力至上主义教室 第二季</h3><p><img src="https://lain.bgm.tv/pic/cover/c/c8/8a/371546_Df9ri.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/c8/8a/371546_Df9ri.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars: 5</p><p>制作非常烂的厕纸，也不必多说，值得一题第12集，作为看过原作的人，单纯为了等路哥暴打龙男孩而看，制作组也尤其懂，在打戏方面异常精致，画面质量出乎意料，可谓是为了这点醋，才包的饺子。</p><h3 id="夏日重现"><a href="#夏日重现" class="headerlink" title="夏日重现"></a>夏日重现</h3><p><img src="https://lain.bgm.tv/pic/cover/c/d9/f5/326895_j1S2n.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/d9/f5/326895_j1S2n.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：7</p><p>话题度拉满的动画，原作被吹为命运石之门等级，但至少动画实在不敢恭维，专注于叙事，而在形象塑造上非常马虎，大部分时候它所渲染的氛围与我心中所想的完全不同，尤其bgm的把控让我想要大骂。整个看下来，唯一让我影响深刻的演出部分也就只有第三集结尾追潮的部分。而尤其25话结局的演出，实在太烂了。</p><h3 id="来自深渊-烈日的黄金乡"><a href="#来自深渊-烈日的黄金乡" class="headerlink" title="来自深渊 烈日的黄金乡"></a>来自深渊 烈日的黄金乡</h3><p><img src="https://lain.bgm.tv/pic/cover/c/ae/18/298477_eBaQ8.jpg" class="lazyload" data-srcset="https://lain.bgm.tv/pic/cover/c/ae/18/298477_eBaQ8.jpg" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>stars：8.5</p><p>布耶可cv寺崎裕香的表现太优秀了！不太熟的cv，但是从现在开始关注了。</p><p>第一季以及剧场版的质量也非常高，原作的质量也很高，作为第二季，整体质量很高，bgm质量很高，尤其重要部分的bgm的插入完美把控了情感，演出非常精彩。</p><p>双线叙事编排精巧，跨越时代的冒险被深渊的罗盘所联系。</p><p>深渊联系着上面的世界，与被诅咒的奈落的另一头，莉可在奈落是死的形态，在深渊上面是活的形态，深渊赋予生命的死亡意义，“不管怎样，我们都不过是奈落的产物”。在abyss，有机物不存在额外的价值，而深渊将给予「挑战」它的人们「价值」。</p><p>深渊是工具，将一切现代价值解构，将人从「有机」转为「无机」，“天地不仁，以万物为刍狗”，在深渊中，人变为了最原始的生命形态，在此，「一切垃圾都能变成黄金」。</p><p>通俗意义上的生命不具有「价值」，愿望获得形体，意志化为肉身。</p><p>部分场景的演出差了点意思，比如第7话，以及最后一话中有的场面的插入甚至可以说生硬尴尬，缺少了应有的震撼，或许也只是我期待值过高了。</p><p>ps：我尤其讨厌所谓的原作党，很多时候他们很大的影响了一个动画的讨论氛围，这也是我更喜欢讨论原创番的原因</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;博客老旧没动静了，之前还意外扬了一次，准备手写一个前后端自己搭建一个新的，上手觉得不太有趣，于是作罢了，旧博客由于更新hexo和主题导致不兼</summary>
      
    
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/categories/%E5%8A%A8%E7%94%BB/"/>
    
    
    <category term="动画" scheme="https://blog.ryaoknw.site/tags/%E5%8A%A8%E7%94%BB/"/>
    
  </entry>
  
  <entry>
    <title>图片文件结构与PNG编码</title>
    <link href="https://blog.ryaoknw.site/2022/3/7cad8c576e96/"/>
    <id>https://blog.ryaoknw.site/2022/3/7cad8c576e96/</id>
    <published>2022-03-20T04:00:36.000Z</published>
    <updated>2022-09-21T18:15:38.948Z</updated>
    
    <content type="html"><![CDATA[<h1 id="图片文件结构与PNG编码"><a href="#图片文件结构与PNG编码" class="headerlink" title="图片文件结构与PNG编码"></a>图片文件结构与PNG编码</h1><h2 id="图像存储"><a href="#图像存储" class="headerlink" title="图像存储"></a>图像存储</h2><h3 id="颜色在计算机的存储"><a href="#颜色在计算机的存储" class="headerlink" title="颜色在计算机的存储"></a>颜色在计算机的存储</h3><ul><li><strong>颜色模式</strong></li></ul><p><strong>RGB色彩模式</strong>是颜色模式之一（除此之外还有YUV模式和CMYK模式等等）</p><blockquote><p>在实际的开发中，我们可能还会遇到RGBA模式，其中的A代表的是alpha通道，一般表示透明度，值从0%-100%，0-表示完全透明，100-表示完全不透明。</p></blockquote><p>RGB（255, 128, 196）：有3个颜色分量，分别是R的值255，G的值128，B的值196，这三个分量分别用了8位存储。咱们前面提到过8位存储，可以存储256个值。</p><p>关于RGB的颜色表示还有一种16进制表示方式，比如刚才的RGB（255,128,196）换算成16进制为#FF80C4</p><ul><li><strong>像素</strong></li></ul><p>每一个像素都有一个明确的位置和被分配的色彩值</p><ul><li><strong>分辨率（Resolution）</strong></li></ul><p>又称解析度，可以细分为显示分辨率、图像分辨率、打印分辨率和扫描分辨率。</p><p>显示分辨率：分辨率 4000x3000</p><p>图像分辨率: 常用单位，dpi（点每英寸），ppi（像素每英寸）。1英寸&#x3D;2.54厘米(cm)，它的实质是描述了图像的真实大小。比如“水平分辨率 72dpi”</p><ul><li><strong>图像文件格式</strong></li></ul><p><strong>BMP（Bitmap）</strong>：是Windows操作系统中的标准图像文件格式，采用位映射存储格式，无压缩，BMP文件的图像深度可选1、4、8、24位。BMP最大的特点就是<strong>没有压缩</strong>（所以它的图像大小你可以直接算出来）</p><p><strong>JPEG</strong>：<strong>联合图像专家小组</strong>（Joint Photographic Experts Group，<strong>JPEG</strong>）是一种针对图像的有损压缩标准方法。使用的一种失真压缩标准方法，24 bit真彩色，不支持动画、不支持透明色。</p><p><strong>PNG</strong>：<strong>便携式网络图形</strong>（Portable Network Graphics，<strong>PNG</strong>）是一种无损压缩的位图图形格式格式是无损（不失真）数据压缩的，PNG格式有8位、24位、32位三种形式，其中8位PNG支持两种不同的透明形式（索引透明和alpha透明）。</p><p><strong>GIF</strong>：<strong>图像互换格式</strong>（Graphics Interchange Format，<strong>GIF</strong>）是一种无损压缩的位图图形格式，采取8位色重现图像。</p><h3 id="图片的基本概念"><a href="#图片的基本概念" class="headerlink" title="图片的基本概念"></a>图片的基本概念</h3><ul><li><strong>位图（Bitmap）</strong></li></ul><p>又叫格栅图或者点阵图，是利用像素阵列来表示的图像。位图的每个像素都被分配了特定的位置和颜色值，颜色值可以由RGB组合或者灰度值表示。</p><ul><li><strong>位深度（Bit Depth）</strong></li></ul><p>每个像素用来表示颜色信息的位数，位深度越大，颜色越逼真，占用空间也就越大。例如，位深度为1的位图的像素只能为黑色或者白色，位深度为8的图像像素有2^8^（即256）个可能的颜色值。</p><ul><li><strong>颜色通道</strong></li></ul><p>RGB图像的像素由红绿蓝三个颜色通道组成，8<strong>位&#x2F;通道</strong>的图像中，每个通道有256个可能值，因此每个像素有24位可能的值，通常将24位RGB位图成为真色彩位图。</p><blockquote><p>色深度与位深度</p><p>色深度：一个颜色通道的位数，单位为 位&#x2F;通道 。常有8bit、10bit</p><p>位深度：一个像素的位数</p></blockquote><ul><li><strong>Alpha通道</strong></li></ul><p>在原有的图片编码基础上，添加像素的透明度信息，因为通常把RGB三种颜色信息分别成为三种颜色的通道，所以透明度信息也成为Alpha通道。</p><ul><li><strong>矢量图（Vector）</strong></li></ul><p>用点、直线或者多边形等基于数学方程的几何图形表示的图像。</p><blockquote><p><strong>位图与矢量图</strong></p><p>位图的放大实际上是每个像素的放大，单个像素的放大会使线条和形状参差不齐，导致我们看到的图片“模糊不清晰”。而矢量图通过路径和颜色来记录图片信息，放大之后并不会失真。</p><p>位图处理已经标准化，并且硬编码到显卡内，GPU能够处理位图。但矢量图的处理只能依靠CPU。</p></blockquote><h2 id="PNG编码与解码"><a href="#PNG编码与解码" class="headerlink" title="PNG编码与解码"></a>PNG编码与解码</h2><h3 id="PNG文件结构"><a href="#PNG文件结构" class="headerlink" title="PNG文件结构"></a>PNG文件结构</h3><p>PNG图像格式文件由文件署名和数据块(chunk)组成。</p><h4 id="文件署名域（Signature）"><a href="#文件署名域（Signature）" class="headerlink" title="文件署名域（Signature）"></a>文件署名域（Signature）</h4><p>一张 PNG 图片二进制数据的开头必须是这 8 字节:</p><p><code>0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a</code> 转换为 10 进制是 <code>137, 80, 78, 71, 13, 10, 26, 10</code>。</p><p>（Linux下我们可以用file命令直接查看文件的实际格式，但是他本质上也是利用文件头标志来进行文件类型判断的。）</p><h4 id="数据块（Chunks）"><a href="#数据块（Chunks）" class="headerlink" title="数据块（Chunks）"></a>数据块（Chunks）</h4><p>有两种类型的数据块，一种是称为<strong>关键数据块</strong>(critical chunk)；另一种叫做<strong>辅助数据块</strong>(ancillary chunks)。</p><p>每个数据块都包含图片的描述信息，数据块由四个部分组成：</p><table><thead><tr><th>名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>Length</td><td>4 bytes</td><td>指定 <strong>Chunk Data</strong> 的长度</td></tr><tr><td>Chunk Type</td><td>4 bytes</td><td>指定数据块类型</td></tr><tr><td>Chunk Data</td><td>可变</td><td>按照Chunk Type存放指定数据</td></tr><tr><td>CRC</td><td>4 bytes</td><td>检查是否有错误的循环冗余代码</td></tr></tbody></table><p>这里要注意 Length 保存的是该数据块中 Chunk Data 的长度，也就是说，一个数据块的长度应该为 Length 的值加上12 bytes。</p><p>Chunk Type 由4个字符组成，：第一个字符是否大写（critical），决定了该数据块是否是关键（critical）数据块；第二个字符大写表示公开，小写表示私有；第三个字符规定必须大写；第四个字符大写则表示只能在关键数据块不变时被复制，小写则表示任何情况下能复制。</p><h4 id="关键数据块"><a href="#关键数据块" class="headerlink" title="关键数据块"></a>关键数据块</h4><p>关键数据块定义了4个标准数据块，每个PNG文件都必须包含它们。</p><p>1、<strong>文件头数据块IHDR(header chunk)</strong></p><p>包含有PNG文件中存储的图像数据的基本信息，并要作为<strong>第一个数据块</strong>出现在PNG数据流中，而且一个PNG数据流中只能有一个文件头数据块。它用13个字节按照顺序来表示图像数据的基本信息：</p><table><thead><tr><th>域的名称</th><th>长度</th><th>说明</th></tr></thead><tbody><tr><td>Width</td><td>4 bytes</td><td>图片宽度，以像素为单位</td></tr><tr><td>Height</td><td>4 bytes</td><td>图片高度，以像素为单位</td></tr><tr><td>Bit Depth</td><td>1 byte</td><td>图像深度</td></tr><tr><td>Color Type</td><td>1 byte</td><td>颜色类型</td></tr><tr><td>Compression Method</td><td>1 byte</td><td>压缩算法</td></tr><tr><td>Filter Method</td><td>1 byte</td><td>滤波方法</td></tr><tr><td>Interlace Method</td><td>1 byte</td><td>扫描方法</td></tr></tbody></table><ul><li><code>Bit Depth</code>代表图像深度。索引彩色图像：1，2，4或8；灰度图像：1，2，4，8或16；真彩色图像：8或16；</li><li><code>Color Type</code>（颜色类型）PNG 图片一共有 5 种色彩类型，<code>0</code> 代表灰度颜色，<code>2</code> 代表用 RGB 表示颜色，即 <code>(R, G, B)</code>，<code>3</code> 代表用色板表示颜色，<code>4</code> 代表灰度和透明度来表示颜色，<code>6</code> 代表用 RGB 和透明度表示颜色，即 <code>(R, G, B, A)</code>。色板的色彩类型里，每个像素是由 1 个色彩通道表示的。</li><li><code>Co2,mpression Method</code> 代表了压缩算法。目前只支持 <code>0</code>，表示 <strong>deflate&#x2F;inflate</strong>。（<strong>Deflate&#x2F;inflate</strong> 是一种结合了 LZ77 和霍夫曼编码的无损压缩算法，被广泛运用于 <code>7-zip</code>，<code>zlib</code>，<code>gzip</code> 等场景。）</li><li><code>Filter Method</code> 代表在压缩前应用的过滤函数类型，目前只支持 <code>0</code>。过滤函数类型 <code>0</code> 里面包括了 5 种过滤函数。</li><li><code>Interlace Method</code> 代表图片数据是否经过交错，<code>0</code> 代表非隔行扫描，<code>1</code> 代表 Adam7。</li></ul><p>2、<strong>调色板数据块PLTE(palette chunk)</strong></p><p>它包含有与索引彩色图像(indexed-color image)相关的彩色变换数据，它仅与索引彩色图像有关，如果存在，要放在图像数据块(image data chunk)之前。真彩色的PNG数据流也可以有调色板数据块，目的是便于非真彩色显示程序用它来量化图像数据，从而显示该图像。结构如下：</p><table><thead><tr><th align="center">颜色</th><th align="center">字节</th><th align="center">意义</th></tr></thead><tbody><tr><td align="center">Red</td><td align="center">1 byte</td><td align="center">0 &#x3D; 黑色, 255 &#x3D; 红</td></tr><tr><td align="center">Green</td><td align="center">1 byte</td><td align="center">0 &#x3D; 黑色, 255 &#x3D; 绿色</td></tr><tr><td align="center">Blue</td><td align="center">1 byte</td><td align="center">0 &#x3D; 黑色, 255 &#x3D; 蓝色</td></tr></tbody></table><p>PLTE数据块是定义图像的palette信息，PLTE可以包含1~256个palette信息，每一个palette信息由3个字节组成，因此palette数据块所包含的最大字节数为768，palette的长度应该是3的倍数，否则，这将是一个非法的palette。</p><p>对于索引图像，palette信息是必须的，palette的颜色索引从0开始编号，然后是1、2……，palette的颜色数不能超过色深中规定的颜色数（如图像色深为4的时候，调色板中的颜色数不可以超过2^4&#x3D;16），否则，这将导致PNG图像不合法。</p><p>3、<strong>图像数据块IDAT(image data chunk)</strong></p><p>存储实际的图片数据，一个图片数据流可能包含多个连续顺序的 IDAT 数据块。创建 IDAT 数据块的步骤：</p><ol><li>将扫描获得的图片信息及其大小储存，具体的图片信息和大小规则在 IHDR 中保存</li><li>采取 IHDR 指定的过滤方法，对图像数据进行过滤。目前只有定义了method 0</li><li>采取 IHDR 指定的压缩方法，对过滤的数据进行压缩</li></ol><p>如果想要读取图片信息，将上面三个步骤逆序执行即可。</p><p>4、<strong>图像结束数据IEND(image trailer chunk)</strong></p><p>它用来标记PNG文件或者数据流已经结束，并且必须要放在文件的尾部。</p><p>如果我们仔细观察PNG文件，我们会发现，文件的结尾12个字符看起来总应该是这样的：</p><p><code>00 00 00 00 49 45 4E 44 AE 42 60 82</code></p><p>不难明白，由于数据块结构的定义，IEND数据块的长度总是0（<code>00 00 00 00</code>，除非人为加入信息），数据标识总是IEND（<code>49 45 4E 44</code>），因此，CRC码也总是<code>AE 42 60 82</code>。</p><blockquote><p>表示数据块开始的IHDR必须放在最前面， 表示PNG文件结束的IEND数据块放在最后面，其他数据块的存放顺序没有限制。</p></blockquote><h4 id="辅助数据块"><a href="#辅助数据块" class="headerlink" title="辅助数据块"></a>辅助数据块</h4><p><del>（cv查表）</del></p><table><thead><tr><th>符号</th><th>说明</th></tr></thead><tbody><tr><td>bKGD</td><td>指定默认的背景颜色</td></tr><tr><td>cHRM</td><td>校准色度</td></tr><tr><td>dSIG</td><td>数字签名</td></tr><tr><td>eXIf</td><td><a href="https://en.wikipedia.org/wiki/Exif">Exif</a> metadata 信息</td></tr><tr><td>gAMA</td><td>指定亮度的伽马校准值2,</td></tr><tr><td>hIST</td><td>色彩直方图，估算颜色的使用频率</td></tr><tr><td>iCCP</td><td><a href="https://en.wikipedia.org/wiki/ICC_color_profile">ICC color profile</a></td></tr><tr><td>iTXt</td><td>以键值对方式存储可能的压缩文本和翻译信息</td></tr><tr><td>pHYs</td><td>指定像素大小或图片比例</td></tr><tr><td>sBIT</td><td>除了指定位深度（8，16 等等）外，保存原始数据以便恢复</td></tr><tr><td>sPLT</td><td>提出建议使用的调色板，可能有多个</td></tr><tr><td>sRGB</td><td>指明是否使用<a href="https://en.wikipedia.org/wiki/SRGB_color_space">sRGB color space</a></td></tr><tr><td>sTER</td><td>储存立体视图（<a href="https://en.wikipedia.org/wiki/Stereoscopic">stereoscopic</a>）的相关信息，</td></tr><tr><td>tEXt</td><td>保存作者等键值对的文本信息</td></tr><tr><td>tIME</td><td>上次修改时间</td></tr><tr><td>tRNS</td><td>保存透明信息，分为不透明、全透明、Alpha</td></tr><tr><td>zTXt</td><td>保存压缩后的文本信息以及对应的压缩方式标识</td></tr></tbody></table><h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><p>PNG的压缩分为两个步骤：预解析（过滤）和压缩</p><h4 id="隔行扫描"><a href="#隔行扫描" class="headerlink" title="隔行扫描"></a>隔行扫描</h4><p>隔行扫描（Interlacing），也称交错扫描（interleaving），是一种位图编码的方式，编码时不严格按照相邻行进行。当连接速度比较慢时，采用隔行扫描的图片可以渐进地进行显示，即先显示较为模糊的版本，然后逐渐变清晰。如图：</p><p><img src="https://s2.loli.net/2022/03/20/B9WKPpsaQCYm5ET.gif" class="lazyload" data-srcset="https://s2.loli.net/2022/03/20/B9WKPpsaQCYm5ET.gif" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>我们常用的 GIF、PNG、JPEG 都采用了隔行扫描的方式，其中 PNG 采取的是二维、七通道的<a href="https://en.wikipedia.org/wiki/Adam7_algorithm">Adam7</a>，二维表示扫描支持竖直和水平方向，7代表一张图片会被拆分为7个子图片。</p><p><img src="https://s2.loli.net/2022/03/20/Bbh9eNTzyOmtdsv.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/20/Bbh9eNTzyOmtdsv.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="20190819143548.png"></p><p>和 GIF 采取的一维、四通道算法相比，PNG 在网速相同的情况下，尤其是网速较慢时，能够更快地显示出图片的基本外貌。</p><h4 id="Filter（过滤）"><a href="#Filter（过滤）" class="headerlink" title="Filter（过滤）"></a>Filter（过滤）</h4><p>PNG编码使用差分对原始像素数据进行Filter，该过程无任何压缩损失，并且完全可逆。对图像来说，存储残差所需的比特远远小于实际图像所需，这也是差分编码的收益来源</p><ul><li><strong>差分编码</strong></li></ul><p>[2,3,4,5,6,7,8]会变成[2,1,1,1,1,1,1]，其中 [2, 3-2&#x3D;1, 4-3&#x3D;1, 5-4&#x3D;1, 6-5&#x3D;1, 7-6&#x3D;1, 8-7&#x3D;1]</p><p>如果数据是线性相关的(也就是说，值与前一个值有一些很小的差异)，那么最终会将数据集的值转换为大量重复的小值，这些小值更容易被压缩。 PNG文件格式使用称为“filtering”的delta编码格式。基本上，对于每一个像素扫描线，当前像素都是按照与左边像素、上面像素和上面左侧像素的某种关系进行编码的。</p><p>对于不同的内容，须使用不同的Filter类型来提升压缩收益，<strong>过滤的重点</strong>是将大多数转换后的字节将聚集在零附近，从而为压缩引擎提供更小、更可预测的字节值范围来处理。</p><p>为了便于描述，规定了<code>相邻像素</code>相对<code>当前像素</code>的方位：左（A）、上（B）、左上（C）。</p><table><thead><tr><th>C</th><th>B</th></tr></thead><tbody><tr><td>A</td><td>X</td></tr></tbody></table><p>上文提到的 5 种过滤函数为：</p><table><thead><tr><th>过滤类型</th><th>存储值(O)&#x3D;实际值(X)-预测值(R)</th></tr></thead><tbody><tr><td>0</td><td>O &#x3D; X</td></tr><tr><td>1</td><td>O &#x3D; X - A</td></tr><tr><td>2</td><td>O &#x3D; X - B</td></tr><tr><td>3</td><td>O &#x3D; X - (A+B)&#x2F;2</td></tr><tr><td>4</td><td>Peath(A,B,C)</td></tr></tbody></table><p>Peath(A,B,C): Paeth预测器(A,B,C的线性函数)</p><p>Peath具体计算为 </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">base = <span class="title class_">AboveRow</span>[j] + <span class="title class_">LeftCol</span>[i] – <span class="title class_">AboveRow</span>[-<span class="number">1</span>]</span><br><span class="line">pLeft = <span class="title class_">Abs</span>(base – <span class="title class_">LeftCol</span>[i])           <span class="comment">// abs(A-C)</span></span><br><span class="line">pTop = <span class="title class_">Abs</span>(base – <span class="title class_">AboveRow</span>[j])     <span class="comment">// abs(L-C)</span></span><br><span class="line">pTopLeft = <span class="title class_">Abs</span>(base – <span class="title class_">AboveRow</span>[-<span class="number">1</span>])    <span class="comment">// abs(A+L-2*C)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (pLeft &lt;= pTop &amp;&amp; pLeft &lt;= pTopLeft)</span><br><span class="line">    pred[i][j] = <span class="title class_">LeftCol</span>[i]                   <span class="comment">// 使用左边参考像素值</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(pTop &lt;= pTopLeft)</span><br><span class="line">    pred[i][j] = <span class="title class_">AboveRow</span>[j]             <span class="comment">// 使用上方参考像素值</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    pred[i][j] = <span class="title class_">AboveRow</span>[-<span class="number">1</span>]           <span class="comment">// 若上方与左边均判断为不存在边界的情况，则使用左上方的值</span></span><br></pre></td></tr></table></figure><blockquote><p>选择合适的过滤器？</p><p>没有。每一行进行增量测试压缩，保存最小的结果，然后对下一行重复，对于20行的图像相当于对整个图像进行五次过滤和压缩。对于将被传输和解码多次的图像来说，这可能是一个合理的权衡。</p><p>过滤器也很少用于低位深度（灰度）图像，尽管在极少数情况下将此类图像提升到 8 位然后过滤是有效的。但是，一般来说，过滤器类型 None 是最好的。</p></blockquote><blockquote><p>一些接近最优的经验法则：比如对调色板图像以及低于8位的灰度图像不使用过滤器；对于其他的图像，选择最小化绝对差和的滤波器；不是使用256模除(%)，而是使用标准的带符号数学，然后获取abs值，并将它们全部添加到给定行中，然后比较其他筛选器类型的和，选择给出最小和的过滤器。</p></blockquote><h4 id="Deflate"><a href="#Deflate" class="headerlink" title="Deflate"></a>Deflate</h4><p>正式的压缩阶段使用 <a href="https://en.wikipedia.org/wiki/DEFLATE">Deflate</a> 进行压缩，它由 Huffman 编码 和 LZ77 压缩构成。Deflate是一种压缩数据流的算法，任何需要流式压缩的地方都可以用（<del><em>但我并没有去了解它具体的实现，所以就略过吧</em></del>）</p><h3 id="解码"><a href="#解码" class="headerlink" title="解码"></a>解码</h3><p>（图片和数据均来自<a href="https://vivaxyblog.github.io/2019/12/07/decode-a-png-image-with-javascript-cn.html">一步一步解码 PNG 图片</a>）</p><p><img src="https://s2.loli.net/2022/03/20/6yXKjOHpoZGJfrz.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/20/6yXKjOHpoZGJfrz.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="示例图片"></p><p>👆 这是一张我们接下去要解码的图片，但它太小了，放大了展示给大家看下。👇</p><p><img src="https://s2.loli.net/2022/03/20/zG9QE6Za1AUiDVu.png" class="lazyload" data-srcset="https://s2.loli.net/2022/03/20/zG9QE6Za1AUiDVu.png" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" alt="img"></p><p>二进制数据如下</p><table><thead><tr><th></th><th>0 ~ 3</th><th>4 ~ 7</th><th>8 ~ 11</th><th>12 ~ 15</th></tr></thead><tbody><tr><td>0 ~ 15</td><td><code>137, 80, 78, 71</code></td><td><code>13, 10, 26, 10</code></td><td><code>0, 0, 0, 13</code></td><td><code>73, 72, 68, 82</code></td></tr><tr><td>16 ~ 31</td><td><code>0, 0, 0, 2</code></td><td><code>0, 0, 0, 2</code></td><td><code>2, 3, 0, 0</code></td><td><code>0, 15, 216, 229</code></td></tr><tr><td>32 ~ 47</td><td><code>183, 0, 0, 0</code></td><td><code>1, 115, 82, 71</code></td><td><code>66, 1, 217, 201</code></td><td><code>44, 127, 0, 0</code></td></tr><tr><td>48 ~ 63</td><td><code>0, 9, 112, 72</code></td><td><code>89, 115, 0, 0</code></td><td><code>11, 19, 0, 0</code></td><td><code>11, 19, 1, 0</code></td></tr><tr><td>64 ~ 79</td><td><code>154, 156, 24, 0</code></td><td><code>0, 0, 12, 80</code></td><td><code>76, 84, 69, 255</code></td><td><code>0, 0, 0, 255</code></td></tr><tr><td>80 ~ 95</td><td><code>0, 0, 0, 255</code></td><td><code>255, 255, 255, 251</code></td><td><code>0, 96, 246, 0</code></td><td><code>0, 0, 4, 116</code></td></tr><tr><td>96 ~ 111</td><td><code>82, 78, 83, 255</code></td><td><code>255, 255, 127, 128</code></td><td><code>144, 197, 89, 0</code></td><td><code>0, 0, 12, 73</code></td></tr><tr><td>112 ~ 127</td><td><code>68, 65, 84, 120</code></td><td><code>156, 99, 16, 96</code></td><td><code>216, 0, 0, 0</code></td><td><code>228, 0, 193, 39</code></td></tr><tr><td>128 ~ 143</td><td><code>168, 232, 87, 0</code></td><td><code>0, 0, 0, 73</code></td><td><code>69, 78, 68, 174</code></td><td><code>66, 96, 130</code></td></tr></tbody></table><p>每个表格的单元格内有 4 字节数据，每个字节由 8 位组成，1 位代表的是 <code>0</code> 或者 <code>1</code> 的一个数字。</p><ul><li><strong>签名部分</strong></li></ul><table><thead><tr><th>0 ~ 3</th><th>4 ~ 7</th></tr></thead><tbody><tr><td><code>137, 80, 78, 71</code></td><td><code>13, 10, 26, 10</code></td></tr><tr><td><code>0x89, 0x50, 0x4e, 0x47</code></td><td><code>0x0d, 0x0a, 0x1a, 0x0a</code></td></tr></tbody></table><p>这张图片的前 8 个字节满足PNG签名的要求。</p><ul><li><strong>文件头数据块部分</strong></li></ul><table><thead><tr><th>8 ~ 11</th><th>12 ~ 15</th></tr></thead><tbody><tr><td><code>0, 0, 0, 13</code></td><td><code>73, 72, 68, 82</code></td></tr><tr><td>长度</td><td>类型</td></tr><tr><td><code>13</code></td><td><code>IHDR</code></td></tr></tbody></table><table><thead><tr><th>16 ~ 19</th><th>20 ~ 23</th><th>24 ~ 27</th><th>28</th></tr></thead><tbody><tr><td><code>0, 0, 0, 2</code></td><td><code>0, 0, 0, 2</code></td><td><code>2, 3, 0, 0</code></td><td><code>0</code></td></tr><tr><td><code>width</code></td><td><code>height</code></td><td><code>depth</code>, <code>colorType</code>, <code>compression</code>, <code>filter</code></td><td><code>interlace</code></td></tr><tr><td><code>2</code></td><td><code>2</code></td><td><code>2, 3, 0, 0</code></td><td><code>0</code></td></tr></tbody></table><table><thead><tr><th>29 ~ 32</th></tr></thead><tbody><tr><td><code>15, 216, 229, 183</code></td></tr><tr><td>CRC32 校验和</td></tr></tbody></table><ul><li><strong>PLTE部分</strong></li></ul><table><thead><tr><th>75 ~ 78</th><th>79 ~ 82</th><th>83 ~ 86</th></tr></thead><tbody><tr><td><code>255, 0, 0, 0</code></td><td><code>255, 0, 0, 0</code></td><td><code>255, 255, 255, 255</code></td></tr></tbody></table><p>色板中包含的数据是 RGB 数据，以 <code>R, G, B</code> 的形式保存，这里一共 12 字节，表示了 4 个色块。得到的色板信息如下：</p><p><strong>色板</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[255, 0, 0], [0, 255, 0], [0, 0, 255], [255, 255, 255]]</span><br></pre></td></tr></table></figure><ul><li><strong>tRNS部分</strong></li></ul><table><thead><tr><th>99 ~ 102</th></tr></thead><tbody><tr><td><code>255, 255, 255, 127</code></td></tr></tbody></table><p>这个数据块为色板提供透明信息，每个字节表示一个色块的透明信息。与色板组合后的色板如下：</p><p><strong>色板</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[255, 0, 0, 255], [0, 255, 0, 255], [0, 0, 255, 255], [255, 255, 255, 127]]</span><br></pre></td></tr></table></figure><ul><li><strong>IDAT部分</strong></li></ul><p>我们重点关注图像数据块的解码部分。</p><table><thead><tr><th>107 ~ 110</th><th>111 ~ 114</th></tr></thead><tbody><tr><td><code>0, 0, 0, 12</code></td><td><code>73, 68, 65, 84</code></td></tr><tr><td>长度</td><td>类型</td></tr><tr><td><code>12</code></td><td><code>IDAT</code></td></tr></tbody></table><p>声明 12 字节的 <code>IDAT</code>像素数据</p><table><thead><tr><th>115 ~ 118</th><th>119 ~ 122</th><th>123 ~ 126</th></tr></thead><tbody><tr><td><code>120, 156, 99, 16</code></td><td><code>96, 216, 0, 0</code></td><td><code>0, 228, 0, 193</code></td></tr></tbody></table><p>所有行的像素数据会经过 deflate 压缩算法压缩。所以，需要对这里的像素数据解压，这里直接使用了 <code>zlib.inflate()</code> 函数。</p><p>解压出来的像素数据是 Uint8Array：<code>0, 16, 0, 176</code>。</p><p><strong>扫描线 Scanline</strong> </p><p>一根扫描线包含图片一行像素的数据。我们知道这张图片的高度是 2，也就是像素数据中有 2 行扫描线。</p><p>一根扫描线由 1 字节的过滤函数标记和像素信息组成。像素信息一个接一个地排列，中间没有多余的空位。如果扫描线长度不足以填满字节的位数，最后几位会被补齐。一根扫描线的结构如下：</p><table><thead><tr><th>过滤函数</th><th>像素…[补齐…]</th></tr></thead><tbody><tr><td><code>8 位</code></td><td><code>每像素位数</code> * <code>每行像素数</code> + <code>补齐</code></td></tr></tbody></table><p><strong>色彩类型 - 色彩通道 - 通道深度 - 每像素位数</strong></p><table><thead><tr><th>色彩类型</th><th>色彩</th><th>每像素通道数</th><th>通道深度</th><th>每像素位数</th></tr></thead><tbody><tr><td><code>0</code></td><td>灰度</td><td>1</td><td>1, 2, 4, 8, 16</td><td>1, 2, 4, 8, 16</td></tr><tr><td><code>2</code></td><td>真彩色（RGB）</td><td>3</td><td>8, 16</td><td>24, 48</td></tr><tr><td><code>3</code></td><td>色板</td><td>1</td><td>1, 2, 4, 8</td><td>1, 2, 4, 8</td></tr><tr><td><code>4</code></td><td>灰度和透明度</td><td>2</td><td>8, 16</td><td>16, 32</td></tr><tr><td><code>6</code></td><td>色彩色和透明度（RGBA）</td><td>4</td><td>8, 16</td><td>32, 64</td></tr></tbody></table><p>这张图片的色彩类型是 <code>3</code>，所以每个像素包含 <code>1</code> 个色彩通道。又因为图片的通道深度是 <code>2</code>，所以我们知道每个像素是用 <code>2</code> 位来表示的。</p><p><strong>解码扫描线</strong></p><table><thead><tr><th>行</th><th>过滤函数</th><th>像素…[补齐…]</th></tr></thead><tbody><tr><td></td><td><code>8 位</code></td><td><code>每像素 2 位 * 2 像素</code> + <code>4 位补齐</code> &#x3D; <code>8 位</code></td></tr><tr><td><code>0</code></td><td><code>0</code></td><td><code>00010000</code> (<code>16</code>)</td></tr><tr><td><code>1</code></td><td><code>0</code></td><td><code>10110000</code> (<code>176</code>)</td></tr></tbody></table><p>这张图片里面的过滤函数 <code>0</code> 表示这张图数据未经过滤。所以我们只要保留原始数据就行了。</p><p><strong>扫描线像素</strong></p><table><thead><tr><th>行</th><th>第 1 列</th><th>第 2 列</th><th>补齐…</th></tr></thead><tbody><tr><td><code>0</code></td><td><code>00</code></td><td><code>01</code></td><td><code>0000</code></td></tr><tr><td><code>1</code></td><td><code>10</code></td><td><code>11</code></td><td><code>0000</code></td></tr></tbody></table><p>这里每个像素中的数据表示了这个像素的颜色在色板中的索引。根据色板，我们可以还原出图片的像素信息：<code>[[255, 0, 0, 255], [0, 255, 0, 255], [0, 0, 255, 255], [255, 255, 255, 127]]</code>。</p><p><strong>图片像素</strong></p><table><thead><tr><th>行\列</th><th><code>0</code></th><th><code>1</code></th></tr></thead><tbody><tr><td><code>0</code></td><td><code>(255, 0, 0, 255)</code></td><td><code>(0, 255, 0, 255)</code></td></tr><tr><td><code>1</code></td><td><code>(0, 0, 255, 255)</code></td><td><code>(255, 255, 255, 127)</code></td></tr></tbody></table><p>最后可以得到这样一个PNG图片信息：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">imageData = <span class="punctuation">&#123;</span></span><br><span class="line">  width<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  height<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  data<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">255</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">255</span><span class="punctuation">,</span> <span class="number">127</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span>;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>PNG (Portable Network Graphics) Specification <a href="http://www.libpng.org/pub/png/spec/1.2/PNG-Contents.html">http://www.libpng.org/pub/png/spec/1.2/PNG-Contents.html</a></p><p>PNG文件格式 <a href="https://rimson.top/png-format/">https://rimson.top/png-format/</a></p><p>PNG文件格式详解 <a href="https://blog.mythsman.com/post/5d2d62b4a2005d74040ef7eb/">https://blog.mythsman.com/post/5d2d62b4a2005d74040ef7eb/</a></p><p>Portable Network Graphics (PNG) Specification (Second Edition) <a href="https://www.w3.org/TR/PNG/">https://www.w3.org/TR/PNG/</a></p><p>一步一步解码 PNG 图片 <a href="https://vivaxyblog.github.io/2019/12/07/decode-a-png-image-with-javascript-cn.html">https://vivaxyblog.github.io/2019/12/07/decode-a-png-image-with-javascript-cn.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;图片文件结构与PNG编码&quot;&gt;&lt;a href=&quot;#图片文件结构与PNG编码&quot; class=&quot;headerlink&quot; title=&quot;图片文件结构与PNG编码&quot;&gt;&lt;/a&gt;图片文件结构与PNG编码&lt;/h1&gt;&lt;h2 id=&quot;图像存储&quot;&gt;&lt;a href=&quot;#图像存储&quot; cla</summary>
      
    
    
    
    <category term="未分类" scheme="https://blog.ryaoknw.site/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/"/>
    
    
  </entry>
  
</feed>
